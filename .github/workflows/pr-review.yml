# Claude ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã® on ã‚’ workflow_dispatch ã«å¤‰æ›´ã—ã¦ãã ã•ã„
# on: workflow_dispatch

name: PR Review by Claude

on:
  pull_request:
    branches:
      - main
      - master
    types:
      - opened
      - synchronize
      - reopened

env:
  MAX_DIFF_SIZE: 50000  # å·®åˆ†ã‚µã‚¤ã‚ºã®ä¸Šé™ï¼ˆbytesï¼‰ã€‚å¤‰æ›´å¯èƒ½

jobs:
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å·®åˆ†ã‚’å–å¾—
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)

          # å·®åˆ†ãŒå¤§ãã™ãã‚‹å ´åˆã¯è¦ç´„
          DIFF_SIZE=$(echo "$DIFF" | wc -c)
          MAX_DIFF=${MAX_DIFF_SIZE:-50000}
          if [ "$DIFF_SIZE" -gt "$MAX_DIFF" ]; then
            echo "âš ï¸ å·®åˆ†ãŒå¤§ãã™ãã¾ã™ï¼ˆ${DIFF_SIZE} bytes > ${MAX_DIFF} bytesï¼‰"
            echo "size_exceeded=true" >> $GITHUB_OUTPUT
            # ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã¨çµ±è¨ˆæƒ…å ±ã«å¤‰æ›´
            DIFF=$(git diff --stat origin/${{ github.base_ref }}...HEAD)
          else
            echo "size_exceeded=false" >> $GITHUB_OUTPUT
          fi

          # å·®åˆ†ã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜ï¼ˆGitHub Actions ã®åˆ¶ç´„å¯¾å¿œï¼‰
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get changed files
        id: files
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | head -20)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Review with Claude
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # API ã‚­ãƒ¼ã®å­˜åœ¨ç¢ºèª
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "âŒ ANTHROPIC_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "review=âš ï¸ Claude ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€GitHub Secrets ã« ANTHROPIC_API_KEY ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚\n\nè©³ç´°: .github/CLAUDE_REVIEW_SETUP.md" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ jq ã§å®‰å…¨ã«æ§‹ç¯‰ï¼ˆã‚·ã‚§ãƒ«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼‰
          echo "ğŸ¤– Claude API ã‚’å‘¼ã³å‡ºã—ä¸­..."
          PROMPT=$(jq -n \
            --arg title "${{ github.event.pull_request.title }}" \
            --arg body "${{ github.event.pull_request.body }}" \
            --arg head "${{ github.head_ref }}" \
            --arg base "${{ github.base_ref }}" \
            --arg files "${{ steps.files.outputs.files }}" \
            --arg diff "${{ steps.diff.outputs.diff }}" \
            '
            "ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚\n\n" +
            "## ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±\n" +
            "- ã‚¿ã‚¤ãƒˆãƒ«: \($title)\n" +
            "- èª¬æ˜: \($body)\n" +
            "- ãƒ–ãƒ©ãƒ³ãƒ: \($head) â†’ \($base)\n\n" +
            "## å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«\n```\n\($files)\n```\n\n" +
            "## å·®åˆ†\n```diff\n\($diff)\n```\n\n" +
            "## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹\n" +
            "ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼š\n\n" +
            "1. **ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„**: PSR-12ã€TypeScript/React ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹\n" +
            "2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSã€CSRFã€èªè¨¼ãƒ»èªå¯\n" +
            "3. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: DDD åŸå‰‡ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢ã€ä¾å­˜é–¢ä¿‚\n" +
            "4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: N+1 å•é¡Œã€ä¸è¦ãªã‚¯ã‚¨ãƒªã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯\n" +
            "5. **ãƒ†ã‚¹ãƒˆ**: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹\n" +
            "6. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: ã‚³ãƒ¡ãƒ³ãƒˆã€READMEã€å‹å®šç¾©\n\n" +
            "## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ\n" +
            "ä»¥ä¸‹ã®å½¢å¼ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š\n\n" +
            "### ğŸ“Š ç·åˆè©•ä¾¡\n" +
            "- æ‰¿èªæ¨å¥¨åº¦: âœ… æ‰¿èªæ¨å¥¨ / âš ï¸ ä¿®æ­£ææ¡ˆã‚ã‚Š / âŒ è¦ä¿®æ­£\n\n" +
            "### âœ… è‰¯ã„ç‚¹\n" +
            "- [å…·ä½“çš„ãªè‰¯ã„ç‚¹]\n\n" +
            "### âš ï¸ æ”¹å–„ææ¡ˆ\n" +
            "- [ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·] æ”¹å–„ææ¡ˆ\n\n" +
            "### âŒ é‡å¤§ãªå•é¡Œ\n" +
            "- [ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·] å•é¡Œç‚¹\n\n" +
            "### ğŸ“ ãã®ä»–\n" +
            "- [ãã®ä»–ã®æ°—ã¥ã]"
          ')

          # Claude API ã‚’å‘¼ã³å‡ºã— (Claude 4.5 Sonnet - 2026å¹´1æœˆæ™‚ç‚¹ã®æœ€æ–°)
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "{
              \"model\": \"claude-sonnet-4-5-20250929\",
              \"max_tokens\": 4096,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": $PROMPT
              }]
            }")

          # ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨ä½“ã¯å‡ºåŠ›ã—ãªã„ - API ã‚­ãƒ¼éœ²å‡ºé˜²æ­¢ï¼‰
          ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
          if [ -n "$ERROR" ]; then
            echo "âŒ Claude API ã‚¨ãƒ©ãƒ¼: $ERROR"
            echo "review=âŒ Claude API ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: $ERROR" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’æŠ½å‡º
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')

          if [ -z "$REVIEW" ]; then
            echo "âŒ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãŒç©ºã§ã™"
            echo "review=âŒ Claude ã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—æˆåŠŸ"

          # çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œã‚’å›é¿ï¼‰
          echo "$REVIEW" > review.txt

      - name: Comment on large diff
        if: steps.diff.outputs.size_exceeded == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âš ï¸ **å·®åˆ†ãŒå¤§ãã™ãã‚‹ãŸã‚ã€Claude ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ**\n\nè¤‡æ•°ã® PR ã«åˆ†å‰²ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚\n\nè©³ç´°: Actions ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„: ${context.payload.repository.html_url}/actions/runs/${context.runId}`
            });

      - name: Post review comment
        if: always() && steps.diff.outputs.size_exceeded != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œã‚’å›é¿ï¼‰
            let review = '';
            try {
              review = fs.readFileSync('review.txt', 'utf8');
            } catch (error) {
              console.log('âš ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ¤– Claude ã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\nâš ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\nActions ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„: ${context.payload.repository.html_url}/actions/runs/${context.runId}`
              });
              return;
            }

            if (!review || review.trim() === '') {
              console.log('âš ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœãŒç©ºã®ãŸã‚ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ¤– Claude ã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\nâš ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\nActions ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„: ${context.payload.repository.html_url}/actions/runs/${context.runId}`
              });
              return;
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– Claude ã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n${review}`
            });
