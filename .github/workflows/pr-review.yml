name: PR Review by Claude

on:
  pull_request:
    branches:
      - main
      - master
    types:
      - opened
      - synchronize
      - reopened

jobs:
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å·®åˆ†ã‚’å–å¾—
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD)

          # å·®åˆ†ãŒå¤§ãã™ãã‚‹å ´åˆã¯è¦ç´„
          DIFF_SIZE=$(echo "$DIFF" | wc -c)
          if [ "$DIFF_SIZE" -gt 50000 ]; then
            echo "å·®åˆ†ãŒå¤§ãã™ãã¾ã™ï¼ˆ${DIFF_SIZE} bytesï¼‰ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã®ã¿ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚"
            DIFF=$(git diff --name-status origin/${{ github.base_ref }}...HEAD)
          fi

          # å·®åˆ†ã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜ï¼ˆGitHub Actions ã®åˆ¶ç´„å¯¾å¿œï¼‰
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get changed files
        id: files
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | head -20)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Review with Claude
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
          cat > prompt.txt << 'PROMPT_EOF'
          ã‚ãªãŸã¯ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

          ## ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±
          - ã‚¿ã‚¤ãƒˆãƒ«: ${{ github.event.pull_request.title }}
          - èª¬æ˜: ${{ github.event.pull_request.body }}
          - ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.head_ref }} â†’ ${{ github.base_ref }}

          ## å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
          ```
          ${{ steps.files.outputs.files }}
          ```

          ## å·®åˆ†
          ```diff
          ${{ steps.diff.outputs.diff }}
          ```

          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
          ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼š

          1. **ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„**: PSR-12ã€TypeScript/React ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
          2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSã€CSRFã€èªè¨¼ãƒ»èªå¯
          3. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: DDD åŸå‰‡ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢ã€ä¾å­˜é–¢ä¿‚
          4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: N+1 å•é¡Œã€ä¸è¦ãªã‚¯ã‚¨ãƒªã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯
          5. **ãƒ†ã‚¹ãƒˆ**: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹
          6. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: ã‚³ãƒ¡ãƒ³ãƒˆã€READMEã€å‹å®šç¾©

          ## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          ä»¥ä¸‹ã®å½¢å¼ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

          ### ğŸ“Š ç·åˆè©•ä¾¡
          - æ‰¿èªæ¨å¥¨åº¦: âœ… æ‰¿èªæ¨å¥¨ / âš ï¸ ä¿®æ­£ææ¡ˆã‚ã‚Š / âŒ è¦ä¿®æ­£

          ### âœ… è‰¯ã„ç‚¹
          - [å…·ä½“çš„ãªè‰¯ã„ç‚¹]

          ### âš ï¸ æ”¹å–„ææ¡ˆ
          - [ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·] æ”¹å–„ææ¡ˆ

          ### âŒ é‡å¤§ãªå•é¡Œ
          - [ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·] å•é¡Œç‚¹

          ### ğŸ“ ãã®ä»–
          - [ãã®ä»–ã®æ°—ã¥ã]
          PROMPT_EOF

          # Claude API ã‚’å‘¼ã³å‡ºã—
          REVIEW=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "{
              \"model\": \"claude-3-5-sonnet-20241022\",
              \"max_tokens\": 4096,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": $(jq -Rs . < prompt.txt)
              }]
            }" | jq -r '.content[0].text')

          # çµæœã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = `${{ steps.claude.outputs.review }}`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– Claude ã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n${review}`
            });
