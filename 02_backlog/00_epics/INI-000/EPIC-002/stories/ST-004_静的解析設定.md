# ST-004: 静的解析（PHPStan/Larastan）の設定

最終更新: 2025-12-23

---

## ストーリー

**開発者として**、PHPStan/Larastan による静的解析を設定したい。
**なぜなら**、型エラーやバグを早期に発見し、コード品質を維持したいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-002: バックエンド初期設定](../epic.md) |
| ポイント | 2 |
| 優先度 | Must |
| ステータス | Draft |

---

## 受け入れ条件

1. [ ] phpstan.neon が作成されていること
2. [ ] `./vendor/bin/phpstan analyse` が実行できること
3. [ ] 解析対象ディレクトリが適切に設定されていること
4. [ ] ベースラインファイルが生成できること
5. [ ] composer scripts に analyse コマンドが追加されていること

---

## 技術仕様

### PHPStan 設定ファイル

```neon
# phpstan.neon

includes:
    - vendor/larastan/larastan/extension.neon

parameters:
    # 解析レベル（0-9, 段階的に上げる）
    level: 5

    # 解析対象
    paths:
        - app/

    # 除外パス
    excludePaths:
        - app/src/*/Infrastructure/EloquentModels/

    # Laravel 固有設定
    checkMissingIterableValueType: false
    checkGenericClassInNonGenericObjectType: false

    # 無視するエラー（必要に応じて追加）
    ignoreErrors:
        # - '#Call to an undefined method Illuminate\\Database\\Query\\Builder::#'
```

### Composer スクリプト

```json
{
    "scripts": {
        "analyse": "./vendor/bin/phpstan analyse",
        "analyse:baseline": "./vendor/bin/phpstan analyse --generate-baseline",
        "analyse:clear": "./vendor/bin/phpstan clear-result-cache"
    }
}
```

### 実行コマンド

```bash
# 静的解析の実行
composer analyse

# ベースライン生成（既存エラーを許容）
composer analyse:baseline

# キャッシュクリア
composer analyse:clear

# 詳細出力
./vendor/bin/phpstan analyse --verbose
```

### 推奨解析レベル

| レベル | 説明 | 推奨フェーズ |
|--------|------|------------|
| 0 | 基本的なエラーのみ | 初期導入時 |
| 5 | 型チェック有効化 | 開発中（推奨） |
| 8 | 厳格な型チェック | 安定期 |
| 9 | 最高レベル | 成熟期 |

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| PHPStan 設定ファイル | backend/phpstan.neon |
| ベースラインファイル | backend/phpstan-baseline.neon |
| 更新された composer.json | backend/composer.json |

---

## タスク

### Design Tasks（外部設計）

- [ ] 初期解析レベルの決定
- [ ] 除外パスの決定

### Spec Tasks（詳細設計）

- [ ] phpstan.neon の作成
- [ ] composer scripts の追加
- [ ] 初回解析の実行
- [ ] ベースライン生成（必要に応じて）

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-23 | 初版作成 |
