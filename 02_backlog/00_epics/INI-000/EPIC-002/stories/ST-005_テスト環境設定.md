# ST-005: テスト環境（Pest）の設定

最終更新: 2025-12-23

---

## ストーリー

**開発者として**、Pest テストフレームワークを設定したい。
**なぜなら**、シンプルで読みやすいテストコードを書き、品質を担保したいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-002: バックエンド初期設定](../epic.md) |
| ポイント | 2 |
| 優先度 | Must |
| ステータス | Draft |

---

## 受け入れ条件

1. [ ] `./vendor/bin/pest` が実行できること
2. [ ] tests/Pest.php が設定されていること
3. [ ] サンプルテストが成功すること
4. [ ] テストカバレッジレポートが生成できること
5. [ ] composer scripts に test コマンドが追加されていること

---

## 技術仕様

### Pest 設定ファイル

```php
<?php
// tests/Pest.php

uses(Tests\TestCase::class)->in('Feature');
uses(Tests\TestCase::class)->in('Unit');

/*
|--------------------------------------------------------------------------
| Expectations
|--------------------------------------------------------------------------
*/

expect()->extend('toBeOne', function () {
    return $this->toBe(1);
});

/*
|--------------------------------------------------------------------------
| Functions
|--------------------------------------------------------------------------
*/

function something()
{
    // 共通ヘルパー関数
}
```

### phpunit.xml 設定

```xml
<?xml version="1.0" encoding="UTF-8"?>
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
         bootstrap="vendor/autoload.php"
         colors="true"
>
    <testsuites>
        <testsuite name="Unit">
            <directory>tests/Unit</directory>
        </testsuite>
        <testsuite name="Feature">
            <directory>tests/Feature</directory>
        </testsuite>
    </testsuites>
    <source>
        <include>
            <directory>app</directory>
        </include>
        <exclude>
            <directory>app/src/*/Infrastructure/EloquentModels</directory>
        </exclude>
    </source>
    <php>
        <env name="APP_ENV" value="testing"/>
        <env name="BCRYPT_ROUNDS" value="4"/>
        <env name="CACHE_DRIVER" value="array"/>
        <env name="DB_CONNECTION" value="sqlite"/>
        <env name="DB_DATABASE" value=":memory:"/>
        <env name="MAIL_MAILER" value="array"/>
        <env name="QUEUE_CONNECTION" value="sync"/>
        <env name="SESSION_DRIVER" value="array"/>
    </php>
</phpunit>
```

### サンプルテスト

```php
<?php
// tests/Unit/ExampleTest.php

test('example', function () {
    expect(true)->toBeTrue();
});

test('数値の計算が正しく行われる', function () {
    $result = 1 + 1;
    expect($result)->toBe(2);
});
```

```php
<?php
// tests/Feature/ExampleTest.php

test('ウェルカムページにアクセスできる', function () {
    $response = $this->get('/');
    $response->assertStatus(200);
});

test('API ヘルスチェックが成功する', function () {
    $response = $this->getJson('/api/health');
    $response->assertStatus(200);
});
```

### Composer スクリプト

```json
{
    "scripts": {
        "test": "./vendor/bin/pest",
        "test:coverage": "./vendor/bin/pest --coverage",
        "test:parallel": "./vendor/bin/pest --parallel"
    }
}
```

### 実行コマンド

```bash
# テスト実行
composer test

# カバレッジ付きで実行
composer test:coverage

# 並列実行
composer test:parallel

# 特定のテストスイート
./vendor/bin/pest --testsuite=Unit
./vendor/bin/pest --testsuite=Feature

# フィルタリング
./vendor/bin/pest --filter="example"
```

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| Pest 設定 | backend/tests/Pest.php |
| PHPUnit 設定 | backend/phpunit.xml |
| サンプル Unit テスト | backend/tests/Unit/ExampleTest.php |
| サンプル Feature テスト | backend/tests/Feature/ExampleTest.php |
| 更新された composer.json | backend/composer.json |

---

## タスク

### Design Tasks（外部設計）

- [ ] テストディレクトリ構成の決定
- [ ] カバレッジ目標の設定

### Spec Tasks（詳細設計）

- [ ] Pest 初期化
- [ ] phpunit.xml の設定
- [ ] サンプルテストの作成
- [ ] composer scripts の追加
- [ ] テスト実行確認

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-23 | 初版作成 |
