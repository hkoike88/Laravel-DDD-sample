# ST-005: バックエンドテスト実行確認

最終更新: 2025-12-23

---

## ストーリー

**開発者として**、バックエンドのテストと静的解析が正常に実行できることを確認したい。
**なぜなら**、コード品質を維持するための仕組みが動作することを保証したいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-004: 開発環境動作確認](../epic.md) |
| ポイント | 1 |
| 優先度 | Must |
| ステータス | Draft |

---

## 受け入れ条件

1. [ ] `php artisan test` で全テストが成功すること
2. [ ] `./vendor/bin/pest` で Pest テストが実行できること
3. [ ] `./vendor/bin/phpstan analyse` でエラーがないこと
4. [ ] テストカバレッジレポートが生成できること
5. [ ] composer scripts が正常に動作すること

---

## 確認手順

### 1. コンテナに入る

```bash
docker compose exec backend bash
```

### 2. テスト実行

```bash
# Artisan 経由
php artisan test

# 期待される出力
#    PASS  Tests\Unit\ExampleTest
#    ✓ that true is true
#
#    PASS  Tests\Feature\ExampleTest
#    ✓ the application returns a successful response
#
#   Tests:    2 passed (2 assertions)
#   Duration: 0.50s

# Pest 直接実行
./vendor/bin/pest

# 並列実行
./vendor/bin/pest --parallel

# 特定のテストスイート
./vendor/bin/pest --testsuite=Unit
./vendor/bin/pest --testsuite=Feature
```

### 3. 静的解析実行

```bash
# PHPStan 実行
./vendor/bin/phpstan analyse

# 期待される出力
# [OK] No errors

# 詳細出力
./vendor/bin/phpstan analyse --verbose

# Composer script 経由
composer analyse
```

### 4. カバレッジレポート生成

```bash
# カバレッジ付きテスト実行
./vendor/bin/pest --coverage

# HTML レポート生成（Xdebug 必要）
./vendor/bin/pest --coverage-html=coverage

# 最小カバレッジ指定
./vendor/bin/pest --coverage --min=80
```

### 5. Composer Scripts 確認

```bash
# テスト
composer test

# 静的解析
composer analyse

# 全品質チェック（composer.json に定義されている場合）
composer check
```

---

## 確認チェックリスト

| 確認項目 | コマンド | 確認 |
|----------|---------|------|
| Artisan テスト | `php artisan test` | [ ] |
| Pest テスト | `./vendor/bin/pest` | [ ] |
| PHPStan | `./vendor/bin/phpstan analyse` | [ ] |
| カバレッジ | `./vendor/bin/pest --coverage` | [ ] |
| composer test | `composer test` | [ ] |
| composer analyse | `composer analyse` | [ ] |

---

## 期待される composer.json scripts

```json
{
    "scripts": {
        "test": "./vendor/bin/pest",
        "test:coverage": "./vendor/bin/pest --coverage",
        "test:parallel": "./vendor/bin/pest --parallel",
        "analyse": "./vendor/bin/phpstan analyse",
        "analyse:baseline": "./vendor/bin/phpstan analyse --generate-baseline",
        "check": [
            "@analyse",
            "@test"
        ]
    }
}
```

---

## トラブルシューティング

| 問題 | 原因 | 解決策 |
|------|------|--------|
| Test not found | autoload 未更新 | `composer dump-autoload` |
| PHPStan エラー多数 | レベル高すぎ | phpstan.neon の level を下げる |
| カバレッジ生成失敗 | Xdebug 未インストール | Dockerfile に追加 |
| メモリ不足 | 制限が低い | `php -d memory_limit=-1 vendor/bin/phpstan` |

---

## タスク

### Spec Tasks（詳細設計）

- [ ] php artisan test の実行確認
- [ ] Pest テストの実行確認
- [ ] PHPStan 静的解析の実行確認
- [ ] Composer scripts の動作確認
- [ ] エラー発生時の対応

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-23 | 初版作成 |
