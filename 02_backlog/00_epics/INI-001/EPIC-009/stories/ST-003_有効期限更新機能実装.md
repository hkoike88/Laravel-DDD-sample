# ST-003: 有効期限更新機能の実装

最終更新: 2025-12-26

---

## ストーリー

**図書館職員として**、利用者の有効期限を更新（延長）したい。
**なぜなら**、継続して図書貸出サービスを利用できるようにしたいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-009: 利用者アカウント編集機能](../epic.md) |
| ポイント | 2 |
| 優先度 | Must |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] `POST /api/patrons/{id}/renew` で有効期限を更新できること
2. [ ] 有効期限が更新日から1年間に設定されること
3. [ ] 更新日が記録されること
4. [ ] 利用者詳細画面に「有効期限更新」ボタンが表示されること
5. [ ] 更新成功時に「有効期限を更新しました」と表示されること
6. [ ] 無効化されたアカウントは更新できないこと（422）
7. [ ] 更新操作が監査ログに記録されること

---

## 技術仕様

### API エンドポイント

| メソッド | エンドポイント | 説明 | 認証 | 権限 |
|----------|---------------|------|------|------|
| POST | `/api/patrons/{id}/renew` | 有効期限更新 | 必須 | 職員 |

### リクエスト/レスポンス

#### POST /api/patrons/{id}/renew

**リクエスト:**
```
POST /api/patrons/01HV.../renew
（リクエストボディなし）
```

**成功レスポンス (200):**
```json
{
  "message": "有効期限を更新しました",
  "patron": {
    "id": "01HV...",
    "patronNumber": "P2025000001",
    "name": "山田 太郎",
    "expiresAt": "2026-12-26",
    "renewedAt": "2025-12-26T10:00:00+09:00"
  }
}
```

**無効化済みエラーレスポンス (422):**
```json
{
  "message": "無効化されたアカウントの有効期限は更新できません"
}
```

**Not Found レスポンス (404):**
```json
{
  "message": "利用者が見つかりません"
}
```

### UseCase 設計

```php
// RenewPatronHandler
class RenewPatronHandler
{
    public function handle(RenewPatronCommand $command): Patron
    {
        $patron = $this->patronRepository->findById(new PatronId($command->patronId));

        if ($patron === null) {
            throw new PatronNotFoundException('利用者が見つかりません');
        }

        if (!$patron->isActive()) {
            throw new InactivePatronException(
                '無効化されたアカウントの有効期限は更新できません'
            );
        }

        // 有効期限を更新（現在日から1年間）
        $patron->renew();
        $this->patronRepository->save($patron);

        // 監査ログ
        $this->logger->channel('audit')->info('有効期限を更新しました', [
            'patron_id' => $patron->id()->value(),
            'new_expires_at' => $patron->expiresAt()->format('Y-m-d'),
            'renewed_by' => $command->staffId,
        ]);

        return $patron;
    }
}
```

### Patron エンティティの renew メソッド

```php
// Patron.php
public function renew(): void
{
    $this->expiresAt = Carbon::now()->addYear();
    $this->renewedAt = Carbon::now();
}
```

### Controller 実装

```php
// PatronController
public function renew(string $id): JsonResponse
{
    $patron = $this->renewPatronHandler->handle(
        new RenewPatronCommand(
            patronId: $id,
            staffId: auth()->id(),
        )
    );

    return response()->json([
        'message' => '有効期限を更新しました',
        'patron' => new PatronResource($patron),
    ]);
}
```

### フロントエンド実装

```typescript
// useRenewPatron.ts
export const useRenewPatron = (id: string) => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: () => patronApi.renew(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['patron', id] });
      toast.success('有効期限を更新しました');
    },
    onError: (error: AxiosError<ApiError>) => {
      if (error.response?.status === 422) {
        toast.error(error.response.data.message);
      } else {
        toast.error('更新に失敗しました');
      }
    },
  });
};
```

### RenewButton コンポーネント

```tsx
// RenewButton.tsx
export const RenewButton: React.FC<{ patronId: string }> = ({ patronId }) => {
  const { mutate, isPending } = useRenewPatron(patronId);
  const [showConfirm, setShowConfirm] = useState(false);

  return (
    <>
      <Button
        variant="secondary"
        onClick={() => setShowConfirm(true)}
        loading={isPending}
      >
        有効期限更新
      </Button>
      <ConfirmDialog
        open={showConfirm}
        title="有効期限更新の確認"
        message="有効期限を本日から1年間に更新しますか？"
        onConfirm={() => {
          mutate();
          setShowConfirm(false);
        }}
        onCancel={() => setShowConfirm(false)}
      />
    </>
  );
};
```

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| RenewPatronCommand | backend/packages/Domain/Patron/Application/UseCases/Commands/RenewPatron/RenewPatronCommand.php |
| RenewPatronHandler | backend/packages/Domain/Patron/Application/UseCases/Commands/RenewPatron/RenewPatronHandler.php |
| InactivePatronException | backend/packages/Domain/Patron/Exceptions/InactivePatronException.php |
| PatronController（更新） | backend/app/Http/Controllers/Patron/PatronController.php |
| useRenewPatron | frontend/src/features/patron/hooks/useRenewPatron.ts |
| RenewButton | frontend/src/features/patron/components/RenewButton.tsx |
| Feature テスト | backend/tests/Feature/Patron/RenewPatronTest.php |

---

## タスク

### Design Tasks（外部設計）

- [ ] 更新確認ダイアログのデザイン確定
- [ ] ボタン配置の確認

### Spec Tasks（詳細設計）

- [ ] RenewPatronCommand 実装
- [ ] RenewPatronHandler 実装
- [ ] InactivePatronException 実装
- [ ] Patron エンティティに renew メソッド追加
- [ ] PatronController に renew メソッド追加
- [ ] ルーティング設定
- [ ] patronApi に renew メソッド追加
- [ ] useRenewPatron フック実装
- [ ] RenewButton コンポーネント実装
- [ ] 監査ログ出力実装
- [ ] Feature テスト作成

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
