# ST-004: 変更履歴機能の実装

最終更新: 2025-12-26

---

## ストーリー

**図書館職員として**、利用者情報の変更履歴を確認したい。
**なぜなら**、過去の変更内容を追跡し、監査に対応したいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-009: 利用者アカウント編集機能](../epic.md) |
| ポイント | 2 |
| 優先度 | Should |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] 利用者情報の更新時に変更履歴が記録されること
2. [ ] 変更前・変更後の値が記録されること
3. [ ] 変更者と変更日時が記録されること
4. [ ] 利用者詳細画面から変更履歴を確認できること
5. [ ] 変更履歴は5年間保存されること
6. [ ] 個人情報は復号化して表示されること

---

## 技術仕様

### API エンドポイント

| メソッド | エンドポイント | 説明 | 認証 | 権限 |
|----------|---------------|------|------|------|
| GET | `/api/patrons/{id}/histories` | 変更履歴取得 | 必須 | 職員 |

### リクエスト/レスポンス

#### GET /api/patrons/{id}/histories

**成功レスポンス (200):**
```json
{
  "histories": [
    {
      "id": "01HV...",
      "changedAt": "2025-12-26T10:00:00+09:00",
      "changedBy": {
        "id": "01HV...",
        "name": "職員 太郎"
      },
      "changes": [
        {
          "field": "address",
          "fieldLabel": "住所",
          "before": "〒100-0001 東京都...",
          "after": "〒123-4567 東京都○○区..."
        },
        {
          "field": "phoneNumber",
          "fieldLabel": "電話番号",
          "before": "03-1234-5678",
          "after": "090-1234-5678"
        }
      ]
    }
  ],
  "meta": {
    "total": 5,
    "page": 1,
    "perPage": 20
  }
}
```

### 変更履歴テーブル

```php
// database/migrations/xxxx_create_patron_histories_table.php
Schema::create('patron_histories', function (Blueprint $table) {
    $table->ulid('id')->primary();
    $table->foreignUlid('patron_id')->constrained()->onDelete('cascade');
    $table->json('before_data');  // 変更前のデータ（暗号化済み）
    $table->json('after_data');   // 変更後のデータ（暗号化済み）
    $table->foreignUlid('changed_by')->constrained('staffs');
    $table->timestamp('created_at');

    $table->index(['patron_id', 'created_at']);
});
```

### PatronHistory エンティティ

```php
// PatronHistory.php
final class PatronHistory
{
    private function __construct(
        private readonly PatronHistoryId $id,
        private readonly PatronId $patronId,
        private readonly array $beforeData,
        private readonly array $afterData,
        private readonly StaffId $changedBy,
        private readonly Carbon $createdAt,
    ) {}

    public static function create(
        PatronId $patronId,
        array $before,
        array $after,
        string $changedBy,
    ): self {
        return new self(
            id: new PatronHistoryId(),
            patronId: $patronId,
            beforeData: $before,
            afterData: $after,
            changedBy: new StaffId($changedBy),
            createdAt: Carbon::now(),
        );
    }

    public function changes(): array
    {
        $changes = [];
        $fields = [
            'name' => '氏名',
            'nameKana' => 'ふりがな',
            'birthDate' => '生年月日',
            'address' => '住所',
            'phoneNumber' => '電話番号',
            'patronType' => '利用者区分',
            'notes' => '備考',
        ];

        foreach ($fields as $field => $label) {
            $before = $this->beforeData[$field] ?? null;
            $after = $this->afterData[$field] ?? null;

            if ($before !== $after) {
                $changes[] = [
                    'field' => $field,
                    'fieldLabel' => $label,
                    'before' => $before,
                    'after' => $after,
                ];
            }
        }

        return $changes;
    }
}
```

### UseCase 設計

```php
// GetPatronHistoriesHandler
class GetPatronHistoriesHandler
{
    public function handle(GetPatronHistoriesQuery $query): array
    {
        $histories = $this->patronHistoryRepository->findByPatronId(
            new PatronId($query->patronId),
            $query->page,
            $query->perPage,
        );

        // 個人情報を復号化
        return array_map(function ($history) {
            return $history->withDecryptedData($this->encryptor);
        }, $histories);
    }
}
```

### フロントエンド実装

```typescript
// usePatronHistories.ts
export const usePatronHistories = (patronId: string) => {
  return useQuery({
    queryKey: ['patron', patronId, 'histories'],
    queryFn: () => patronApi.getHistories(patronId),
  });
};
```

### HistoryList コンポーネント

```tsx
// HistoryList.tsx
export const HistoryList: React.FC<{ patronId: string }> = ({ patronId }) => {
  const { data, isLoading } = usePatronHistories(patronId);

  if (isLoading) return <Spinner />;

  return (
    <div className="history-list">
      <h3>変更履歴</h3>
      {data?.histories.map((history) => (
        <HistoryItem key={history.id} history={history} />
      ))}
    </div>
  );
};

const HistoryItem: React.FC<{ history: PatronHistory }> = ({ history }) => (
  <div className="history-item">
    <div className="history-header">
      <span className="date">{formatDateTime(history.changedAt)}</span>
      <span className="user">{history.changedBy.name}</span>
    </div>
    <div className="history-changes">
      {history.changes.map((change, i) => (
        <div key={i} className="change">
          <span className="field">{change.fieldLabel}</span>
          <span className="before">{change.before || '（空）'}</span>
          <span className="arrow">→</span>
          <span className="after">{change.after || '（空）'}</span>
        </div>
      ))}
    </div>
  </div>
);
```

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| PatronHistory エンティティ | backend/packages/Domain/Patron/PatronHistory.php |
| PatronHistoryId | backend/packages/Domain/Patron/PatronHistoryId.php |
| PatronHistoryRepository | backend/packages/Domain/Patron/PatronHistoryRepository.php |
| GetPatronHistoriesQuery | backend/packages/Domain/Patron/Application/UseCases/Queries/GetPatronHistories/GetPatronHistoriesQuery.php |
| GetPatronHistoriesHandler | backend/packages/Domain/Patron/Application/UseCases/Queries/GetPatronHistories/GetPatronHistoriesHandler.php |
| PatronHistoryResource | backend/app/Http/Resources/PatronHistoryResource.php |
| マイグレーション | backend/database/migrations/xxxx_create_patron_histories_table.php |
| HistoryList | frontend/src/features/patron/components/HistoryList.tsx |
| usePatronHistories | frontend/src/features/patron/hooks/usePatronHistories.ts |
| Feature テスト | backend/tests/Feature/Patron/PatronHistoryTest.php |

---

## タスク

### Design Tasks（外部設計）

- [ ] 変更履歴の表示形式確定
- [ ] 表示項目の確認

### Spec Tasks（詳細設計）

- [ ] PatronHistory エンティティ実装
- [ ] PatronHistoryId 値オブジェクト実装
- [ ] PatronHistoryRepository インターフェース定義
- [ ] EloquentPatronHistoryRepository 実装
- [ ] マイグレーション作成
- [ ] GetPatronHistoriesQuery 実装
- [ ] GetPatronHistoriesHandler 実装
- [ ] PatronHistoryResource 実装
- [ ] PatronController に histories メソッド追加
- [ ] ルーティング設定
- [ ] patronApi に getHistories メソッド追加
- [ ] usePatronHistories フック実装
- [ ] HistoryList コンポーネント実装
- [ ] Feature テスト作成

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
