# ST-003: æ¨©é™åˆ¥ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºã®å®Ÿè£…

æœ€çµ‚æ›´æ–°: 2025-12-26

---

## ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

**ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã¨ã—ã¦**ã€ç®¡ç†è€…ã®ã¿ã«ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ãŸã„ã€‚
**ãªãœãªã‚‰**ã€ä¸€èˆ¬è·å“¡ãŒè·å“¡ç®¡ç†æ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‚ˆã†ã«ã—ãŸã„ã‹ã‚‰ã ã€‚

---

## é–¢é€£æƒ…å ±

| é …ç›® | å€¤ |
|------|-----|
| Epic | [EPIC-002: è·å“¡ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½](../epic.md) |
| ãƒã‚¤ãƒ³ãƒˆ | 2 |
| å„ªå…ˆåº¦ | Must |
| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | Planned |

---

## å—ã‘å…¥ã‚Œæ¡ä»¶

1. [ ] ä¸€èˆ¬è·å“¡ã§ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã€ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨
2. [ ] ç®¡ç†è€…ã§ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã€ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
3. [ ] ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰è·å“¡ç®¡ç†ç”»é¢ã«é·ç§»ã§ãã‚‹ã“ã¨
4. [ ] ä¸€èˆ¬è·å“¡ãŒç›´æ¥ `/staff/accounts` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚ 403 ãŒè¿”ã‚‹ã“ã¨
5. [ ] æ¨©é™æƒ…å ±ã¯èªè¨¼æ™‚ã«å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨

---

## ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«

| ãƒ«ãƒ¼ãƒ«ID | ãƒ«ãƒ¼ãƒ«å†…å®¹ |
|----------|-----------|
| BR-UC001-02-01 | è·å“¡æ¨©é™ã«å¿œã˜ã¦è¡¨ç¤ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’åˆ¶å¾¡ã™ã‚‹ |
| BR-UC001-02-02 | ç®¡ç†è€…ã®ã¿è·å“¡ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ |

---

## æŠ€è¡“ä»•æ§˜

### æ¨©é™å®šç¾©

| æ¨©é™ | å€¤ | èª¬æ˜ |
|------|-----|------|
| staff | `staff` | ä¸€èˆ¬è·å“¡ |
| admin | `admin` | ç®¡ç†è€… |

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### authStore ã«æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°

```typescript
// authStore.ts
interface AuthState {
  user: User | null;
  isAdmin: () => boolean;
  hasRole: (role: string) => boolean;
}

export const useAuthStore = create<AuthState>((set, get) => ({
  user: null,
  isAdmin: () => get().user?.role === 'admin',
  hasRole: (role: string) => get().user?.role === role,
}));
```

#### AdminMenuSection ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```tsx
// AdminMenuSection.tsx
export const AdminMenuSection: React.FC = () => {
  const isAdmin = useAuthStore((state) => state.isAdmin());

  if (!isAdmin) {
    return null;
  }

  return (
    <section className="admin-menu">
      <h2>ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
      <div className="menu-grid">
        <MenuCard
          icon="ğŸ‘¥"
          label="è·å“¡ç®¡ç†"
          to="/staff/accounts"
        />
      </div>
    </section>
  );
};
```

#### RequireAdmin ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```tsx
// RequireAdmin.tsx
export const RequireAdmin: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const isAdmin = useAuthStore((state) => state.isAdmin());

  if (!isAdmin) {
    return <Navigate to="/staff/dashboard" replace />;
  }

  return <>{children}</>;
};
```

#### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š

```tsx
// routes.tsx
{
  element: <ProtectedRoute><StaffLayout /></ProtectedRoute>,
  children: [
    { path: 'dashboard', element: <DashboardPage /> },
    { path: 'patrons', element: <PatronsListPage /> },
    // ç®¡ç†è€…å°‚ç”¨ãƒ«ãƒ¼ãƒˆ
    {
      element: <RequireAdmin><Outlet /></RequireAdmin>,
      children: [
        { path: 'accounts', element: <StaffAccountsListPage /> },
        { path: 'accounts/new', element: <StaffAccountsNewPage /> },
      ],
    },
  ],
}
```

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### AdminMiddleware

```php
// AdminMiddleware.php
class AdminMiddleware
{
    public function handle(Request $request, Closure $next): Response
    {
        if (!$request->user() || !$request->user()->isAdmin()) {
            return response()->json([
                'message' => 'ã“ã®æ“ä½œã‚’è¡Œã†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“',
            ], 403);
        }

        return $next($request);
    }
}
```

#### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š

```php
// routes/api.php
Route::middleware(['auth:sanctum', 'admin'])->prefix('staff')->group(function () {
    Route::resource('accounts', StaffAccountController::class);
});
```

#### Staff ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

```php
// Staff Entity
class Staff
{
    public function isAdmin(): bool
    {
        return $this->role === Role::ADMIN;
    }
}
```

---

## æˆæœç‰©

| æˆæœç‰© | é…ç½®å ´æ‰€ |
|--------|---------|
| authStoreï¼ˆæ›´æ–°ï¼‰ | frontend/src/stores/authStore.ts |
| AdminMenuSection | frontend/src/features/dashboard/components/AdminMenuSection.tsx |
| RequireAdmin | frontend/src/features/auth/components/RequireAdmin.tsx |
| AdminMiddleware | backend/app/Http/Middleware/AdminMiddleware.php |
| Role Enum | backend/packages/Domain/Staff/Enums/Role.php |
| ãƒ†ã‚¹ãƒˆ | frontend/src/features/auth/\_\_tests\_\_/RequireAdmin.test.tsx |
| Feature ãƒ†ã‚¹ãƒˆ | backend/tests/Feature/Middleware/AdminMiddlewareTest.php |

---

## ã‚¿ã‚¹ã‚¯

### Design Tasksï¼ˆå¤–éƒ¨è¨­è¨ˆï¼‰

- [ ] æ¨©é™ä½“ç³»ã®ç¢ºå®š
- [ ] æ¨©é™ã‚¨ãƒ©ãƒ¼æ™‚ã®UIç¢ºå®š

### Spec Tasksï¼ˆè©³ç´°è¨­è¨ˆï¼‰

- [ ] Role Enum å®Ÿè£…
- [ ] Staff ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã« isAdmin() è¿½åŠ 
- [ ] AdminMiddleware å®Ÿè£…
- [ ] Kernel ã«ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ç™»éŒ²
- [ ] authStore ã«æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°è¿½åŠ 
- [ ] RequireAdmin ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…
- [ ] AdminMenuSection ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…
- [ ] ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ›´æ–°ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆ/ãƒãƒƒã‚¯ï¼‰
- [ ] ãƒ†ã‚¹ãƒˆä½œæˆ

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|------|---------|
| 2025-12-26 | åˆç‰ˆä½œæˆ |
