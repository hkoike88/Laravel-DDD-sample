# EPIC-010: 利用者アカウント無効化機能

最終更新: 2025-12-26

---

## 概要

図書館職員が利用者アカウントを無効化する機能を実装する。転出、死亡、規約違反などの理由により、利用者の貸出機能を停止する。無効化されたアカウントはデータを保持したまま論理削除され、必要に応じて再有効化が可能。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| イニシアチブ | [INI-001: 認証・利用者管理基盤](../../../../01_vision/initiatives/INI-001/charter.md) |
| Use Case | [UC-001-010: 利用者アカウント無効化](../../../../01_vision/initiatives/INI-001/usecases/UC-001-010_利用者アカウント無効化.md) |
| 優先度 | Must |
| ステータス | Planned |

---

## ビジネス価値

転出や規約違反などの理由で利用資格を失った利用者のアカウントを適切に停止し、不正利用を防止する。論理削除により履歴データを保持しつつ、必要に応じて再有効化できる柔軟性を提供する。

---

## 受け入れ条件

1. 職員が利用者アカウントを無効化できること
2. 無効化時に理由の選択・入力が必須であること
3. 未返却図書がある場合は警告が表示されること
4. 無効化された利用者は新規貸出ができなくなること
5. 無効化されたアカウントを再有効化できること
6. 無効化操作が監査ログに記録されること

---

## 画面一覧

| 画面ID | 画面名 | パス | 説明 |
|--------|--------|------|------|
| SCR-001-012 | 利用者詳細 | `/staff/patrons/{id}` | 無効化ボタン表示 |
| SCR-001-010 | 利用者管理 | `/staff/patrons` | 無効化済み利用者表示 |

---

## User Story 一覧

| ID | Story 名 | ポイント | 優先度 | ステータス |
|----|----------|---------|--------|----------|
| [ST-001](./stories/ST-001_利用者アカウント無効化API実装.md) | 利用者アカウント無効化 API の実装 | 3 | Must | Planned |
| [ST-002](./stories/ST-002_利用者アカウント無効化UI実装.md) | 利用者アカウント無効化 UI の実装 | 2 | Must | Planned |
| [ST-003](./stories/ST-003_利用者アカウント再有効化機能実装.md) | 利用者アカウント再有効化機能の実装 | 2 | Must | Planned |

---

## 成果物

| 成果物 | 配置場所 | 説明 |
|--------|---------|------|
| DeactivatePatronHandler | backend/packages/Domain/Patron/Application/UseCases/Commands/DeactivatePatron/ | 無効化処理 |
| ReactivatePatronHandler | backend/packages/Domain/Patron/Application/UseCases/Commands/ReactivatePatron/ | 再有効化処理 |
| PatronController（更新） | backend/app/Http/Controllers/Patron/ | 無効化エンドポイント |
| DeactivatePatronDialog | frontend/src/features/patron/components/ | 無効化確認ダイアログ |

---

## 技術仕様

### API エンドポイント

| メソッド | エンドポイント | 説明 | 認証 | 権限 |
|----------|---------------|------|------|------|
| DELETE | `/api/patrons/{id}` | 利用者無効化（論理削除） | 必須 | 職員 |
| POST | `/api/patrons/{id}/reactivate` | 利用者再有効化 | 必須 | 職員 |

### リクエスト/レスポンス

#### DELETE /api/patrons/{id}

**リクエスト:**
```json
{
  "reason": "relocation",
  "notes": "転出届確認済み"
}
```

**無効化理由コード:**
| コード | 理由 |
|--------|------|
| relocation | 転出 |
| request | 本人希望 |
| expired | 有効期限切れ（長期未更新） |
| violation | 規約違反 |
| other | その他 |

**成功レスポンス (200):**
```json
{
  "message": "利用者アカウントを無効化しました"
}
```

**未返却警告レスポンス (200):**
```json
{
  "message": "利用者アカウントを無効化しました",
  "warning": "未返却図書が2冊あります"
}
```

#### POST /api/patrons/{id}/reactivate

**成功レスポンス (200):**
```json
{
  "message": "利用者アカウントを再有効化しました",
  "patron": {
    "id": "01HV...",
    "patronNumber": "P2025000001",
    "name": "山田 太郎",
    "isActive": true
  }
}
```

---

## 依存関係

### 前提条件

| Epic ID | Epic 名 | 関係 |
|---------|---------|------|
| EPIC-001 | 職員ログイン機能 | 認証機能が完了していること |
| EPIC-008 | 利用者アカウント登録機能 | 利用者が登録済みであること |
| EPIC-011 | 利用者検索機能 | 無効化対象の検索 |

### 後続タスク

なし（本 Epic で利用者管理機能は完了）

---

## 非機能要件

| 項目 | 要件 |
|------|------|
| パフォーマンス | 無効化処理は2秒以内に完了する |
| セキュリティ | 無効化操作は職員権限が必要 |
| 監査 | 無効化操作を audit チャンネルに記録 |
| データ保持 | 論理削除によりデータを保持（物理削除しない） |

---

## ビジネスルール

| ルールID | ルール内容 |
|----------|-----------|
| BR-UC001-10-01 | 無効化された利用者は新規貸出不可 |
| BR-UC001-10-02 | 無効化しても利用者データは削除しない（論理削除） |
| BR-UC001-10-03 | 未返却図書がある場合は警告を表示する |
| BR-UC001-10-04 | 無効化理由は必須 |
| BR-UC001-10-05 | 無効化された利用者は再有効化が可能 |

---

## 関連ドキュメント

- [UC-001-010: 利用者アカウント無効化](../../../../01_vision/initiatives/INI-001/usecases/UC-001-010_利用者アカウント無効化.md)
- [利用者登録・管理業務フロー（AS-IS）](../../../../00_docs/10_business/asis/swimlane/user-registration-process.md)
- [セキュリティ標準 - データ分類・保護ポリシー](../../../../00_docs/20_tech/99_standard/security/03_DataClassification.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
