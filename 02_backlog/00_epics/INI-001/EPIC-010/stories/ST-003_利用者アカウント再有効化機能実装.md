# ST-003: 利用者アカウント再有効化機能の実装

最終更新: 2025-12-26

---

## ストーリー

**図書館職員として**、無効化された利用者アカウントを再有効化したい。
**なぜなら**、転入や誤って無効化したアカウントを復活させたいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-010: 利用者アカウント無効化機能](../epic.md) |
| ポイント | 2 |
| 優先度 | Must |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] `POST /api/patrons/{id}/reactivate` で再有効化できること
2. [ ] 無効化された利用者の詳細画面に「再有効化」ボタンが表示されること
3. [ ] 再有効化ボタンクリックで確認ダイアログが表示されること
4. [ ] 再有効化成功時にメッセージが表示されること
5. [ ] 再有効化された利用者が貸出可能になること
6. [ ] 既に有効なアカウントを再有効化しようとすると 422 が返ること
7. [ ] 再有効化操作が監査ログに記録されること

---

## 技術仕様

### API エンドポイント

| メソッド | エンドポイント | 説明 | 認証 | 権限 |
|----------|---------------|------|------|------|
| POST | `/api/patrons/{id}/reactivate` | 利用者再有効化 | 必須 | 職員 |

### リクエスト/レスポンス

#### POST /api/patrons/{id}/reactivate

**リクエスト:**
```
POST /api/patrons/01HV.../reactivate
（リクエストボディなし）
```

**成功レスポンス (200):**
```json
{
  "message": "利用者アカウントを再有効化しました",
  "patron": {
    "id": "01HV...",
    "patronNumber": "P2025000001",
    "name": "山田 太郎",
    "isActive": true,
    "expiresAt": "2026-12-26"
  }
}
```

**既に有効エラーレスポンス (422):**
```json
{
  "message": "このアカウントは既に有効です"
}
```

### UseCase 設計

```php
// ReactivatePatronHandler
class ReactivatePatronHandler
{
    public function handle(ReactivatePatronCommand $command): Patron
    {
        $patron = $this->patronRepository->findById(new PatronId($command->patronId));

        if ($patron === null) {
            throw new PatronNotFoundException('利用者が見つかりません');
        }

        // 既に有効チェック
        if ($patron->isActive()) {
            throw new AlreadyActiveException('このアカウントは既に有効です');
        }

        // 再有効化（有効期限も更新）
        $patron->reactivate();
        $this->patronRepository->save($patron);

        // 監査ログ
        $this->logger->channel('audit')->info('利用者アカウントを再有効化しました', [
            'patron_id' => $patron->id()->value(),
            'reactivated_by' => $command->staffId,
        ]);

        return $patron;
    }
}
```

### Patron エンティティの reactivate メソッド

```php
// Patron.php
public function reactivate(): void
{
    $this->isActive = true;
    $this->deactivatedAt = null;
    $this->expiresAt = Carbon::now()->addYear();
    $this->reactivatedAt = Carbon::now();
}
```

### Controller 実装

```php
// PatronController
public function reactivate(string $id): JsonResponse
{
    $patron = $this->reactivatePatronHandler->handle(
        new ReactivatePatronCommand(
            patronId: $id,
            staffId: auth()->id(),
        )
    );

    return response()->json([
        'message' => '利用者アカウントを再有効化しました',
        'patron' => new PatronResource($patron),
    ]);
}
```

### フロントエンド実装

```typescript
// useReactivatePatron.ts
export const useReactivatePatron = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (id: string) => patronApi.reactivate(id),
    onSuccess: (_, id) => {
      queryClient.invalidateQueries({ queryKey: ['patron', id] });
      queryClient.invalidateQueries({ queryKey: ['patrons'] });
      toast.success('利用者アカウントを再有効化しました');
    },
    onError: (error: AxiosError<ApiError>) => {
      if (error.response?.status === 422) {
        toast.error(error.response.data.message);
      } else {
        toast.error('再有効化に失敗しました');
      }
    },
  });
};
```

### 再有効化確認ダイアログ

```
┌───────────────────────────────────────────┐
│  ✅ 利用者アカウント再有効化の確認        │
├───────────────────────────────────────────┤
│                                           │
│  「山田 太郎」さん（P2025000001）の        │
│  アカウントを再有効化しますか？           │
│                                           │
│  再有効化されたアカウントは               │
│  図書の貸出が可能になります。             │
│  有効期限は本日から1年間に更新されます。  │
│                                           │
│              [キャンセル] [再有効化する]  │
│                                           │
└───────────────────────────────────────────┘
```

### ReactivatePatronDialog コンポーネント

```tsx
// ReactivatePatronDialog.tsx
export const ReactivatePatronDialog: React.FC<ReactivatePatronDialogProps> = ({
  patron,
  open,
  onClose,
  onConfirm,
  isPending,
}) => {
  return (
    <Dialog open={open} onClose={onClose}>
      <DialogTitle>利用者アカウント再有効化の確認</DialogTitle>
      <DialogContent>
        <p>
          「{patron.name}」さん（{patron.patronNumber}）の
          アカウントを再有効化しますか？
        </p>
        <p>
          再有効化されたアカウントは図書の貸出が可能になります。
          有効期限は本日から1年間に更新されます。
        </p>
      </DialogContent>
      <DialogActions>
        <Button variant="secondary" onClick={onClose}>
          キャンセル
        </Button>
        <Button onClick={onConfirm} loading={isPending}>
          再有効化する
        </Button>
      </DialogActions>
    </Dialog>
  );
};
```

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| ReactivatePatronCommand | backend/packages/Domain/Patron/Application/UseCases/Commands/ReactivatePatron/ReactivatePatronCommand.php |
| ReactivatePatronHandler | backend/packages/Domain/Patron/Application/UseCases/Commands/ReactivatePatron/ReactivatePatronHandler.php |
| AlreadyActiveException | backend/packages/Domain/Patron/Exceptions/AlreadyActiveException.php |
| PatronController（更新） | backend/app/Http/Controllers/Patron/PatronController.php |
| ReactivatePatronDialog | frontend/src/features/patron/components/ReactivatePatronDialog.tsx |
| useReactivatePatron | frontend/src/features/patron/hooks/useReactivatePatron.ts |
| Feature テスト | backend/tests/Feature/Patron/ReactivatePatronTest.php |

---

## タスク

### Design Tasks（外部設計）

- [ ] ダイアログデザインの確定
- [ ] 成功メッセージの確定

### Spec Tasks（詳細設計）

- [ ] ReactivatePatronCommand 実装
- [ ] ReactivatePatronHandler 実装
- [ ] AlreadyActiveException 実装
- [ ] Patron エンティティに reactivate メソッド追加
- [ ] PatronController に reactivate メソッド追加
- [ ] ルーティング設定
- [ ] patronApi に reactivate メソッド追加
- [ ] useReactivatePatron フック実装
- [ ] ReactivatePatronDialog コンポーネント実装
- [ ] PatronDetailPage に再有効化ボタン追加
- [ ] 監査ログ出力実装
- [ ] Feature テスト作成

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
