# EPIC-006: 職員ログアウト機能

最終更新: 2025-12-26

---

## 概要

職員がシステムからログアウトし、セッションを安全に終了する機能を実装する。ログアウト時にはすべてのセッション情報を確実に破棄し、ログイン画面へリダイレクトする。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| イニシアチブ | [INI-001: 認証・利用者管理基盤](../../../../01_vision/initiatives/INI-001/charter.md) |
| Use Case | [UC-001-006: 職員ログアウト](../../../../01_vision/initiatives/INI-001/usecases/UC-001-006_職員ログアウト.md) |
| 優先度 | Must |
| ステータス | Planned |

---

## ビジネス価値

セッションの安全な終了を実現し、共有端末での使用時や離席時のセキュリティを確保する。
職員が確実にログアウトできることで、不正アクセスのリスクを低減する。

---

## 受け入れ条件

1. ログアウトボタンをクリックするとセッションが破棄されること
2. ログアウト後、ログイン画面にリダイレクトされること
3. ログアウト完了メッセージが表示されること
4. ログアウト後、職員向け画面にアクセスできなくなること
5. ログアウト処理が1秒以内に完了すること

---

## 画面一覧

| 画面ID | 画面名 | パス | 説明 |
|--------|--------|------|------|
| SCR-001-002 | 職員ダッシュボード | `/staff/dashboard` | ログアウトボタンを含むヘッダー |
| SCR-001-001 | 職員ログイン | `/staff/login` | ログアウト完了メッセージ表示 |

---

## User Story 一覧

| ID | Story 名 | ポイント | 優先度 | ステータス |
|----|----------|---------|--------|----------|
| [ST-001](./stories/ST-001_ログアウトAPI実装.md) | ログアウト API の実装 | 1 | Must | Planned |
| [ST-002](./stories/ST-002_ログアウトUI実装.md) | ログアウト UI の実装 | 2 | Must | Planned |
| [ST-003](./stories/ST-003_ログアウト完了通知実装.md) | ログアウト完了通知の実装 | 1 | Should | Planned |

---

## 成果物

| 成果物 | 配置場所 | 説明 |
|--------|---------|------|
| LogoutHandler | backend/packages/Domain/Staff/Application/UseCases/Commands/Logout/ | ログアウト処理 |
| AuthController（更新） | backend/app/Http/Controllers/Auth/ | logout エンドポイント |
| UserMenu | frontend/src/components/layout/ | ログアウトボタンを含むメニュー |
| useLogout | frontend/src/features/auth/hooks/ | ログアウト用カスタムフック |

---

## 技術仕様

### API エンドポイント

| メソッド | エンドポイント | 説明 | 認証 |
|----------|---------------|------|------|
| POST | `/api/auth/logout` | ログアウト | 必須 |

### リクエスト/レスポンス

#### POST /api/auth/logout

**リクエスト:**
```
POST /api/auth/logout
Cookie: laravel_session=xxx
X-XSRF-TOKEN: xxx
```

**成功レスポンス (200):**
```json
{
  "message": "ログアウトしました"
}
```

**未認証レスポンス (401):**
```json
{
  "message": "Unauthenticated."
}
```

### ログアウトフロー

```
┌──────────────┐                  ┌──────────────┐
│   Frontend   │                  │   Backend    │
└──────┬───────┘                  └──────┬───────┘
       │                                 │
       │  1. POST /api/auth/logout       │
       │────────────────────────────────>│
       │                                 │  セッション破棄
       │  200 OK                         │
       │<────────────────────────────────│
       │                                 │
       │  2. 認証状態クリア              │
       │  3. /login へリダイレクト       │
       │  4. 完了メッセージ表示          │
```

### セッション破棄処理

```php
// LogoutHandler
public function handle(): void
{
    // 1. 現在のセッションを無効化
    Auth::guard('web')->logout();

    // 2. セッションを再生成（セッション固定攻撃対策）
    request()->session()->invalidate();

    // 3. CSRF トークンを再生成
    request()->session()->regenerateToken();
}
```

---

## 依存関係

### 前提条件

| Epic ID | Epic 名 | 関係 |
|---------|---------|------|
| EPIC-001 | 職員ログイン機能 | ログイン機能が完了していること |
| EPIC-002 | 職員ダッシュボード機能 | ダッシュボードにログアウトボタンを配置 |

### 後続タスク

なし（本 Epic で認証系機能は完了）

---

## 非機能要件

| 項目 | 要件 |
|------|------|
| パフォーマンス | ログアウト処理は1秒以内に完了する |
| セキュリティ | セッション情報は確実に破棄される |
| セキュリティ | セッション固定攻撃を防ぐためセッションIDを再生成する |

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-24 | 初版作成 |
