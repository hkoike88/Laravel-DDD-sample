# ST-003: 職員アカウント再有効化機能の実装

最終更新: 2025-12-26

---

## ストーリー

**管理者として**、無効化された職員アカウントを再有効化したい。
**なぜなら**、復職した職員や誤って無効化したアカウントを復活させたいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-005: 職員アカウント無効化機能](../epic.md) |
| ポイント | 2 |
| 優先度 | Must |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] `POST /api/staff/accounts/{id}/reactivate` で再有効化できること
2. [ ] 無効化されたアカウントの一覧に「再有効化」ボタンが表示されること
3. [ ] 再有効化ボタンクリックで確認ダイアログが表示されること
4. [ ] 再有効化成功時にメッセージが表示されること
5. [ ] 再有効化された職員がログインできるようになること
6. [ ] 既に有効なアカウントを再有効化しようとすると 422 が返ること
7. [ ] 再有効化操作が監査ログに記録されること

---

## 技術仕様

### API エンドポイント

| メソッド | エンドポイント | 説明 | 認証 | 権限 |
|----------|---------------|------|------|------|
| POST | `/api/staff/accounts/{id}/reactivate` | 職員再有効化 | 必須 | 管理者 |

### リクエスト/レスポンス

#### POST /api/staff/accounts/{id}/reactivate

**成功レスポンス (200):**
```json
{
  "message": "職員アカウントを再有効化しました",
  "staff": {
    "id": "01HV...",
    "name": "田中 花子",
    "email": "tanaka@example.com",
    "role": "staff",
    "isActive": true
  }
}
```

**既に有効エラーレスポンス (422):**
```json
{
  "message": "このアカウントは既に有効です"
}
```

### UseCase 設計

```php
// ReactivateStaffHandler
class ReactivateStaffHandler
{
    public function handle(ReactivateStaffCommand $command): Staff
    {
        $staff = $this->staffRepository->findById(new StaffId($command->staffId));

        // 既に有効チェック
        if ($staff->isActive()) {
            throw new AlreadyActiveException(
                'このアカウントは既に有効です'
            );
        }

        // 再有効化
        $staff->reactivate();
        $this->staffRepository->save($staff);

        // 監査ログ
        $this->logger->channel('security')->info('職員アカウントを再有効化しました', [
            'staff_id' => $command->staffId,
            'reactivated_by' => $command->currentUserId,
        ]);

        return $staff;
    }
}
```

### Controller 実装

```php
// StaffAccountController
public function reactivate(string $id): JsonResponse
{
    $staff = $this->reactivateStaffHandler->handle(
        new ReactivateStaffCommand(
            staffId: $id,
            currentUserId: auth()->id(),
        )
    );

    return response()->json([
        'message' => '職員アカウントを再有効化しました',
        'staff' => new StaffResource($staff),
    ]);
}
```

### フロントエンド実装

#### 再有効化確認ダイアログ

```
┌───────────────────────────────────────────┐
│  ✅ 職員アカウント再有効化の確認          │
├───────────────────────────────────────────┤
│                                           │
│  「田中 花子」さんのアカウントを          │
│  再有効化しますか？                       │
│                                           │
│  再有効化されたアカウントは               │
│  システムにログインできるようになります。 │
│                                           │
│              [キャンセル] [再有効化する]  │
│                                           │
└───────────────────────────────────────────┘
```

#### useReactivateStaff Hook

```typescript
// useReactivateStaff.ts
export const useReactivateStaff = () => {
  const queryClient = useQueryClient();
  const [showDialog, setShowDialog] = useState(false);
  const [targetStaff, setTargetStaff] = useState<Staff | null>(null);

  const mutation = useMutation({
    mutationFn: (id: string) => staffApi.reactivate(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['staff', 'accounts'] });
      setShowDialog(false);
      toast.success('職員アカウントを再有効化しました');
    },
  });

  const openDialog = (staff: Staff) => {
    setTargetStaff(staff);
    setShowDialog(true);
  };

  return {
    ...mutation,
    showDialog,
    targetStaff,
    openDialog,
    closeDialog: () => setShowDialog(false),
  };
};
```

#### ReactivateDialog コンポーネント

```tsx
// ReactivateDialog.tsx
export const ReactivateDialog: React.FC<ReactivateDialogProps> = ({
  staff,
  open,
  onClose,
  onConfirm,
  isPending,
}) => {
  return (
    <Dialog open={open} onClose={onClose}>
      <DialogTitle>職員アカウント再有効化の確認</DialogTitle>
      <DialogContent>
        <p>「{staff.name}」さんのアカウントを再有効化しますか？</p>
        <p>再有効化されたアカウントはシステムにログインできるようになります。</p>
      </DialogContent>
      <DialogActions>
        <Button variant="secondary" onClick={onClose}>
          キャンセル
        </Button>
        <Button onClick={onConfirm} loading={isPending}>
          再有効化する
        </Button>
      </DialogActions>
    </Dialog>
  );
};
```

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| ReactivateStaffCommand | backend/packages/Domain/Staff/Application/UseCases/Commands/ReactivateStaff/ReactivateStaffCommand.php |
| ReactivateStaffHandler | backend/packages/Domain/Staff/Application/UseCases/Commands/ReactivateStaff/ReactivateStaffHandler.php |
| AlreadyActiveException | backend/packages/Domain/Staff/Exceptions/AlreadyActiveException.php |
| ReactivateDialog | frontend/src/features/staff/components/ReactivateDialog.tsx |
| useReactivateStaff | frontend/src/features/staff/hooks/useReactivateStaff.ts |
| Feature テスト | backend/tests/Feature/Staff/ReactivateStaffTest.php |

---

## タスク

### Design Tasks（外部設計）

- [ ] ダイアログデザインの確定
- [ ] 成功メッセージの確定

### Spec Tasks（詳細設計）

- [ ] ReactivateStaffCommand 実装
- [ ] ReactivateStaffHandler 実装
- [ ] Staff エンティティに reactivate メソッド追加
- [ ] AlreadyActiveException 実装
- [ ] StaffAccountController に reactivate メソッド追加
- [ ] ルーティング設定
- [ ] staffApi に reactivate メソッド追加
- [ ] useReactivateStaff フック実装
- [ ] ReactivateDialog コンポーネント実装
- [ ] ActionButtons コンポーネント更新
- [ ] 監査ログ出力実装
- [ ] テスト作成

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
