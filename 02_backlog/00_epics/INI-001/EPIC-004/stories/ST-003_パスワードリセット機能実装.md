# ST-003: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã®å®Ÿè£…

æœ€çµ‚æ›´æ–°: 2025-12-26

---

## ã‚¹ãƒˆãƒ¼ãƒªãƒ¼

**ç®¡ç†è€…ã¨ã—ã¦**ã€è·å“¡ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ãŸã„ã€‚
**ãªãœãªã‚‰**ã€è·å“¡ãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆã‚„ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãŒå¿…è¦ãªå ´åˆã«å¯¾å¿œã—ãŸã„ã‹ã‚‰ã ã€‚

---

## é–¢é€£æƒ…å ±

| é …ç›® | å€¤ |
|------|-----|
| Epic | [EPIC-004: è·å“¡ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç·¨é›†æ©Ÿèƒ½](../epic.md) |
| ãƒã‚¤ãƒ³ãƒˆ | 2 |
| å„ªå…ˆåº¦ | Must |
| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | Planned |

---

## å—ã‘å…¥ã‚Œæ¡ä»¶

1. [ ] ç·¨é›†ç”»é¢ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚’å®Ÿè¡Œã§ãã‚‹ã“ã¨
2. [ ] ãƒªã‚»ãƒƒãƒˆå‰ã«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
3. [ ] ãƒªã‚»ãƒƒãƒˆæˆåŠŸæ™‚ã«æ–°ã—ã„ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
4. [ ] ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã§ãã‚‹ã“ã¨
5. [ ] ãƒªã‚»ãƒƒãƒˆå¾Œã€å¯¾è±¡è·å“¡ã®æ¬¡å›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãŒå¼·åˆ¶ã•ã‚Œã‚‹ã“ã¨ï¼ˆPhase 2ï¼‰
6. [ ] ç®¡ç†è€…ä»¥å¤–ãŒAPIã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ 403 ãŒè¿”ã‚‹ã“ã¨
7. [ ] ãƒªã‚»ãƒƒãƒˆæ“ä½œãŒç›£æŸ»ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨

---

## æŠ€è¡“ä»•æ§˜

### API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ãƒ¡ã‚½ãƒƒãƒ‰ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | èª¬æ˜ | èªè¨¼ | æ¨©é™ |
|----------|---------------|------|------|------|
| POST | `/api/staff/accounts/{id}/reset-password` | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ | å¿…é ˆ | ç®¡ç†è€… |

### ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹

#### POST /api/staff/accounts/{id}/reset-password

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```
POST /api/staff/accounts/01HV.../reset-password
```

**æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ (200):**
```json
{
  "message": "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ",
  "temporaryPassword": "NewPass123!@#abc"
}
```

**æ¨©é™ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (403):**
```json
{
  "message": "ã“ã®æ“ä½œã‚’è¡Œã†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“"
}
```

### UseCase è¨­è¨ˆ

```php
// ResetPasswordHandler
class ResetPasswordHandler
{
    public function __construct(
        private StaffRepositoryInterface $staffRepository,
        private PasswordGenerator $passwordGenerator,
        private LoggerInterface $logger,
    ) {}

    public function handle(ResetPasswordCommand $command): ResetPasswordResult
    {
        $staff = $this->staffRepository->findById(new StaffId($command->staffId));

        $temporaryPassword = $this->passwordGenerator->generate(16);

        $staff->resetPassword(
            password: Hash::make($temporaryPassword),
            requireChange: true,
        );

        $this->staffRepository->save($staff);

        $this->logger->channel('security')->info('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', [
            'staff_id' => $staff->id()->value(),
            'reset_by' => $command->currentUserId,
        ]);

        return new ResetPasswordResult($temporaryPassword);
    }
}
```

### Controller å®Ÿè£…

```php
// StaffAccountController
public function resetPassword(string $id): JsonResponse
{
    $result = $this->resetPasswordHandler->handle(
        new ResetPasswordCommand(
            staffId: $id,
            currentUserId: auth()->id(),
        )
    );

    return response()->json([
        'message' => 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ',
        'temporaryPassword' => $result->temporaryPassword,
    ]);
}
```

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®ç¢ºèª              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                           â”‚
â”‚  ã€Œç”°ä¸­ èŠ±å­ã€ã•ã‚“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’          â”‚
â”‚  ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ                       â”‚
â”‚                                           â”‚
â”‚  â€» æ–°ã—ã„ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç™ºè¡Œã•ã‚Œã¾ã™     â”‚
â”‚                                           â”‚
â”‚              [ã‚­ãƒ£ãƒ³ã‚»ãƒ«] [ãƒªã‚»ãƒƒãƒˆã™ã‚‹]  â”‚
â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æˆåŠŸãƒ€ã‚¤ã‚¢ãƒ­ã‚°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                           â”‚
â”‚  æ–°ã—ã„ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ NewPass123!@#abc      [ã‚³ãƒ”ãƒ¼]    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                           â”‚
â”‚  â€» ã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å†è¡¨ç¤ºã§ãã¾ã›ã‚“       â”‚
â”‚  â€» è·å“¡ã«å®‰å…¨ãªæ–¹æ³•ã§ä¼ãˆã¦ãã ã•ã„       â”‚
â”‚                                           â”‚
â”‚                              [é–‰ã˜ã‚‹]     â”‚
â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### useResetPassword Hook

```typescript
// useResetPassword.ts
export const useResetPassword = () => {
  const [showConfirmDialog, setShowConfirmDialog] = useState(false);
  const [showPasswordDialog, setShowPasswordDialog] = useState(false);
  const [temporaryPassword, setTemporaryPassword] = useState('');
  const [targetStaff, setTargetStaff] = useState<Staff | null>(null);

  const mutation = useMutation({
    mutationFn: (staffId: string) => staffApi.resetPassword(staffId),
    onSuccess: (data) => {
      setTemporaryPassword(data.temporaryPassword);
      setShowConfirmDialog(false);
      setShowPasswordDialog(true);
    },
  });

  const openConfirmDialog = (staff: Staff) => {
    setTargetStaff(staff);
    setShowConfirmDialog(true);
  };

  const handleConfirm = () => {
    if (targetStaff) {
      mutation.mutate(targetStaff.id);
    }
  };

  return {
    ...mutation,
    showConfirmDialog,
    showPasswordDialog,
    temporaryPassword,
    targetStaff,
    openConfirmDialog,
    handleConfirm,
    closeConfirmDialog: () => setShowConfirmDialog(false),
    closePasswordDialog: () => setShowPasswordDialog(false),
  };
};
```

---

## æˆæœç‰©

| æˆæœç‰© | é…ç½®å ´æ‰€ |
|--------|---------|
| ResetPasswordCommand | backend/packages/Domain/Staff/Application/UseCases/Commands/ResetPassword/ResetPasswordCommand.php |
| ResetPasswordHandler | backend/packages/Domain/Staff/Application/UseCases/Commands/ResetPassword/ResetPasswordHandler.php |
| ResetPasswordResult | backend/packages/Domain/Staff/Application/UseCases/Commands/ResetPassword/ResetPasswordResult.php |
| ResetPasswordButton | frontend/src/features/staff/components/ResetPasswordButton.tsx |
| ResetPasswordConfirmDialog | frontend/src/features/staff/components/ResetPasswordConfirmDialog.tsx |
| useResetPassword | frontend/src/features/staff/hooks/useResetPassword.ts |
| Feature ãƒ†ã‚¹ãƒˆ | backend/tests/Feature/Staff/ResetPasswordTest.php |

---

## ã‚¿ã‚¹ã‚¯

### Design Tasksï¼ˆå¤–éƒ¨è¨­è¨ˆï¼‰

- [ ] ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒ‡ã‚¶ã‚¤ãƒ³ã®ç¢ºå®š
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã®ç¢ºèª

### Spec Tasksï¼ˆè©³ç´°è¨­è¨ˆï¼‰

- [ ] ResetPasswordCommand å®Ÿè£…
- [ ] ResetPasswordHandler å®Ÿè£…
- [ ] StaffAccountController ã« resetPassword ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
- [ ] Staff ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã« resetPassword ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
- [ ] staffApi ã« resetPassword ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ 
- [ ] useResetPassword ãƒ•ãƒƒã‚¯å®Ÿè£…
- [ ] ResetPasswordButton ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…
- [ ] ResetPasswordConfirmDialog ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…
- [ ] ç›£æŸ»ãƒ­ã‚°å‡ºåŠ›å®Ÿè£…
- [ ] ãƒ†ã‚¹ãƒˆä½œæˆ

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | å¤‰æ›´å†…å®¹ |
|------|---------|
| 2025-12-26 | åˆç‰ˆä½œæˆ |
