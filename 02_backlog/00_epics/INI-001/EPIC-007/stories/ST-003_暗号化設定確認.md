# ST-003: 暗号化設定の確認・調整

最終更新: 2025-12-26

---

## ストーリー

**開発者として**、暗号化設定がセキュリティ標準に準拠していることを確認・調整したい。
**なぜなら**、パスワードやデータを適切に保護し、情報漏洩リスクを最小化したいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-007: セキュリティ対策準備](../epic.md) |
| ポイント | 2 |
| 優先度 | Must |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] パスワードハッシュに bcrypt (cost=12) が使用されていること
2. [ ] セッションデータが暗号化されていること
3. [ ] アプリケーションキーが安全に生成されていること
4. [ ] TLS 1.2 以上が使用される設定であること
5. [ ] 平文でのパスワード保存が禁止されていること
6. [ ] 設定確認テストが作成されていること

---

## 技術仕様

### パスワードハッシュ設定

| 項目 | 設定値 | 備考 |
|------|--------|------|
| アルゴリズム | bcrypt | Laravel デフォルト |
| コスト係数 | 12 | デフォルト10から変更 |
| 代替 | Argon2id | 将来的な移行候補 |

### hashing.php 設定

```php
// config/hashing.php
return [
    'driver' => 'bcrypt',

    'bcrypt' => [
        'rounds' => 12,  // コスト係数を12に設定
        'verify' => true,
    ],

    // 代替として Argon2id も設定
    'argon' => [
        'memory' => 65536,  // 64MB
        'threads' => 4,
        'time' => 4,
        'verify' => true,
    ],
];
```

### 暗号化設定チェックリスト

| 項目 | 確認内容 | 設定場所 |
|------|---------|---------|
| APP_KEY | 32バイト以上のランダムキー | .env |
| セッション暗号化 | encrypt = true | config/session.php |
| Cookie 暗号化 | EncryptCookies ミドルウェア | Kernel.php |
| HTTPS 強制 | force_https = true | 本番環境 |
| bcrypt cost | rounds = 12 | config/hashing.php |

### TLS 設定（Nginx）

```nginx
# infrastructure/nginx/conf.d/default.conf
ssl_protocols TLSv1.2 TLSv1.3;
ssl_prefer_server_ciphers on;
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:...;
```

### 禁止事項

| 禁止内容 | 理由 |
|---------|------|
| 平文パスワード保存 | 情報漏洩時の被害拡大 |
| MD5/SHA-1 の使用 | 非推奨アルゴリズム |
| ソルトなしハッシュ | レインボーテーブル攻撃への脆弱性 |
| 可逆暗号化（AES等）でのパスワード保存 | 復号可能であるため |
| TLS 1.1 以下 | 既知の脆弱性あり |

### 設定確認テスト

```php
// tests/Unit/Config/EncryptionConfigTest.php
final class EncryptionConfigTest extends TestCase
{
    public function test_bcrypt_cost_is_12(): void
    {
        $this->assertEquals(12, config('hashing.bcrypt.rounds'));
    }

    public function test_session_is_encrypted(): void
    {
        $this->assertTrue(config('session.encrypt'));
    }

    public function test_app_key_is_set(): void
    {
        $this->assertNotEmpty(config('app.key'));
        $this->assertStringStartsWith('base64:', config('app.key'));
    }

    public function test_session_cookie_is_secure(): void
    {
        $this->assertTrue(config('session.secure'));
    }

    public function test_session_cookie_is_http_only(): void
    {
        $this->assertTrue(config('session.http_only'));
    }
}
```

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| hashing.php（更新） | backend/config/hashing.php |
| session.php（確認） | backend/config/session.php |
| Nginx SSL 設定 | infrastructure/nginx/conf.d/default.conf |
| 設定確認テスト | backend/tests/Unit/Config/EncryptionConfigTest.php |

---

## タスク

### Design Tasks（外部設計）

- [ ] 暗号化アルゴリズムの最終確認
- [ ] TLS バージョン要件の確認
- [ ] 証明書管理方針の確認

### Spec Tasks（詳細設計）

- [ ] config/hashing.php の bcrypt rounds を 12 に設定
- [ ] config/session.php の encrypt が true であることを確認
- [ ] Nginx の TLS 設定を確認・調整
- [ ] APP_KEY の適切な生成確認
- [ ] 設定確認テスト作成
- [ ] ドキュメント更新

---

## 参照ドキュメント

- [04_EncryptionPolicy.md](../../../../../../00_docs/20_tech/99_standard/security/04_EncryptionPolicy.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
