# ST-006: セキュリティログの設定

最終更新: 2025-12-26

---

## ストーリー

**セキュリティ担当者として**、セキュリティ関連のイベントを適切にログに記録したい。
**なぜなら**、インシデント発生時の調査と監査対応に必要だからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-007: セキュリティ対策準備](../epic.md) |
| ポイント | 2 |
| 優先度 | Should |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] ログイン成功がログに記録されること
2. [ ] ログイン失敗がログに記録されること
3. [ ] ログアウトがログに記録されること
4. [ ] アカウントロックがログに記録されること
5. [ ] パスワード変更がログに記録されること
6. [ ] セッションタイムアウトがログに記録されること
7. [ ] セキュリティログが専用チャンネルに出力されること
8. [ ] ログに必要な情報（ユーザーID、IP、タイムスタンプ等）が含まれていること

---

## 技術仕様

### ログ記録対象イベント

| イベント | ログレベル | 記録項目 |
|---------|-----------|---------|
| ログイン成功 | INFO | user_id, email, ip, user_agent, timestamp |
| ログイン失敗 | WARNING | email, ip, user_agent, reason, timestamp |
| ログアウト | INFO | user_id, ip, timestamp |
| セッションタイムアウト | INFO | user_id, timeout_type, ip, timestamp |
| アカウントロック | WARNING | user_id, failed_attempts, ip, timestamp |
| パスワード変更 | INFO | user_id, ip, timestamp |
| パスワードリセット要求 | INFO | email, ip, timestamp |
| パスワードリセット完了 | INFO | user_id, ip, timestamp |
| 不審なアクティビティ | WARNING | 詳細情報 |

### ログ保持期間

| ログ種別 | 保持期間 |
|---------|---------|
| 認証成功ログ | 90日 |
| 認証失敗ログ | 180日 |
| パスワード変更ログ | 1年 |
| アカウントロックログ | 1年 |
| 不審なアクティビティログ | 1年 |

### logging.php 設定

```php
// config/logging.php
'channels' => [
    // 既存チャンネル...

    'security' => [
        'driver' => 'daily',
        'path' => storage_path('logs/security.log'),
        'level' => env('LOG_LEVEL', 'info'),
        'days' => 365,  // 1年間保持
        'permission' => 0600,  // オーナーのみ読み書き可能
    ],
],
```

### ログ出力ユーティリティ

```php
// app/Services/SecurityLogService.php
final class SecurityLogService
{
    private const CHANNEL = 'security';

    public function logLoginSuccess(Staff $staff, Request $request): void
    {
        Log::channel(self::CHANNEL)->info('Login successful', [
            'event' => 'login_success',
            'user_id' => $staff->id,
            'email' => $staff->email,
            'ip_address' => $request->ip(),
            'user_agent' => $request->userAgent(),
            'timestamp' => now()->toIso8601String(),
        ]);
    }

    public function logLoginFailure(string $email, Request $request, string $reason): void
    {
        Log::channel(self::CHANNEL)->warning('Login failed', [
            'event' => 'login_failure',
            'email' => $email,
            'ip_address' => $request->ip(),
            'user_agent' => $request->userAgent(),
            'reason' => $reason,
            'timestamp' => now()->toIso8601String(),
        ]);
    }

    public function logLogout(Staff $staff, Request $request): void
    {
        Log::channel(self::CHANNEL)->info('Logout', [
            'event' => 'logout',
            'user_id' => $staff->id,
            'ip_address' => $request->ip(),
            'timestamp' => now()->toIso8601String(),
        ]);
    }

    public function logSessionTimeout(int $userId, string $timeoutType, Request $request): void
    {
        Log::channel(self::CHANNEL)->info('Session timeout', [
            'event' => 'session_timeout',
            'user_id' => $userId,
            'timeout_type' => $timeoutType,
            'ip_address' => $request->ip(),
            'timestamp' => now()->toIso8601String(),
        ]);
    }

    public function logAccountLock(Staff $staff, Request $request): void
    {
        Log::channel(self::CHANNEL)->warning('Account locked', [
            'event' => 'account_lock',
            'user_id' => $staff->id,
            'failed_attempts' => $staff->failed_login_attempts,
            'ip_address' => $request->ip(),
            'timestamp' => now()->toIso8601String(),
        ]);
    }

    public function logPasswordChange(Staff $staff, Request $request): void
    {
        Log::channel(self::CHANNEL)->info('Password changed', [
            'event' => 'password_change',
            'user_id' => $staff->id,
            'ip_address' => $request->ip(),
            'timestamp' => now()->toIso8601String(),
        ]);
    }

    public function logSuspiciousActivity(string $description, array $context, Request $request): void
    {
        Log::channel(self::CHANNEL)->warning('Suspicious activity detected', [
            'event' => 'suspicious_activity',
            'description' => $description,
            'context' => $context,
            'ip_address' => $request->ip(),
            'user_agent' => $request->userAgent(),
            'timestamp' => now()->toIso8601String(),
        ]);
    }
}
```

### ログフォーマット例

```json
{
  "message": "Login successful",
  "context": {
    "event": "login_success",
    "user_id": "01HXYZ123456789ABCDEF",
    "email": "staff@example.com",
    "ip_address": "192.168.1.100",
    "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) ...",
    "timestamp": "2025-12-26T10:30:00+09:00"
  },
  "level": "INFO",
  "level_name": "INFO",
  "channel": "security",
  "datetime": "2025-12-26T10:30:00.123456+09:00"
}
```

### 禁止事項

| 禁止内容 | 理由 |
|---------|------|
| パスワードのログ出力 | 平文パスワードの漏洩防止 |
| 個人情報の過剰な記録 | プライバシー保護 |
| ログの改ざん | 監査証跡の保全 |
| ログの不正な削除 | 証拠隠滅の防止 |

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| logging.php（更新） | backend/config/logging.php |
| SecurityLogService | backend/app/Services/SecurityLogService.php |
| 認証処理への統合 | backend/app/Http/Controllers/Auth/ |
| テストケース | backend/tests/Unit/Services/SecurityLogServiceTest.php |

---

## タスク

### Design Tasks（外部設計）

- [ ] ログ記録対象イベントの最終確認
- [ ] ログ保持期間の確認
- [ ] ログ監視・アラート要件の確認

### Spec Tasks（詳細設計）

- [ ] config/logging.php に security チャンネル追加
- [ ] SecurityLogService 実装
- [ ] 認証処理（login/logout）にログ出力統合
- [ ] セッションタイムアウト処理にログ出力統合
- [ ] アカウントロック処理にログ出力統合
- [ ] 単体テスト作成
- [ ] Feature テスト作成

---

## 将来の拡張

- [ ] SIEM（セキュリティ情報イベント管理）連携
- [ ] リアルタイムアラート設定
- [ ] ログ分析ダッシュボード
- [ ] 異常検知の自動化

---

## 参照ドキュメント

- [04_LoggingDesign.md](../../../../../../00_docs/20_tech/99_standard/backend/04_LoggingDesign.md)
- [05_IncidentResponse.md](../../../../../../00_docs/20_tech/99_standard/security/05_IncidentResponse.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
