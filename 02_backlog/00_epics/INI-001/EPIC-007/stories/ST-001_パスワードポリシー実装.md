# ST-001: パスワードポリシーの実装

最終更新: 2025-12-26

---

## ストーリー

**開発者として**、NIST SP 800-63B に準拠したパスワードポリシーを実装したい。
**なぜなら**、ブルートフォース攻撃や漏洩パスワードの使用からシステムを保護したいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-007: セキュリティ対策準備](../epic.md) |
| ポイント | 3 |
| 優先度 | Must |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] パスワードが12文字以上であること
2. [ ] パスワードに英大文字が1文字以上含まれること
3. [ ] パスワードに英小文字が1文字以上含まれること
4. [ ] パスワードに数字が1文字以上含まれること
5. [ ] パスワードに記号が1文字以上含まれること
6. [ ] Have I Been Pwned API による漏洩チェックが実行されること
7. [ ] 過去5世代のパスワードが再利用禁止されること
8. [ ] バリデーションエラー時に適切な日本語メッセージが表示されること

---

## 技術仕様

### パスワード要件

| 項目 | 設定値 | 根拠 |
|------|--------|------|
| 最小文字数 | 12文字 | NIST SP 800-63B 推奨 |
| 最大文字数 | 128文字 | 過度な制限回避 |
| 英大文字 | 1文字以上必須 | 複雑性向上 |
| 英小文字 | 1文字以上必須 | 複雑性向上 |
| 数字 | 1文字以上必須 | 複雑性向上 |
| 記号 | 1文字以上必須 | 複雑性向上 |
| 漏洩チェック | Have I Been Pwned API | 既知の漏洩パスワード排除 |
| 履歴 | 過去5世代 | 再利用防止 |

### Laravel Password Defaults 設定

```php
// app/Providers/AuthServiceProvider.php
use Illuminate\Validation\Rules\Password;

public function boot(): void
{
    Password::defaults(function () {
        return Password::min(12)
            ->letters()
            ->mixedCase()
            ->numbers()
            ->symbols()
            ->uncompromised();
    });
}
```

### パスワード履歴テーブル

```php
// database/migrations/xxxx_create_password_histories_table.php
Schema::create('password_histories', function (Blueprint $table) {
    $table->id();
    $table->foreignId('staff_id')->constrained()->onDelete('cascade');
    $table->string('password_hash');
    $table->timestamp('created_at');

    $table->index(['staff_id', 'created_at']);
});
```

### パスワード履歴チェックサービス

```php
// app/Services/PasswordHistoryService.php
final class PasswordHistoryService
{
    private const HISTORY_LIMIT = 5;

    public function isPasswordReused(Staff $staff, string $newPassword): bool
    {
        $histories = PasswordHistory::where('staff_id', $staff->id)
            ->orderBy('created_at', 'desc')
            ->limit(self::HISTORY_LIMIT)
            ->get();

        foreach ($histories as $history) {
            if (Hash::check($newPassword, $history->password_hash)) {
                return true;
            }
        }

        return false;
    }

    public function addToHistory(Staff $staff, string $hashedPassword): void
    {
        PasswordHistory::create([
            'staff_id' => $staff->id,
            'password_hash' => $hashedPassword,
        ]);

        // 古い履歴を削除
        PasswordHistory::where('staff_id', $staff->id)
            ->orderBy('created_at', 'desc')
            ->skip(self::HISTORY_LIMIT)
            ->take(PHP_INT_MAX)
            ->delete();
    }
}
```

### バリデーションメッセージ

| 条件 | メッセージ |
|------|-----------|
| 最小文字数 | パスワードは12文字以上で入力してください |
| 英字必須 | パスワードには英字を含めてください |
| 大小文字 | パスワードには大文字と小文字の両方を含めてください |
| 数字必須 | パスワードには数字を含めてください |
| 記号必須 | パスワードには記号を含めてください |
| 漏洩検知 | このパスワードは過去に漏洩が確認されています。別のパスワードを使用してください |
| 履歴重複 | 過去に使用したパスワードは再利用できません |

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| AuthServiceProvider（更新） | backend/app/Providers/AuthServiceProvider.php |
| PasswordHistoryService | backend/app/Services/PasswordHistoryService.php |
| PasswordHistory モデル | backend/app/Models/PasswordHistory.php |
| マイグレーション | backend/database/migrations/xxxx_create_password_histories_table.php |
| テストケース | backend/tests/Unit/Services/PasswordHistoryServiceTest.php |

---

## タスク

### Design Tasks（外部設計）

- [ ] パスワード要件の最終確認
- [ ] バリデーションメッセージの日本語化確認
- [ ] フロントエンドへの要件伝達

### Spec Tasks（詳細設計）

- [ ] AuthServiceProvider に Password::defaults() 設定
- [ ] password_histories テーブルのマイグレーション作成
- [ ] PasswordHistory モデル作成
- [ ] PasswordHistoryService 実装
- [ ] パスワード変更時のバリデーション統合
- [ ] 単体テスト作成
- [ ] Feature テスト作成

---

## 参照ドキュメント

- [01_PasswordPolicy.md](../../../../../../00_docs/20_tech/99_standard/security/01_PasswordPolicy.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
