# ST-004: セキュリティスキャンの設定

最終更新: 2025-12-26

---

## ストーリー

**開発者として**、CI/CD パイプラインでセキュリティスキャンを自動実行したい。
**なぜなら**、脆弱性を早期に発見し、安全なコードをリリースしたいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-007: セキュリティ対策準備](../epic.md) |
| ポイント | 3 |
| 優先度 | Must |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] `composer audit` が CI/CD で実行されること
2. [ ] `npm audit` が CI/CD で実行されること
3. [ ] PHPStan/Larastan による静的解析が実行されること
4. [ ] Critical/High 脆弱性がある場合にビルドが失敗すること
5. [ ] スキャン結果がレポートとして保存されること
6. [ ] Makefile でローカルスキャンが実行可能なこと
7. [ ] OWASP ZAP による週次スキャンのドキュメントが作成されていること

---

## 技術仕様

### スキャンツール一覧

| ツール | 対象 | 実行タイミング | 失敗条件 |
|-------|------|---------------|---------|
| composer audit | PHP 依存関係 | CI/CD 毎 | Critical/High 脆弱性 |
| npm audit | JS 依存関係 | CI/CD 毎 | Critical/High 脆弱性 |
| PHPStan/Larastan | PHP コード | CI/CD 毎 | Level 5 以上のエラー |
| OWASP ZAP | 実行中アプリ | 週次（手動） | Critical 発見時 |

### GitHub Actions ワークフロー

```yaml
# .github/workflows/security.yml
name: Security Scan

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]
  schedule:
    - cron: '0 0 * * 0'  # 毎週日曜 00:00

jobs:
  php-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'

      - name: Install Dependencies
        run: composer install --no-dev --prefer-dist
        working-directory: backend

      - name: Composer Audit
        run: composer audit --format=json > ../reports/security/composer-audit.json
        working-directory: backend
        continue-on-error: true

      - name: Check Composer Audit Results
        run: |
          if grep -q '"severity": "high"\|"severity": "critical"' reports/security/composer-audit.json; then
            echo "Critical or High severity vulnerabilities found!"
            exit 1
          fi

      - name: Upload Audit Report
        uses: actions/upload-artifact@v4
        with:
          name: composer-audit-report
          path: reports/security/composer-audit.json

  js-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci
        working-directory: frontend

      - name: NPM Audit
        run: npm audit --json > ../reports/security/npm-audit.json || true
        working-directory: frontend

      - name: Check NPM Audit Results
        run: |
          if npm audit --audit-level=high 2>&1 | grep -q "found"; then
            echo "High or Critical severity vulnerabilities found!"
            exit 1
          fi
        working-directory: frontend

      - name: Upload Audit Report
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: reports/security/npm-audit.json

  static-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'

      - name: Install Dependencies
        run: composer install --prefer-dist
        working-directory: backend

      - name: Run PHPStan
        run: vendor/bin/phpstan analyse --error-format=json > ../reports/security/phpstan-report.json || true
        working-directory: backend

      - name: Check PHPStan Results
        run: |
          ERRORS=$(cat reports/security/phpstan-report.json | jq '.totals.file_errors')
          if [ "$ERRORS" -gt 0 ]; then
            echo "PHPStan found $ERRORS errors!"
            exit 1
          fi

      - name: Upload PHPStan Report
        uses: actions/upload-artifact@v4
        with:
          name: phpstan-report
          path: reports/security/phpstan-report.json
```

### Makefile コマンド

```makefile
# Makefile
.PHONY: security-scan audit-php audit-js phpstan

security-scan: audit-php audit-js phpstan
	@echo "All security scans completed"

audit-php:
	@echo "Running Composer Audit..."
	@docker compose exec backend composer audit

audit-js:
	@echo "Running NPM Audit..."
	@docker compose exec frontend npm audit

phpstan:
	@echo "Running PHPStan..."
	@docker compose exec backend vendor/bin/phpstan analyse

security-report:
	@mkdir -p reports/security
	@docker compose exec backend composer audit --format=json > reports/security/composer-audit.json || true
	@docker compose exec frontend npm audit --json > reports/security/npm-audit.json || true
	@docker compose exec backend vendor/bin/phpstan analyse --error-format=json > reports/security/phpstan.json || true
	@echo "Reports generated in reports/security/"
```

### レポート出力先

```
reports/
└── security/
    ├── composer-audit.json    # PHP 依存関係脆弱性
    ├── npm-audit.json         # JS 依存関係脆弱性
    ├── phpstan.json           # 静的解析結果
    └── zap-report.html        # OWASP ZAP スキャン結果（週次）
```

### 脆弱性対応 SLA

| 重大度 | 対応期限 | 対応内容 |
|--------|---------|---------|
| Critical | 24時間以内 | 即時パッチまたはワークアラウンド |
| High | 72時間以内 | パッチ適用またはバージョンアップ |
| Medium | 2週間以内 | 次回リリースで対応 |
| Low | 1ヶ月以内 | 優先度に応じて対応 |

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| GitHub Actions ワークフロー | .github/workflows/security.yml |
| Makefile（更新） | Makefile |
| レポート出力先 | reports/security/ |
| OWASP ZAP 手順書 | 00_docs/20_tech/99_standard/security/08_SecurityScanning.md |

---

## タスク

### Design Tasks（外部設計）

- [ ] スキャン頻度の確認
- [ ] 脆弱性対応 SLA の確認
- [ ] レポート共有方法の検討

### Spec Tasks（詳細設計）

- [ ] .github/workflows/security.yml 作成
- [ ] Makefile にセキュリティスキャンコマンド追加
- [ ] reports/security/ ディレクトリ作成
- [ ] .gitignore に reports/ 追加
- [ ] OWASP ZAP スキャン手順をドキュメント化
- [ ] CI/CD パイプラインテスト

---

## 参照ドキュメント

- [08_SecurityScanning.md](../../../../../../00_docs/20_tech/99_standard/security/08_SecurityScanning.md)
- [06_VulnerabilityManagement.md](../../../../../../00_docs/20_tech/99_standard/security/06_VulnerabilityManagement.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
