# ST-005: 依存関係の脆弱性対応

最終更新: 2025-12-26

---

## ストーリー

**開発者として**、依存パッケージの脆弱性を特定し対応したい。
**なぜなら**、サードパーティライブラリの脆弱性がシステム全体のセキュリティリスクになるからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-007: セキュリティ対策準備](../epic.md) |
| ポイント | 2 |
| 優先度 | Should |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] `composer audit` で Critical/High 脆弱性がないこと
2. [ ] `npm audit` で Critical/High 脆弱性がないこと
3. [ ] 脆弱性対応の判断基準が文書化されていること
4. [ ] 脆弱性が検出された場合の対応手順が明確であること
5. [ ] composer.lock と package-lock.json が最新であること
6. [ ] Dependabot または Renovate が設定されていること

---

## 技術仕様

### 脆弱性スキャンコマンド

| ツール | コマンド | 対象 |
|--------|---------|------|
| Composer Audit | `composer audit` | PHP パッケージ |
| NPM Audit | `npm audit` | JavaScript パッケージ |
| Composer Outdated | `composer outdated` | 古いパッケージ確認 |
| NPM Outdated | `npm outdated` | 古いパッケージ確認 |

### 脆弱性対応判断基準

| 重大度 | CVSS スコア | 対応方針 |
|--------|------------|---------|
| Critical | 9.0-10.0 | 即時対応必須。24時間以内にパッチまたはワークアラウンド |
| High | 7.0-8.9 | 72時間以内に対応。バージョンアップまたは代替策 |
| Medium | 4.0-6.9 | 2週間以内に対応。計画的なアップデート |
| Low | 0.1-3.9 | 1ヶ月以内に対応。通常のメンテナンスサイクルで |

### 対応オプション

| オプション | 説明 | 使用場面 |
|-----------|------|---------|
| パッケージ更新 | 脆弱性が修正されたバージョンへアップデート | 推奨 |
| パッチ適用 | 個別のセキュリティパッチを適用 | 更新が困難な場合 |
| 代替パッケージ | 別のパッケージに置き換え | メンテナンス停止時 |
| 緩和策 | WAF 設定やコード修正で影響を軽減 | 更新不可時の一時対策 |
| リスク受容 | 低リスクの場合に文書化して受容 | 影響が限定的な場合 |

### Dependabot 設定

```yaml
# .github/dependabot.yml
version: 2
updates:
  # PHP (Composer)
  - package-ecosystem: "composer"
    directory: "/backend"
    schedule:
      interval: "weekly"
      day: "monday"
    open-pull-requests-limit: 10
    labels:
      - "dependencies"
      - "security"
    commit-message:
      prefix: "chore(deps)"

  # JavaScript (npm)
  - package-ecosystem: "npm"
    directory: "/frontend"
    schedule:
      interval: "weekly"
      day: "monday"
    open-pull-requests-limit: 10
    labels:
      - "dependencies"
      - "security"
    commit-message:
      prefix: "chore(deps)"

  # GitHub Actions
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
    labels:
      - "dependencies"
      - "ci"
```

### 脆弱性対応フロー

```
脆弱性検出
    │
    ▼
重大度評価
    │
    ├─ Critical/High ─→ 即時エスカレーション
    │                        │
    │                        ▼
    │                   緊急対応チーム招集
    │                        │
    │                        ▼
    │                   パッチ/更新適用
    │                        │
    │                        ▼
    │                   検証・デプロイ
    │
    ├─ Medium ─→ 次スプリントで対応
    │
    └─ Low ─→ バックログに追加
```

### 脆弱性管理チェックリスト

```markdown
## 脆弱性対応チェックリスト

### 発見時
- [ ] 脆弱性 ID（CVE 番号等）を記録
- [ ] 影響を受けるパッケージとバージョンを特定
- [ ] CVSS スコアと重大度を確認
- [ ] 本システムへの影響範囲を評価

### 対応時
- [ ] 対応方針を決定（更新/パッチ/緩和策/受容）
- [ ] 対応担当者をアサイン
- [ ] 対応期限を設定
- [ ] テスト計画を作成

### 完了時
- [ ] 対応を実施
- [ ] テストを実行
- [ ] 脆弱性スキャンで解消を確認
- [ ] 対応内容を文書化
```

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| Dependabot 設定 | .github/dependabot.yml |
| 脆弱性対応手順書 | 00_docs/20_tech/99_standard/security/06_VulnerabilityManagement.md |
| 初回スキャンレポート | reports/security/initial-audit-report.md |

---

## タスク

### Design Tasks（外部設計）

- [ ] 脆弱性対応 SLA の最終確認
- [ ] エスカレーションフローの確認
- [ ] Dependabot マージポリシーの検討

### Spec Tasks（詳細設計）

- [ ] `composer audit` を実行して現状確認
- [ ] `npm audit` を実行して現状確認
- [ ] Critical/High 脆弱性があれば対応
- [ ] .github/dependabot.yml 作成
- [ ] 初回スキャンレポートを作成
- [ ] ドキュメント更新

---

## 参照ドキュメント

- [06_VulnerabilityManagement.md](../../../../../../00_docs/20_tech/99_standard/security/06_VulnerabilityManagement.md)
- [07_ThirdPartySecurity.md](../../../../../../00_docs/20_tech/99_standard/security/07_ThirdPartySecurity.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
