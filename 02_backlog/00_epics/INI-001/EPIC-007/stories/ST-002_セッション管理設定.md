# ST-002: セッション管理の設定

最終更新: 2025-12-26

---

## ストーリー

**開発者として**、適切なセッション管理を設定したい。
**なぜなら**、セッションハイジャックやなりすまし攻撃からユーザーを保護したいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-007: セキュリティ対策準備](../epic.md) |
| ポイント | 3 |
| 優先度 | Must |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] アイドルタイムアウトが30分に設定されていること
2. [ ] 絶対タイムアウトが8時間に設定されていること
3. [ ] Cookie に Secure 属性が設定されていること
4. [ ] Cookie に HttpOnly 属性が設定されていること
5. [ ] Cookie に SameSite=Lax が設定されていること
6. [ ] 同時ログインが最大3台（管理者は1台）に制限されていること
7. [ ] ログイン時にセッションIDが再生成されること
8. [ ] タイムアウト時に適切なエラーメッセージが返されること

---

## 技術仕様

### タイムアウト設定

| 種別 | 設定値 | 説明 |
|------|--------|------|
| アイドルタイムアウト | 30分 | 最後の操作から無操作が続いた場合 |
| 絶対タイムアウト | 8時間 | セッション開始からの最大有効期間 |
| Remember Me | 14日 | 永続ログイン時の最大期間 |

### アカウント種別による調整

| アカウント種別 | アイドル | 絶対 | 同時ログイン |
|---------------|:--------:|:----:|:------------:|
| 一般スタッフ | 30分 | 8時間 | 最大3台 |
| 管理者 | 15分 | 4時間 | 最大1台 |

### セッション設定

```php
// config/session.php
return [
    'driver' => 'database',
    'lifetime' => 480,  // 8時間（分）
    'expire_on_close' => false,
    'encrypt' => true,
    'cookie' => 'app_session',
    'path' => '/',
    'domain' => env('SESSION_DOMAIN'),
    'secure' => true,
    'http_only' => true,
    'same_site' => 'lax',
];
```

### セッションタイムアウトミドルウェア

```php
// app/Http/Middleware/SessionTimeout.php
class SessionTimeout
{
    private const IDLE_TIMEOUT = 30 * 60;         // 30分（秒）
    private const ABSOLUTE_TIMEOUT = 8 * 60 * 60; // 8時間（秒）

    public function handle(Request $request, Closure $next): Response
    {
        if (Auth::check()) {
            $lastActivity = session('last_activity');
            $sessionStart = session('session_start');
            $now = time();

            // アイドルタイムアウトチェック
            if ($lastActivity && ($now - $lastActivity) > self::IDLE_TIMEOUT) {
                return $this->terminateSession($request, 'idle_timeout');
            }

            // 絶対タイムアウトチェック
            if ($sessionStart && ($now - $sessionStart) > self::ABSOLUTE_TIMEOUT) {
                return $this->terminateSession($request, 'absolute_timeout');
            }

            session(['last_activity' => $now]);
        }

        return $next($request);
    }

    private function terminateSession(Request $request, string $reason): Response
    {
        Log::channel('security')->info('Session terminated', [
            'user_id' => Auth::id(),
            'reason' => $reason,
            'ip' => $request->ip(),
        ]);

        Auth::logout();
        $request->session()->invalidate();
        $request->session()->regenerateToken();

        return response()->json([
            'message' => 'セッションがタイムアウトしました。再度ログインしてください。',
            'code' => 'SESSION_TIMEOUT',
        ], 401);
    }
}
```

### 同時ログイン制御サービス

```php
// app/Services/SessionManagerService.php
class SessionManagerService
{
    private const MAX_SESSIONS_STAFF = 3;
    private const MAX_SESSIONS_ADMIN = 1;

    public function enforceSessionLimit(Staff $staff): void
    {
        $maxSessions = $staff->isAdmin()
            ? self::MAX_SESSIONS_ADMIN
            : self::MAX_SESSIONS_STAFF;

        $activeSessions = DB::table('sessions')
            ->where('user_id', $staff->id)
            ->orderBy('last_activity', 'desc')
            ->get();

        if ($activeSessions->count() >= $maxSessions) {
            $sessionsToDelete = $activeSessions->slice($maxSessions - 1);

            foreach ($sessionsToDelete as $session) {
                DB::table('sessions')->where('id', $session->id)->delete();

                Log::channel('security')->info('Session terminated due to limit', [
                    'user_id' => $staff->id,
                    'session_id' => $session->id,
                    'reason' => 'concurrent_session_limit',
                ]);
            }
        }
    }
}
```

### エラーメッセージ

| 状況 | メッセージ |
|------|-----------|
| アイドルタイムアウト | セッションがタイムアウトしました。再度ログインしてください。 |
| 絶対タイムアウト | セッションがタイムアウトしました。再度ログインしてください。 |
| 同時ログイン超過 | 他のデバイスからのログインにより、このセッションは無効になりました。 |

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| session.php（更新） | backend/config/session.php |
| SessionTimeout ミドルウェア | backend/app/Http/Middleware/SessionTimeout.php |
| SessionManagerService | backend/app/Services/SessionManagerService.php |
| セッションテーブルマイグレーション | backend/database/migrations/xxxx_create_sessions_table.php |
| テストケース | backend/tests/Unit/Middleware/SessionTimeoutTest.php |

---

## タスク

### Design Tasks（外部設計）

- [ ] タイムアウト値の最終確認
- [ ] 同時ログイン数の確認
- [ ] フロントエンドへのタイムアウト通知方式検討

### Spec Tasks（詳細設計）

- [ ] config/session.php の設定更新
- [ ] SessionTimeout ミドルウェア実装
- [ ] SessionManagerService 実装
- [ ] Kernel.php へのミドルウェア登録
- [ ] ログイン処理にセッション制御を統合
- [ ] 単体テスト作成
- [ ] Feature テスト作成

---

## 参照ドキュメント

- [02_SessionManagement.md](../../../../../../00_docs/20_tech/99_standard/security/02_SessionManagement.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
