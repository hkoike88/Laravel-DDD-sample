# ST-003: 利用者番号自動採番機能の実装

最終更新: 2025-12-26

---

## ストーリー

**システムとして**、利用者番号を自動採番したい。
**なぜなら**、重複や採番ミスを防止し、一意な利用者番号を確実に発行したいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-008: 利用者アカウント登録機能](../epic.md) |
| ポイント | 2 |
| 優先度 | Must |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] 利用者登録時に利用者番号が自動採番されること
2. [ ] 利用者番号の形式が `P{年度}{連番6桁}` であること（例: P2025000001）
3. [ ] 連番は年度をまたいでもリセットされないこと
4. [ ] 同時登録時に重複が発生しないこと（排他制御）
5. [ ] 採番された番号は変更不可であること

---

## 技術仕様

### 利用者番号形式

| 項目 | 仕様 |
|------|------|
| プレフィックス | `P`（Patron の頭文字） |
| 年度 | 4桁（登録時の西暦年） |
| 連番 | 6桁（ゼロ埋め） |
| 例 | `P2025000001`, `P2025000002` |
| 最大値 | `P9999999999`（約100万件/年で100年分） |

### 採番テーブル

```php
// database/migrations/xxxx_create_patron_number_sequences_table.php
Schema::create('patron_number_sequences', function (Blueprint $table) {
    $table->id();
    $table->unsignedInteger('current_number')->default(0);
    $table->timestamp('updated_at');

    // 1行のみ保持
});
```

### PatronNumberGenerator 実装

```php
// packages/Domain/Patron/Infrastructure/PatronNumberGenerator.php
final class PatronNumberGenerator implements PatronNumberGeneratorInterface
{
    public function generate(): PatronNumber
    {
        $year = (int) date('Y');

        // 排他制御付きで採番
        $sequence = DB::transaction(function () {
            $sequence = PatronNumberSequence::lockForUpdate()->first();

            if ($sequence === null) {
                $sequence = PatronNumberSequence::create(['current_number' => 0]);
            }

            $sequence->increment('current_number');

            return $sequence;
        });

        $number = sprintf('P%04d%06d', $year, $sequence->current_number);

        return new PatronNumber($number);
    }
}
```

### PatronNumber 値オブジェクト

```php
// packages/Domain/Patron/PatronNumber.php
final class PatronNumber
{
    private const PATTERN = '/^P\d{10}$/';

    public function __construct(
        private readonly string $value,
    ) {
        if (!preg_match(self::PATTERN, $value)) {
            throw new InvalidArgumentException(
                '利用者番号の形式が不正です: ' . $value
            );
        }
    }

    public function value(): string
    {
        return $this->value;
    }

    public function year(): int
    {
        return (int) substr($this->value, 1, 4);
    }

    public function sequenceNumber(): int
    {
        return (int) substr($this->value, 5);
    }

    public function equals(PatronNumber $other): bool
    {
        return $this->value === $other->value;
    }

    public function __toString(): string
    {
        return $this->value;
    }
}
```

### インターフェース定義

```php
// packages/Domain/Patron/PatronNumberGeneratorInterface.php
interface PatronNumberGeneratorInterface
{
    public function generate(): PatronNumber;
}
```

### サービスプロバイダ登録

```php
// app/Providers/AppServiceProvider.php
public function register(): void
{
    $this->app->bind(
        PatronNumberGeneratorInterface::class,
        PatronNumberGenerator::class
    );
}
```

### 排他制御の考慮事項

- `lockForUpdate()` による悲観的ロックを使用
- トランザクション内で採番とインクリメントを実行
- 同時リクエスト時の重複を防止
- デッドロック対策として短いトランザクションを維持

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| PatronNumber | backend/packages/Domain/Patron/PatronNumber.php |
| PatronNumberGeneratorInterface | backend/packages/Domain/Patron/PatronNumberGeneratorInterface.php |
| PatronNumberGenerator | backend/packages/Domain/Patron/Infrastructure/PatronNumberGenerator.php |
| PatronNumberSequence モデル | backend/app/Models/PatronNumberSequence.php |
| マイグレーション | backend/database/migrations/xxxx_create_patron_number_sequences_table.php |
| 単体テスト | backend/tests/Unit/Domain/Patron/PatronNumberTest.php |
| 結合テスト | backend/tests/Feature/Patron/PatronNumberGeneratorTest.php |

---

## タスク

### Design Tasks（外部設計）

- [ ] 利用者番号形式の最終確認
- [ ] 採番ルールの確認（年度リセット有無）

### Spec Tasks（詳細設計）

- [ ] PatronNumber 値オブジェクト実装
- [ ] PatronNumberGeneratorInterface 定義
- [ ] PatronNumberGenerator 実装
- [ ] PatronNumberSequence モデル作成
- [ ] マイグレーション作成
- [ ] サービスプロバイダ登録
- [ ] 排他制御テスト作成
- [ ] 単体テスト作成

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
