# ST-004: 貸出カード印刷機能の実装

最終更新: 2025-12-26

---

## ストーリー

**図書館職員として**、利用者の貸出カードを印刷したい。
**なぜなら**、利用者に貸出カードを発行して図書貸出サービスを利用できるようにしたいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-008: 利用者アカウント登録機能](../epic.md) |
| ポイント | 3 |
| 優先度 | Should |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] 利用者詳細画面から「カード印刷」ボタンで印刷画面を開けること
2. [ ] 印刷プレビューに利用者番号、氏名、有効期限が表示されること
3. [ ] バーコード（利用者番号）が印刷されること
4. [ ] 印刷ボタンでブラウザの印刷ダイアログが開くこと
5. [ ] 複数枚印刷に対応すること
6. [ ] 印刷操作がログに記録されること

---

## 画面仕様

### 貸出カード印刷プレビュー

```
┌─────────────────────────────────────────────────────────────┐
│  貸出カード印刷                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  印刷枚数: [1] 枚                                           │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ╔═══════════════════════════════════════════════╗  │   │
│  │  ║                                               ║  │   │
│  │  ║    ○○市立図書館                              ║  │   │
│  │  ║                                               ║  │   │
│  │  ║    利用者カード                               ║  │   │
│  │  ║                                               ║  │   │
│  │  ║    ┃┃┃┃┃┃┃┃┃┃┃┃┃┃┃┃┃┃┃┃┃┃         ║  │   │
│  │  ║    P2025000001                                ║  │   │
│  │  ║                                               ║  │   │
│  │  ║    山田 太郎 様                               ║  │   │
│  │  ║                                               ║  │   │
│  │  ║    有効期限: 2026年12月26日                   ║  │   │
│  │  ║                                               ║  │   │
│  │  ╚═══════════════════════════════════════════════╝  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│                              [キャンセル]  [印刷]           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### カードサイズ

- サイズ: 85.6mm × 54mm（クレジットカードサイズ）
- バーコード形式: CODE128

---

## 技術仕様

### コンポーネント構成

```
PatronCardPrintPage
├── PageHeader
├── PrintSettings
│   └── CopiesInput
├── CardPreview
│   ├── LibraryName
│   ├── CardTitle
│   ├── Barcode
│   ├── PatronName
│   └── ExpiryDate
└── PrintActions
    ├── CancelButton
    └── PrintButton
```

### バーコード生成

```typescript
// PatronBarcode.tsx
import JsBarcode from 'jsbarcode';

export const PatronBarcode: React.FC<{ patronNumber: string }> = ({
  patronNumber,
}) => {
  const barcodeRef = useRef<SVGSVGElement>(null);

  useEffect(() => {
    if (barcodeRef.current) {
      JsBarcode(barcodeRef.current, patronNumber, {
        format: 'CODE128',
        width: 2,
        height: 40,
        displayValue: true,
        fontSize: 12,
        margin: 10,
      });
    }
  }, [patronNumber]);

  return <svg ref={barcodeRef} />;
};
```

### 印刷用スタイル

```css
/* print.css */
@media print {
  @page {
    size: 85.6mm 54mm;
    margin: 0;
  }

  .patron-card {
    width: 85.6mm;
    height: 54mm;
    page-break-after: always;
    border: 1px solid #000;
    padding: 5mm;
    box-sizing: border-box;
  }

  .no-print {
    display: none !important;
  }
}
```

### usePrintCard Hook

```typescript
// usePrintCard.ts
export const usePrintCard = (patron: Patron) => {
  const [copies, setCopies] = useState(1);

  const handlePrint = () => {
    // 印刷ログ記録
    patronApi.logPrint(patron.id, copies);
    window.print();
  };

  return {
    copies,
    setCopies,
    handlePrint,
  };
};
```

### CardPreview コンポーネント

```tsx
// CardPreview.tsx
export const CardPreview: React.FC<CardPreviewProps> = ({
  patron,
  copies,
}) => {
  const cards = Array.from({ length: copies }, (_, i) => i);

  return (
    <div className="card-preview">
      {cards.map((index) => (
        <div key={index} className="patron-card">
          <div className="library-name">○○市立図書館</div>
          <div className="card-title">利用者カード</div>
          <PatronBarcode patronNumber={patron.patronNumber} />
          <div className="patron-name">{patron.name} 様</div>
          <div className="expiry-date">
            有効期限: {formatDate(patron.expiresAt)}
          </div>
        </div>
      ))}
    </div>
  );
};
```

### 印刷ログ API

```php
// POST /api/patrons/{id}/print-log
public function logPrint(Request $request, string $id): JsonResponse
{
    $this->logger->channel('audit')->info('貸出カードを印刷しました', [
        'patron_id' => $id,
        'copies' => $request->copies,
        'printed_by' => auth()->id(),
    ]);

    return response()->json(['message' => 'ok']);
}
```

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| PatronCardPrintPage | frontend/src/pages/staff/patrons/PatronCardPrintPage.tsx |
| CardPreview | frontend/src/features/patron/components/CardPreview.tsx |
| PatronBarcode | frontend/src/features/patron/components/PatronBarcode.tsx |
| usePrintCard | frontend/src/features/patron/hooks/usePrintCard.ts |
| 印刷用CSS | frontend/src/features/patron/styles/print.css |
| テスト | frontend/src/features/patron/__tests__/ |

---

## タスク

### Design Tasks（外部設計）

- [ ] カードデザインの確定
- [ ] バーコード形式の確認
- [ ] 印刷用紙サイズの確認

### Spec Tasks（詳細設計）

- [ ] jsbarcode パッケージ追加
- [ ] PatronBarcode コンポーネント実装
- [ ] CardPreview コンポーネント実装
- [ ] 印刷用 CSS 実装
- [ ] usePrintCard フック実装
- [ ] PatronCardPrintPage 実装
- [ ] 印刷ログ API 実装
- [ ] ルーティング設定
- [ ] コンポーネントテスト作成

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
