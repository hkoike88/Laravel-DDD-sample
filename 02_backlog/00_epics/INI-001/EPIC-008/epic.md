# EPIC-008: 利用者アカウント登録機能

最終更新: 2025-12-26

---

## 概要

図書館職員が新規利用者の情報を登録し、貸出カードを発行する機能を実装する。本人確認情報を入力し、利用者番号を自動採番してシステムに登録する。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| イニシアチブ | [INI-001: 認証・利用者管理基盤](../../../../01_vision/initiatives/INI-001/charter.md) |
| Use Case | [UC-001-008: 利用者アカウント登録](../../../../01_vision/initiatives/INI-001/usecases/UC-001-008_利用者アカウント登録.md) |
| 優先度 | Must |
| ステータス | Planned |

---

## ビジネス価値

利用者を効率的に登録し、図書貸出サービスを利用可能にする。利用者番号の自動採番により、重複や採番ミスを防止する。

---

## 受け入れ条件

1. 職員が利用者情報を入力して登録できること
2. 利用者番号が自動採番されること
3. 有効期限が登録日から1年間で設定されること
4. 未成年者（小学生以下）は保護者情報が必須であること
5. 市外在住者は通勤・通学先の入力が必要であること
6. 登録操作が監査ログに記録されること
7. 個人情報が暗号化して保存されること
8. 貸出カード印刷が可能であること

---

## 画面一覧

| 画面ID | 画面名 | パス | 説明 |
|--------|--------|------|------|
| SCR-001-010 | 利用者管理 | `/staff/patrons` | 利用者一覧表示 |
| SCR-001-011 | 利用者登録 | `/staff/patrons/new` | 新規利用者登録フォーム |
| SCR-001-012 | 利用者詳細 | `/staff/patrons/{id}` | 登録完了後の詳細表示 |

---

## User Story 一覧

| ID | Story 名 | ポイント | 優先度 | ステータス |
|----|----------|---------|--------|----------|
| [ST-001](./stories/ST-001_利用者アカウント登録API実装.md) | 利用者アカウント登録 API の実装 | 5 | Must | Planned |
| [ST-002](./stories/ST-002_利用者アカウント登録UI実装.md) | 利用者アカウント登録 UI の実装 | 3 | Must | Planned |
| [ST-003](./stories/ST-003_利用者番号自動採番実装.md) | 利用者番号自動採番機能の実装 | 2 | Must | Planned |
| [ST-004](./stories/ST-004_貸出カード印刷機能実装.md) | 貸出カード印刷機能の実装 | 3 | Should | Planned |

---

## 成果物

| 成果物 | 配置場所 | 説明 |
|--------|---------|------|
| Patron エンティティ | backend/packages/Domain/Patron/ | 利用者ドメインモデル |
| CreatePatronHandler | backend/packages/Domain/Patron/Application/UseCases/Commands/CreatePatron/ | 利用者登録処理 |
| PatronController | backend/app/Http/Controllers/Patron/ | 利用者 API エンドポイント |
| PatronRegistrationForm | frontend/src/features/patron/components/ | 利用者登録フォーム |

---

## 技術仕様

### API エンドポイント

| メソッド | エンドポイント | 説明 | 認証 | 権限 |
|----------|---------------|------|------|------|
| POST | `/api/patrons` | 利用者登録 | 必須 | 職員 |
| GET | `/api/patrons/{id}` | 利用者詳細取得 | 必須 | 職員 |

### リクエスト/レスポンス

#### POST /api/patrons

**リクエスト:**
```json
{
  "name": "山田 太郎",
  "nameKana": "やまだ たろう",
  "birthDate": "1990-05-15",
  "address": "〒123-4567 東京都○○区...",
  "phoneNumber": "090-1234-5678",
  "patronType": "general",
  "notes": ""
}
```

**成功レスポンス (201):**
```json
{
  "message": "利用者を登録しました",
  "patron": {
    "id": "01HV...",
    "patronNumber": "P2025000001",
    "name": "山田 太郎",
    "nameKana": "やまだ たろう",
    "patronType": "general",
    "expiresAt": "2026-12-26",
    "isActive": true
  }
}
```

**バリデーションエラーレスポンス (422):**
```json
{
  "message": "入力内容に誤りがあります",
  "errors": {
    "name": ["氏名を入力してください"],
    "birthDate": ["生年月日を入力してください"]
  }
}
```

### 利用者区分

| コード | 区分名 | 説明 |
|--------|--------|------|
| general | 一般 | 成人利用者 |
| student | 学生 | 中学生〜大学生 |
| child | 児童 | 小学生以下 |

### 利用者番号採番ルール

- 形式: `P{年度}{連番6桁}`
- 例: `P2025000001`
- 年度ごとにリセットせず、通し番号

---

## 依存関係

### 前提条件

| Epic ID | Epic 名 | 関係 |
|---------|---------|------|
| EPIC-001 | 職員ログイン機能 | 認証機能が完了していること |
| EPIC-002 | 職員ダッシュボード機能 | ダッシュボードから遷移 |

### 後続タスク

| Epic ID | Epic 名 | 関係 |
|---------|---------|------|
| EPIC-009 | 利用者アカウント編集機能 | 登録後の編集 |
| EPIC-010 | 利用者アカウント無効化機能 | 登録後の無効化 |
| EPIC-011 | 利用者検索機能 | 登録済み利用者の検索 |

---

## 非機能要件

| 項目 | 要件 |
|------|------|
| パフォーマンス | 登録処理は3秒以内に完了する |
| セキュリティ | 個人情報は暗号化して保存（AES-256-GCM） |
| 監査 | 登録操作を audit チャンネルに記録 |
| データ保持 | 個人情報保護法に準拠した管理 |

---

## ビジネスルール

| ルールID | ルール内容 |
|----------|-----------|
| BR-UC001-08-01 | 登録対象は市内在住・在勤・在学者 |
| BR-UC001-08-02 | 有効期限は登録日から1年間 |
| BR-UC001-08-03 | 利用者番号は連番で自動採番する |
| BR-UC001-08-04 | 未成年者（小学生以下）は保護者情報を必須とする |
| BR-UC001-08-05 | 市外在住者は通勤・通学先の確認が必要 |

---

## 関連ドキュメント

- [UC-001-008: 利用者アカウント登録](../../../../01_vision/initiatives/INI-001/usecases/UC-001-008_利用者アカウント登録.md)
- [利用者登録・管理業務フロー（AS-IS）](../../../../00_docs/10_business/asis/swimlane/user-registration-process.md)
- [セキュリティ標準 - データ分類・保護ポリシー](../../../../00_docs/20_tech/99_standard/security/03_DataClassification.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
