# ST-003: 利用者一覧表示機能の実装

最終更新: 2025-12-26

---

## ストーリー

**図書館職員として**、検索結果の利用者一覧を見たい。
**なぜなら**、対象の利用者を選択して詳細情報にアクセスしたいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-011: 利用者検索機能](../epic.md) |
| ポイント | 2 |
| 優先度 | Must |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] 検索結果が表形式で表示されること
2. [ ] 利用者番号、氏名、ふりがな、電話番号、ステータス、有効期限が表示されること
3. [ ] 電話番号は中間4桁がマスキングされていること
4. [ ] ステータスがバッジで表示されること（有効: 緑、無効: グレー）
5. [ ] 有効期限切れの利用者は警告表示されること
6. [ ] 行クリックで利用者詳細画面に遷移すること
7. [ ] ページネーションが動作すること
8. [ ] ソート順を変更できること

---

## 画面仕様

### 利用者一覧テーブル

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 利用者番号    │ 氏名        │ ふりがな      │ 電話番号       │ 区分   │ ステータス │ 有効期限   │
├─────────────────────────────────────────────────────────────────────────┤
│ P2025000001   │ 山田 太郎   │ やまだ たろう │ 090-****-5678 │ 一般   │ ● 有効    │ 2026/12/26 │
│ P2025000015   │ 山田 花子   │ やまだ はなこ │ 080-****-1234 │ 学生   │ ● 有効    │ 2026/06/15 │
│ P2024000123   │ 田中 次郎   │ たなか じろう │ 03-****-9876  │ 一般   │ ○ 無効    │ 2024/12/01 │
│ P2025000042   │ 佐藤 美咲   │ さとう みさき │ 090-****-3456 │ 児童   │ ⚠ 期限切れ│ 2025/11/30 │
└─────────────────────────────────────────────────────────────────────────┘
```

### ステータスバッジ

| ステータス | 色 | アイコン |
|-----------|-----|---------|
| 有効 | 緑 | ● |
| 無効 | グレー | ○ |
| 期限切れ | オレンジ | ⚠ |

### ページネーション

```
件数: 45件（1-20件表示）

[<] [1] [2] [3] ... [10] [>]

1ページあたり: [20件 ▼]
```

---

## 技術仕様

### コンポーネント構成

```
PatronSearchResults
├── ResultHeader
│   ├── ResultCount
│   └── SortSelect
├── PatronTable
│   ├── TableHeader（ソート可能）
│   └── TableBody
│       └── PatronRow（クリック可能）
│           ├── PatronNumberCell
│           ├── NameCell
│           ├── NameKanaCell
│           ├── PhoneCell（マスキング済み）
│           ├── PatronTypeCell
│           ├── StatusBadge
│           └── ExpiryDateCell
└── Pagination
```

### PatronTable コンポーネント

```tsx
// PatronTable.tsx
export const PatronTable: React.FC<PatronTableProps> = ({
  patrons,
  sortField,
  sortOrder,
  onSort,
  onRowClick,
}) => {
  const columns = [
    { key: 'patronNumber', label: '利用者番号', sortable: true },
    { key: 'name', label: '氏名', sortable: true },
    { key: 'nameKana', label: 'ふりがな', sortable: true },
    { key: 'phoneNumber', label: '電話番号', sortable: false },
    { key: 'patronType', label: '区分', sortable: false },
    { key: 'status', label: 'ステータス', sortable: false },
    { key: 'expiresAt', label: '有効期限', sortable: true },
  ];

  return (
    <table className="patron-table">
      <thead>
        <tr>
          {columns.map((col) => (
            <th
              key={col.key}
              onClick={() => col.sortable && onSort(col.key)}
              className={col.sortable ? 'sortable' : ''}
            >
              {col.label}
              {sortField === col.key && (
                <SortIcon direction={sortOrder} />
              )}
            </th>
          ))}
        </tr>
      </thead>
      <tbody>
        {patrons.map((patron) => (
          <PatronRow
            key={patron.id}
            patron={patron}
            onClick={() => onRowClick(patron.id)}
          />
        ))}
      </tbody>
    </table>
  );
};
```

### PatronRow コンポーネント

```tsx
// PatronRow.tsx
export const PatronRow: React.FC<PatronRowProps> = ({ patron, onClick }) => {
  const isExpired = new Date(patron.expiresAt) < new Date();
  const status = !patron.isActive ? 'inactive' : isExpired ? 'expired' : 'active';

  return (
    <tr onClick={onClick} className="clickable">
      <td>{patron.patronNumber}</td>
      <td>{patron.name}</td>
      <td>{patron.nameKana}</td>
      <td>{patron.phoneNumber}</td>
      <td>{PATRON_TYPE_LABELS[patron.patronType]}</td>
      <td>
        <StatusBadge status={status} />
      </td>
      <td className={isExpired ? 'warning' : ''}>
        {formatDate(patron.expiresAt)}
      </td>
    </tr>
  );
};
```

### StatusBadge コンポーネント

```tsx
// StatusBadge.tsx
const STATUS_CONFIG = {
  active: { label: '有効', color: 'green', icon: '●' },
  inactive: { label: '無効', color: 'gray', icon: '○' },
  expired: { label: '期限切れ', color: 'orange', icon: '⚠' },
};

export const StatusBadge: React.FC<{ status: PatronDisplayStatus }> = ({
  status,
}) => {
  const config = STATUS_CONFIG[status];

  return (
    <span className={`status-badge status-${config.color}`}>
      {config.icon} {config.label}
    </span>
  );
};
```

### Pagination コンポーネント

```tsx
// Pagination.tsx
export const Pagination: React.FC<PaginationProps> = ({
  currentPage,
  lastPage,
  total,
  perPage,
  onPageChange,
  onPerPageChange,
}) => {
  const start = (currentPage - 1) * perPage + 1;
  const end = Math.min(currentPage * perPage, total);

  return (
    <div className="pagination">
      <div className="pagination-info">
        件数: {total}件（{start}-{end}件表示）
      </div>
      <div className="pagination-controls">
        <Button
          size="sm"
          disabled={currentPage === 1}
          onClick={() => onPageChange(currentPage - 1)}
        >
          &lt;
        </Button>
        {/* ページ番号 */}
        <PageNumbers
          currentPage={currentPage}
          lastPage={lastPage}
          onPageChange={onPageChange}
        />
        <Button
          size="sm"
          disabled={currentPage === lastPage}
          onClick={() => onPageChange(currentPage + 1)}
        >
          &gt;
        </Button>
      </div>
      <div className="per-page-select">
        1ページあたり:
        <Select
          value={perPage}
          onChange={(e) => onPerPageChange(Number(e.target.value))}
          options={[
            { value: 10, label: '10件' },
            { value: 20, label: '20件' },
            { value: 50, label: '50件' },
            { value: 100, label: '100件' },
          ]}
        />
      </div>
    </div>
  );
};
```

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| PatronSearchResults | frontend/src/features/patron/components/PatronSearchResults.tsx |
| PatronTable | frontend/src/features/patron/components/PatronTable.tsx |
| PatronRow | frontend/src/features/patron/components/PatronRow.tsx |
| StatusBadge | frontend/src/features/patron/components/StatusBadge.tsx |
| Pagination | frontend/src/components/common/Pagination.tsx |
| テスト | frontend/src/features/patron/__tests__/ |

---

## タスク

### Design Tasks（外部設計）

- [ ] テーブルレイアウトの確定
- [ ] ステータスバッジデザインの確定
- [ ] ページネーションデザインの確定

### Spec Tasks（詳細設計）

- [ ] PatronSearchResults コンポーネント実装
- [ ] PatronTable コンポーネント実装
- [ ] PatronRow コンポーネント実装
- [ ] StatusBadge コンポーネント実装
- [ ] Pagination コンポーネント実装
- [ ] ソート機能実装
- [ ] 行クリック遷移実装
- [ ] コンポーネントテスト作成

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
