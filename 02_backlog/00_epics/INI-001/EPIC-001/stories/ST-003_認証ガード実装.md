# ST-003: 認証ガードの実装

最終更新: 2025-12-26

---

## ストーリー

**システム管理者として**、未認証ユーザーが職員向け画面にアクセスできないようにしたい。
**なぜなら**、システムのセキュリティを確保し、認証済み職員のみが業務機能を利用できるようにしたいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-001: 職員ログイン機能](../epic.md) |
| ポイント | 2 |
| 優先度 | Must |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] 未認証状態で `/staff/*` にアクセスするとログイン画面にリダイレクトされること
2. [ ] 認証状態で `/staff/*` にアクセスすると正常に表示されること
3. [ ] 認証状態で `/staff/login` にアクセスするとダッシュボードにリダイレクトされること
4. [ ] セッション切れの場合、ログイン画面にリダイレクトされること
5. [ ] リダイレクト時に元のURLが保持され、ログイン後に戻れること
6. [ ] API 呼び出しで 401 が返った場合、ログイン画面にリダイレクトされること

---

## 技術仕様

### フロントエンド実装

#### AuthProvider

```tsx
// AuthProvider.tsx
export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { data: user, isLoading, error } = useQuery({
    queryKey: ['auth', 'me'],
    queryFn: authApi.getMe,
    retry: false,
    staleTime: 5 * 60 * 1000, // 5分
  });

  const setUser = useAuthStore((state) => state.setUser);

  useEffect(() => {
    if (user) {
      setUser(user);
    }
  }, [user, setUser]);

  if (isLoading) {
    return <LoadingSpinner />;
  }

  return <>{children}</>;
};
```

#### ProtectedRoute

```tsx
// ProtectedRoute.tsx
export const ProtectedRoute: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const user = useAuthStore((state) => state.user);
  const location = useLocation();

  if (!user) {
    return <Navigate to="/staff/login" state={{ from: location }} replace />;
  }

  return <>{children}</>;
};
```

#### GuestRoute（未認証専用）

```tsx
// GuestRoute.tsx
export const GuestRoute: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const user = useAuthStore((state) => state.user);

  if (user) {
    return <Navigate to="/staff/dashboard" replace />;
  }

  return <>{children}</>;
};
```

#### ルーティング設定

```tsx
// routes.tsx
const router = createBrowserRouter([
  {
    path: '/staff',
    element: <AuthProvider><Outlet /></AuthProvider>,
    children: [
      {
        path: 'login',
        element: <GuestRoute><LoginPage /></GuestRoute>,
      },
      {
        element: <ProtectedRoute><StaffLayout /></ProtectedRoute>,
        children: [
          { path: 'dashboard', element: <DashboardPage /> },
          { path: 'patrons', element: <PatronsListPage /> },
          // ...
        ],
      },
    ],
  },
]);
```

### バックエンド実装

#### Middleware

```php
// routes/api.php
Route::middleware('auth:sanctum')->prefix('staff')->group(function () {
    Route::get('/dashboard', [DashboardController::class, 'index']);
    Route::resource('patrons', PatronController::class);
    // ...
});
```

### Axios インターセプター

```typescript
// axiosConfig.ts
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      useAuthStore.getState().clearUser();
      window.location.href = '/staff/login';
    }
    return Promise.reject(error);
  }
);
```

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| AuthProvider | frontend/src/features/auth/components/AuthProvider.tsx |
| ProtectedRoute | frontend/src/features/auth/components/ProtectedRoute.tsx |
| GuestRoute | frontend/src/features/auth/components/GuestRoute.tsx |
| authStore | frontend/src/stores/authStore.ts |
| axiosConfig | frontend/src/lib/axios.ts |
| テスト | frontend/src/features/auth/\_\_tests\_\_/ProtectedRoute.test.tsx |

---

## タスク

### Design Tasks（外部設計）

- [ ] 認証フローの確認
- [ ] リダイレクト先の確定
- [ ] ローディング表示の確定

### Spec Tasks（詳細設計）

- [ ] authStore 実装（Zustand）
- [ ] AuthProvider 実装
- [ ] ProtectedRoute 実装
- [ ] GuestRoute 実装
- [ ] Axios インターセプター設定
- [ ] ルーティング更新
- [ ] テスト作成

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
