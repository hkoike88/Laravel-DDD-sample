# ST-004: アカウントロック機能の実装

最終更新: 2025-12-26

---

## ストーリー

**システム管理者として**、ログイン失敗が連続した場合にアカウントをロックしたい。
**なぜなら**、ブルートフォース攻撃からシステムを保護し、セキュリティを強化したいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-001: 職員ログイン機能](../epic.md) |
| ポイント | 2 |
| 優先度 | Must |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] ログイン失敗時に失敗回数がカウントされること
2. [ ] 5回連続でログイン失敗するとアカウントがロックされること
3. [ ] ロックされたアカウントでログイン試行すると専用エラーメッセージが表示されること
4. [ ] ログイン成功時に失敗回数がリセットされること
5. [ ] ロック状態は管理者のみ解除できること
6. [ ] ロック時刻が記録されること

---

## ビジネスルール

| ルールID | ルール内容 |
|----------|-----------|
| BR-UC001-01-01 | ログイン失敗は5回まで許容 |
| BR-UC001-01-01 | 5回連続失敗でアカウントロック |
| BR-UC001-01-01 | ロック解除は管理者のみ可能 |

---

## 技術仕様

### データベース設計

```sql
-- staffs テーブルに追加
ALTER TABLE staffs ADD COLUMN failed_login_attempts INT DEFAULT 0;
ALTER TABLE staffs ADD COLUMN is_locked BOOLEAN DEFAULT FALSE;
ALTER TABLE staffs ADD COLUMN locked_at TIMESTAMP NULL;
```

### ドメインモデル

```php
// Staff Entity
class Staff
{
    private const MAX_FAILED_ATTEMPTS = 5;

    public function recordFailedLogin(): void
    {
        $this->failedLoginAttempts++;

        if ($this->failedLoginAttempts >= self::MAX_FAILED_ATTEMPTS) {
            $this->lock();
        }
    }

    public function resetFailedLoginAttempts(): void
    {
        $this->failedLoginAttempts = 0;
    }

    public function lock(): void
    {
        $this->isLocked = true;
        $this->lockedAt = new DateTimeImmutable();
    }

    public function unlock(): void
    {
        $this->isLocked = false;
        $this->lockedAt = null;
        $this->failedLoginAttempts = 0;
    }

    public function isLocked(): bool
    {
        return $this->isLocked;
    }
}
```

### LoginHandler 更新

```php
// LoginHandler
public function handle(LoginCommand $command): Staff
{
    $staff = $this->staffRepository->findByEmail(
        new Email($command->email)
    );

    // アカウントロックチェック
    if ($staff && $staff->isLocked()) {
        throw new AccountLockedException(
            'アカウントがロックされています。管理者にお問い合わせください'
        );
    }

    // 認証チェック
    if (!$staff || !$staff->verifyPassword($command->password)) {
        if ($staff) {
            $staff->recordFailedLogin();
            $this->staffRepository->save($staff);

            if ($staff->isLocked()) {
                throw new AccountLockedException(
                    'ログイン失敗回数が上限に達しました。アカウントがロックされました'
                );
            }
        }

        throw new AuthenticationException(
            'メールアドレスまたはパスワードが正しくありません'
        );
    }

    // ログイン成功時は失敗回数リセット
    $staff->resetFailedLoginAttempts();
    $this->staffRepository->save($staff);

    return $staff;
}
```

### Controller レスポンス

```php
// AuthController
public function login(LoginRequest $request): JsonResponse
{
    try {
        $staff = $this->loginHandler->handle(...);
        // ...
    } catch (AccountLockedException $e) {
        return response()->json([
            'message' => $e->getMessage(),
        ], 423); // Locked
    } catch (AuthenticationException $e) {
        return response()->json([
            'message' => $e->getMessage(),
        ], 401);
    }
}
```

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| Staff（更新） | backend/packages/Domain/Staff/Entities/Staff.php |
| AccountLockedException | backend/packages/Domain/Staff/Exceptions/AccountLockedException.php |
| Migration | backend/database/migrations/xxxx_add_lock_columns_to_staffs.php |
| LoginHandler（更新） | backend/packages/Domain/Staff/Application/UseCases/Commands/Login/LoginHandler.php |
| Feature テスト | backend/tests/Feature/Auth/AccountLockTest.php |

---

## タスク

### Design Tasks（外部設計）

- [ ] ロック時のエラーメッセージ確定
- [ ] ロック解除フローの確定
- [ ] HTTP ステータスコードの確定（423 Locked）

### Spec Tasks（詳細設計）

- [ ] Migration 作成（failed_login_attempts, is_locked, locked_at）
- [ ] Staff エンティティにロック機能追加
- [ ] AccountLockedException 実装
- [ ] LoginHandler 更新
- [ ] AuthController 更新
- [ ] Feature テスト作成

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
