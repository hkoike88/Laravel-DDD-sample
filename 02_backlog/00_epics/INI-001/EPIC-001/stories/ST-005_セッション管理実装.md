# ST-005: セッション管理の実装

最終更新: 2025-12-26

---

## ストーリー

**システム管理者として**、セッションを適切に管理したい。
**なぜなら**、セキュリティを確保しつつ、職員が快適にシステムを利用できるようにしたいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-001: 職員ログイン機能](../epic.md) |
| ポイント | 2 |
| 優先度 | Must |
| ステータス | Planned |

---

## 受け入れ条件

1. [ ] セッションがデータベースに保存されること
2. [ ] アイドルタイムアウト（30分）でセッションが失効すること
3. [ ] 絶対タイムアウト（8時間）でセッションが失効すること
4. [ ] 同時ログイン数が制限されること（職員: 3台、管理者: 1台）
5. [ ] セッション切れ時に適切なメッセージが表示されること
6. [ ] CSRF トークンが適切に検証されること

---

## ビジネスルール

| ルールID | ルール内容 |
|----------|-----------|
| BR-UC001-01-02 | アイドルタイムアウトは30分 |
| BR-UC001-01-03 | 絶対タイムアウトは8時間 |
| BR-UC001-01-05 | 同時ログインは最大3台まで（管理者は1台） |

---

## 技術仕様

### セッション設定

```php
// config/session.php
return [
    'driver' => 'database',
    'lifetime' => 30, // アイドルタイムアウト: 30分
    'expire_on_close' => false,
    'encrypt' => true,
    'cookie' => 'laravel_session',
    'path' => '/',
    'domain' => null,
    'secure' => true, // HTTPS 必須
    'http_only' => true,
    'same_site' => 'lax',
];
```

### sessions テーブル

```sql
CREATE TABLE sessions (
    id VARCHAR(255) PRIMARY KEY,
    user_id CHAR(26) NULL,
    ip_address VARCHAR(45) NULL,
    user_agent TEXT NULL,
    payload TEXT NOT NULL,
    last_activity INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX sessions_user_id_index (user_id),
    INDEX sessions_last_activity_index (last_activity)
);
```

### 絶対タイムアウト Middleware

```php
// AbsoluteSessionTimeoutMiddleware
class AbsoluteSessionTimeoutMiddleware
{
    private const ABSOLUTE_TIMEOUT = 8 * 60 * 60; // 8時間

    public function handle(Request $request, Closure $next): Response
    {
        if (Auth::check()) {
            $createdAt = session('session_created_at');

            if (!$createdAt) {
                session(['session_created_at' => now()->timestamp]);
            } elseif (now()->timestamp - $createdAt > self::ABSOLUTE_TIMEOUT) {
                Auth::logout();
                $request->session()->invalidate();
                $request->session()->regenerateToken();

                return response()->json([
                    'message' => 'セッションが期限切れです。再度ログインしてください',
                ], 401);
            }
        }

        return $next($request);
    }
}
```

### 同時ログイン制限

```php
// ConcurrentSessionMiddleware
class ConcurrentSessionMiddleware
{
    private const MAX_SESSIONS_STAFF = 3;
    private const MAX_SESSIONS_ADMIN = 1;

    public function handle(Request $request, Closure $next): Response
    {
        if (Auth::check()) {
            $user = Auth::user();
            $maxSessions = $user->isAdmin()
                ? self::MAX_SESSIONS_ADMIN
                : self::MAX_SESSIONS_STAFF;

            $activeSessions = DB::table('sessions')
                ->where('user_id', $user->id)
                ->orderByDesc('last_activity')
                ->get();

            if ($activeSessions->count() > $maxSessions) {
                // 古いセッションを削除
                $toDelete = $activeSessions->skip($maxSessions);
                DB::table('sessions')
                    ->whereIn('id', $toDelete->pluck('id'))
                    ->delete();
            }
        }

        return $next($request);
    }
}
```

### フロントエンド対応

```typescript
// セッション切れ検知
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      const message = error.response?.data?.message;

      if (message?.includes('セッション')) {
        // セッション切れメッセージを表示
        toast.error('セッションがタイムアウトしました。再度ログインしてください');
      }

      useAuthStore.getState().clearUser();
      window.location.href = '/staff/login';
    }
    return Promise.reject(error);
  }
);
```

---

## 成果物

| 成果物 | 配置場所 |
|--------|---------|
| Session config | backend/config/session.php |
| AbsoluteSessionTimeoutMiddleware | backend/app/Http/Middleware/AbsoluteSessionTimeoutMiddleware.php |
| ConcurrentSessionMiddleware | backend/app/Http/Middleware/ConcurrentSessionMiddleware.php |
| Migration | backend/database/migrations/xxxx_create_sessions_table.php |
| Feature テスト | backend/tests/Feature/Auth/SessionTest.php |

---

## タスク

### Design Tasks（外部設計）

- [ ] タイムアウト時間の確定
- [ ] 同時ログイン数の確定
- [ ] セッション切れ時のメッセージ確定

### Spec Tasks（詳細設計）

- [ ] sessions テーブル Migration 作成
- [ ] session.php 設定更新
- [ ] AbsoluteSessionTimeoutMiddleware 実装
- [ ] ConcurrentSessionMiddleware 実装
- [ ] Kernel にミドルウェア登録
- [ ] フロントエンドのセッション切れ対応
- [ ] Feature テスト作成

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
