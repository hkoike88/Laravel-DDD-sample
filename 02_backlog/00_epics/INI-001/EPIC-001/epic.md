# EPIC-001: 職員ログイン機能

最終更新: 2025-12-26

---

## 概要

職員がシステムにログインし、職員向け機能（蔵書登録、貸出処理、返却処理、利用者管理など）を利用可能にする認証機能を実装する。セキュリティを考慮したログイン処理とセッション管理を行う。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| イニシアチブ | [INI-001: 認証・利用者管理基盤](../../../../01_vision/initiatives/INI-001/charter.md) |
| Use Case | [UC-001-001: 職員ログイン](../../../../01_vision/initiatives/INI-001/usecases/UC-001-001_職員ログイン.md) |
| 優先度 | Must |
| ステータス | Planned |

---

## ビジネス価値

図書館職員がシステムにアクセスするための認証基盤を提供する。
適切な認証により、職員のみが業務機能（蔵書管理、貸出・返却、利用者管理）にアクセスできることを保証し、システムのセキュリティを確保する。

---

## 受け入れ条件

1. 職員がメールアドレスとパスワードでログインできること
2. ログイン成功時にダッシュボード画面にリダイレクトされること
3. 認証情報が不正な場合、エラーメッセージが表示されること
4. ログイン失敗が5回連続するとアカウントがロックされること
5. ロックされたアカウントでログイン試行時に適切なエラーメッセージが表示されること
6. セッションが30分のアイドルタイムアウトで失効すること
7. セッションが8時間の絶対タイムアウトで失効すること
8. ログイン処理が2秒以内に完了すること

---

## 画面一覧

| 画面ID | 画面名 | パス | 説明 |
|--------|--------|------|------|
| SCR-001-001 | 職員ログイン | `/staff/login` | ログインフォーム |
| SCR-001-002 | 職員ダッシュボード | `/staff/dashboard` | ログイン成功後の遷移先 |

---

## User Story 一覧

| ID | Story 名 | ポイント | 優先度 | ステータス |
|----|----------|---------|--------|----------|
| [ST-001](./stories/ST-001_職員認証API実装.md) | 職員認証 API の実装 | 3 | Must | Planned |
| [ST-002](./stories/ST-002_ログインUI実装.md) | ログイン UI の実装 | 3 | Must | Planned |
| [ST-003](./stories/ST-003_認証ガード実装.md) | 認証ガードの実装 | 2 | Must | Planned |
| [ST-004](./stories/ST-004_アカウントロック実装.md) | アカウントロック機能の実装 | 2 | Must | Planned |
| [ST-005](./stories/ST-005_セッション管理実装.md) | セッション管理の実装 | 2 | Must | Planned |

---

## 成果物

| 成果物 | 配置場所 | 説明 |
|--------|---------|------|
| LoginHandler | backend/packages/Domain/Staff/Application/UseCases/Commands/Login/ | ログイン処理 |
| AuthController | backend/app/Http/Controllers/Auth/ | 認証エンドポイント |
| LoginRequest | backend/app/Http/Requests/Auth/ | ログインリクエストバリデーション |
| LoginPage | frontend/src/pages/staff/LoginPage.tsx | ログイン画面コンポーネント |
| useAuth | frontend/src/features/auth/hooks/ | 認証用カスタムフック |
| authStore | frontend/src/stores/ | 認証状態管理 |

---

## 技術仕様

### API エンドポイント

| メソッド | エンドポイント | 説明 | 認証 |
|----------|---------------|------|------|
| GET | `/api/auth/csrf-cookie` | CSRF Cookie 取得 | 不要 |
| POST | `/api/auth/login` | ログイン | 不要 |
| GET | `/api/auth/me` | 認証ユーザー情報取得 | 必須 |

### リクエスト/レスポンス

#### POST /api/auth/login

**リクエスト:**
```json
{
  "email": "staff@example.com",
  "password": "password123"
}
```

**成功レスポンス (200):**
```json
{
  "message": "ログインしました",
  "user": {
    "id": "01HV...",
    "name": "山田太郎",
    "email": "staff@example.com",
    "role": "staff"
  }
}
```

**認証失敗レスポンス (401):**
```json
{
  "message": "メールアドレスまたはパスワードが正しくありません"
}
```

**アカウントロックレスポンス (423):**
```json
{
  "message": "アカウントがロックされています。管理者にお問い合わせください"
}
```

### 認証フロー

```
┌──────────────┐                  ┌──────────────┐
│   Frontend   │                  │   Backend    │
└──────┬───────┘                  └──────┬───────┘
       │                                 │
       │  1. GET /api/auth/csrf-cookie   │
       │────────────────────────────────>│
       │  Set-Cookie: XSRF-TOKEN         │
       │<────────────────────────────────│
       │                                 │
       │  2. POST /api/auth/login        │
       │  X-XSRF-TOKEN: xxx              │
       │────────────────────────────────>│
       │                                 │  認証情報検証
       │                                 │  セッション開始
       │  200 OK + Set-Cookie: session   │
       │<────────────────────────────────│
       │                                 │
       │  3. /staff/dashboard へ遷移     │
```

### パスワード要件

| 項目 | 要件 |
|------|------|
| 最小文字数 | 12文字 |
| 英大文字 | 1文字以上必須 |
| 英小文字 | 1文字以上必須 |
| 数字 | 1文字以上必須 |
| 記号 | 1文字以上必須 |
| ハッシュ方式 | bcrypt (cost=12) |

### セッション管理

| 項目 | 値 |
|------|-----|
| アイドルタイムアウト | 30分 |
| 絶対タイムアウト | 8時間 |
| 同時ログイン数（職員） | 最大3台 |
| 同時ログイン数（管理者） | 最大1台 |
| セッション保存先 | データベース（sessions テーブル） |

---

## 依存関係

### 前提条件

| Epic ID | Epic 名 | 関係 |
|---------|---------|------|
| INI-000/EPIC-001 | Docker 環境構築 | 開発環境が構築されていること |
| INI-000/EPIC-002 | バックエンド初期設定 | Laravel が設定されていること |
| INI-000/EPIC-003 | フロントエンド初期設定 | React が設定されていること |
| INI-000/EPIC-007 | セキュリティ対策準備 | セキュリティ設定が完了していること |

### 後続タスク

| Epic ID | Epic 名 | 関係 |
|---------|---------|------|
| EPIC-002 | 職員ログアウト機能 | ログイン機能完了後に実装 |
| EPIC-003 | 職員ダッシュボード | ログイン成功後の遷移先 |

---

## 非機能要件

| 項目 | 要件 |
|------|------|
| パフォーマンス | ログイン処理は2秒以内に完了する |
| セキュリティ | パスワードは bcrypt (cost=12) でハッシュ化 |
| セキュリティ | 通信は HTTPS 必須 |
| セキュリティ | CSRF トークンによる保護 |
| セキュリティ | HttpOnly Cookie でセッション管理 |
| 可用性 | 図書館開館時間中は利用可能 |

---

## ビジネスルール

| ルールID | ルール内容 |
|----------|-----------|
| BR-UC001-01-01 | ログイン失敗は5回まで許容。5回連続失敗でアカウントロック |
| BR-UC001-01-02 | アイドルタイムアウトは30分 |
| BR-UC001-01-03 | 絶対タイムアウトは8時間 |
| BR-UC001-01-04 | パスワードは12文字以上、英大小文字・数字・記号必須 |
| BR-UC001-01-05 | 同時ログインは最大3台まで（管理者は1台） |

---

## 関連ドキュメント

- [UC-001-001: 職員ログイン](../../../../01_vision/initiatives/INI-001/usecases/UC-001-001_職員ログイン.md)
- [UC-001-002: 職員ダッシュボード表示](../../../../01_vision/initiatives/INI-001/usecases/UC-001-002_職員ダッシュボード表示.md)
- [セキュリティ標準](../../../../00_docs/20_tech/99_standard/security/00_Overview.md)
- [ワイヤーフレーム: 職員ログイン](../../../../01_vision/initiatives/INI-001/ui/wireframes/staff-login.md)
- [ワイヤーフレーム: 職員ダッシュボード](../../../../01_vision/initiatives/INI-001/ui/wireframes/staff-dashboard.md)

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-26 | 初版作成 |
