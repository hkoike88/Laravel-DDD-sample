# ST-004: 予約キャンセル機能の実装

最終更新: 2025-12-24

---

## ストーリー

**図書館職員として**、予約をキャンセルしたい。
**なぜなら**、利用者からの依頼に応じて予約を取り消したいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-006: 予約管理](../epic.md) |
| ポイント | 2 |
| 優先度 | Must |
| ステータス | Draft |

---

## 受け入れ条件

1. [ ] 予約をキャンセルできること
2. [ ] キャンセル理由を記録できること
3. [ ] キャンセル後に次の予約者が繰り上がること
4. [ ] キャンセル完了メッセージが表示されること

---

## タスク

### Design Tasks（外部設計）

- [ ] キャンセルワークフローの設計

### Spec Tasks（詳細設計）

- [ ] CancelReservationUseCase の実装
- [ ] ReservationController への cancel アクション追加
- [ ] 繰り上げ処理の実装
- [ ] Feature テストの作成

---

## API 仕様

### リクエスト

```http
DELETE /api/reservations/{id}
Content-Type: application/json

{
  "reason": "利用者都合によるキャンセル"
}
```

### レスポンス（成功時）

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "data": {
    "id": "uuid",
    "status": "cancelled",
    "cancelled_at": "2025-01-20T10:30:00+09:00",
    "reason": "利用者都合によるキャンセル",
    "next_reservation": {
      "id": "uuid",
      "patron_name": "鈴木花子",
      "new_order": 1
    }
  },
  "message": "予約をキャンセルしました"
}
```

---

## キャンセル理由（選択肢）

| 理由 | 説明 |
|------|------|
| 利用者都合 | 利用者からの依頼 |
| 連絡不通 | 取り置き連絡に応答なし |
| 期限切れ | 取り置き期限超過 |
| その他 | 自由入力 |

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-24 | 初版作成 |
