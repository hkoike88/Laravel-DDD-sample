# ST-003: 取り置き期限管理の実装

最終更新: 2025-12-24

---

## ストーリー

**図書館職員として**、取り置き期限を管理したい。
**なぜなら**、期限切れの予約を適切に処理したいからだ。

---

## 関連情報

| 項目 | 値 |
|------|-----|
| Epic | [EPIC-006: 予約管理](../epic.md) |
| ポイント | 3 |
| 優先度 | Must |
| ステータス | Draft |

---

## 受け入れ条件

1. [ ] 取り置き期限が自動計算されること（返却日 + 7日）
2. [ ] 期限切れ予約が一覧表示されること
3. [ ] 期限切れ時に次の予約者へ繰り上げができること
4. [ ] 期限切れ時に予約なし状態に戻せること
5. [ ] 期限間近（残り2日）の警告が表示されること

---

## タスク

### Design Tasks（外部設計）

- [ ] 期限管理ワークフローの設計

### Spec Tasks（詳細設計）

- [ ] HoldExpirationService ドメインサービスの実装
- [ ] 期限切れ検知クエリの実装
- [ ] 繰り上げ処理の実装
- [ ] バッチ処理（日次期限チェック）の実装
- [ ] 単体テストの作成

---

## ビジネスルール

| ルール | 内容 |
|--------|------|
| 取り置き期限 | 返却日（ready_at）+ 7日 |
| 警告表示 | 期限まで2日以内 |
| 期限切れ処理 | 日次バッチで自動検知 |
| 繰り上げ | 次の予約者を ready 状態に |

---

## 状態遷移

```
[ready] 取り置き中
    ↓
期限切れ?
    ├─ 次の予約あり → 次の予約者を [ready] に
    └─ 次の予約なし → 図書を [available] に
```

---

## API 仕様

### 期限切れ一覧取得

```http
GET /api/reservations/expired
```

### 期限切れ処理（繰り上げ or 解除）

```http
POST /api/reservations/{id}/expire
Content-Type: application/json

{
  "action": "promote" | "release"
}
```

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-24 | 初版作成 |
