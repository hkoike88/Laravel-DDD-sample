# Feature Specification: Docker 環境構築

**Feature Branch**: `002-docker-environment`
**Created**: 2025-12-23
**Status**: Draft
**Input**: EPIC-001 - Docker Compose を使用して開発環境の全サービスをコンテナ化し、一括起動・停止できる環境を構築

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 開発環境の一括起動 (Priority: P1)

開発者として、プロジェクトディレクトリで1つのコマンドを実行するだけで、開発に必要な全サービス（フロントエンド、バックエンド、データベース、DB管理ツール、リバースプロキシ）を起動したい。これにより、各サービスを個別に起動・設定する手間を省き、すぐに開発作業を開始できる。

**Why this priority**: 開発環境が起動しなければ開発作業自体が開始できないため、最も基本的かつ重要な機能である。

**Independent Test**: プロジェクトディレクトリで起動コマンドを実行し、全サービスが起動状態になり、各URLにアクセスして応答があることで検証可能。

**Acceptance Scenarios**:

1. **Given** 開発者がプロジェクトディレクトリにいる状態, **When** 一括起動コマンドを実行する, **Then** 全サービス（frontend, backend, db, phpmyadmin, nginx）が起動状態になる
2. **Given** 全サービスが起動している状態, **When** サービス状態確認コマンドを実行する, **Then** 全サービスが正常稼働状態で表示される
3. **Given** 全サービスが起動している状態, **When** フロントエンドURL（localhost:5173）にアクセスする, **Then** React アプリケーションが表示される
4. **Given** 全サービスが起動している状態, **When** バックエンドURL（localhost:8000）にアクセスする, **Then** API レスポンスが返される
5. **Given** 全サービスが起動している状態, **When** phpMyAdmin URL（localhost:8080）にアクセスする, **Then** データベース管理画面が表示される

---

### User Story 2 - 開発環境の一括停止 (Priority: P1)

開発者として、1つのコマンドで全サービスを停止したい。作業終了時やリソース解放が必要な際に、確実に全サービスを停止できる。

**Why this priority**: 起動と同様に、停止も開発ワークフローの基本機能であり、リソース管理のために必須。

**Independent Test**: 停止コマンドを実行し、全コンテナが停止・削除されることを確認。

**Acceptance Scenarios**:

1. **Given** 全サービスが起動している状態, **When** 一括停止コマンドを実行する, **Then** 全コンテナが停止し削除される
2. **Given** 停止コマンド実行後, **When** サービス状態確認コマンドを実行する, **Then** 稼働中のコンテナが表示されない

---

### User Story 3 - データベースデータの永続化 (Priority: P1)

開発者として、コンテナを停止・再起動してもデータベースのデータが保持されるようにしたい。開発中に作成したテストデータや設定が失われないようにする。

**Why this priority**: データが消失すると開発効率が著しく低下するため、永続化は必須機能。

**Independent Test**: データベースにテストデータを投入後、コンテナを再起動してデータが保持されていることを確認。

**Acceptance Scenarios**:

1. **Given** データベースにデータが存在する状態, **When** 停止コマンドで停止後、起動コマンドで再起動する, **Then** データベースのデータが保持されている
2. **Given** 初回起動時, **When** データベースコンテナが起動する, **Then** 指定したデータベースとユーザーが自動作成される

---

### User Story 4 - サービス間通信 (Priority: P2)

開発者として、各サービス間（フロントエンド↔バックエンド、バックエンド↔データベース）が正常に通信できるようにしたい。リバースプロキシ経由で統一的なアクセスポイントを提供する。

**Why this priority**: サービス間通信はアプリケーション動作の前提条件だが、個別サービスの起動確認後に検証可能。

**Independent Test**: バックエンドからデータベースへの接続テスト、リバースプロキシ経由でのアクセステストを実行。

**Acceptance Scenarios**:

1. **Given** 全サービスが起動している状態, **When** バックエンドからデータベースに接続を試みる, **Then** 接続が成功する
2. **Given** 全サービスが起動している状態, **When** リバースプロキシ（localhost:80）経由でフロントエンドにアクセスする, **Then** フロントエンドが表示される
3. **Given** 全サービスが起動している状態, **When** リバースプロキシ経由でバックエンドAPI（/api/*）にアクセスする, **Then** APIレスポンスが返される

---

### User Story 5 - ホットリロード対応 (Priority: P2)

開発者として、ソースコードを変更したら即座にブラウザに反映されるようにしたい。コンテナを再起動せずに開発を継続できる。

**Why this priority**: 開発効率に直結する機能だが、基本的な起動・停止機能の後に実装可能。

**Independent Test**: フロントエンドまたはバックエンドのソースコードを変更し、ブラウザをリロードせずに変更が反映されることを確認。

**Acceptance Scenarios**:

1. **Given** フロントエンドが起動している状態, **When** React コンポーネントのコードを変更する, **Then** ブラウザに自動的に変更が反映される
2. **Given** バックエンドが起動している状態, **When** PHP ファイルを変更する, **Then** 次のリクエストで変更が反映される

---

### User Story 6 - ポート設定のカスタマイズ (Priority: P3)

開発者として、環境変数でサービスのポート番号を変更できるようにしたい。他のプロセスとのポート競合を回避できる。

**Why this priority**: 基本機能が動作した後の利便性向上機能。デフォルト値が設定されているため必須ではない。

**Independent Test**: 環境変数を設定してサービスを起動し、指定したポートでアクセスできることを確認。

**Acceptance Scenarios**:

1. **Given** 環境変数でフロントエンドポートを3000に設定した状態, **When** 起動コマンドを実行する, **Then** フロントエンドが3000番ポートで起動する
2. **Given** 環境変数を設定しない状態, **When** 起動コマンドを実行する, **Then** デフォルトポート（5173, 8000, 3306, 8080, 80）で各サービスが起動する

---

### Edge Cases

- ポートが既に使用されている場合はどうなるか？→ コンテナ起動が失敗し、エラーメッセージが表示される
- ディスク容量が不足した場合はどうなるか？→ データベースへの書き込みが失敗し、適切なエラーが発生する
- Docker Daemon が停止している場合はどうなるか？→ コマンド実行時に接続エラーが表示される
- データベースを完全にリセットしたい場合はどうするか？→ ボリューム削除オプション付きで停止コマンドを実行する
- バックエンドがデータベースより先に起動しようとした場合はどうなるか？→ データベースの準備完了まで自動的に待機する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、単一のコマンドで5つのサービス（frontend, backend, db, phpmyadmin, nginx）を起動できなければならない
- **FR-002**: システムは、単一のコマンドで全サービスを停止・削除できなければならない
- **FR-003**: システムは、データベースのデータをボリュームに永続化しなければならない
- **FR-004**: システムは、サービス間のネットワーク通信を可能にしなければならない
- **FR-005**: システムは、環境変数によるポート番号のカスタマイズをサポートしなければならない
- **FR-006**: システムは、サービス起動時に依存関係を考慮し、依存先サービスが準備完了状態になるまで待機しなければならない
- **FR-007**: システムは、フロントエンドのソースコードをボリュームマウントしてホットリロードを可能にしなければならない
- **FR-008**: システムは、バックエンドのソースコードをボリュームマウントして即時反映を可能にしなければならない
- **FR-009**: システムは、リバースプロキシ経由で統一的なアクセスポイント（ポート80）を提供しなければならない
- **FR-010**: システムは、WebSocket 通信をサポートしてフロントエンドのホットリロードを正常に動作させなければならない

### Key Entities

- **Service（サービス）**: 開発環境を構成する個別のコンテナ。frontend, backend, db, phpmyadmin, nginx の5種類が存在
- **Volume（ボリューム）**: データの永続化領域。データベースデータの保持に使用
- **Network（ネットワーク）**: サービス間通信を可能にする仮想ネットワーク
- **Environment Variable（環境変数）**: ポート番号やデータベース接続情報などの設定値

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 開発者は起動コマンド実行後、2分以内に全サービスにアクセス可能な状態になる
- **SC-002**: 開発者は1つのコマンドで全サービスの起動・停止が完了できる
- **SC-003**: コンテナ再起動後もデータベースのデータが100%保持される
- **SC-004**: 新規開発者がドキュメントを読んで環境構築を完了するまでの時間が10分以内である
- **SC-005**: ポート競合が発生した場合、環境変数の変更のみで解決できる
- **SC-006**: ソースコード変更後、3秒以内にブラウザに反映される（フロントエンド）
- **SC-007**: 全サービスのメモリ使用量が合計4GB以下である

## Assumptions

- Docker Desktop または Docker Engine がホストマシンにインストール済みである
- 開発者はコマンドライン操作の基本的な知識を持っている
- ホストマシンに必要なディスク容量（最低5GB）が確保されている
- デフォルトポート（80, 3306, 5173, 8000, 8080）は初期状態で利用可能と想定する
- 開発環境はローカルマシンで動作し、本番環境とは別の設定を使用する
- コンテナ内プロセスは root ユーザーで実行し、開発環境のシンプルさを優先する
