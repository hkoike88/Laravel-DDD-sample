# Feature Specification: セキュリティ対策準備

**Feature Branch**: `001-security-preparation`
**Created**: 2026-01-06
**Status**: Draft
**Input**: User description: "02_backlog/00_epics/INI-001/EPIC-007/epic.md"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - パスワードポリシーの適用 (Priority: P1)

職員がパスワードを設定・変更する際に、セキュリティ標準に準拠したパスワードポリシーが適用され、弱いパスワードや漏洩したパスワードの使用を防止する。

**Why this priority**: パスワードはシステムへの不正アクセスを防ぐ最も基本的な防御手段であり、脆弱なパスワードは直接的なセキュリティリスクとなる。

**Independent Test**: 新規職員アカウント作成時にパスワードを入力し、ポリシーに違反するパスワードが拒否され、適切なエラーメッセージが表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 職員がパスワード設定画面にいる, **When** 11文字以下のパスワードを入力する, **Then** 「パスワードは12文字以上で入力してください」というエラーが表示される
2. **Given** 職員がパスワード設定画面にいる, **When** 英大文字を含まないパスワードを入力する, **Then** 「パスワードには大文字を含めてください」というエラーが表示される
3. **Given** 職員がパスワード設定画面にいる, **When** 数字を含まないパスワードを入力する, **Then** 「パスワードには数字を含めてください」というエラーが表示される
4. **Given** 職員がパスワード設定画面にいる, **When** 記号を含まないパスワードを入力する, **Then** 「パスワードには記号を含めてください」というエラーが表示される
5. **Given** 職員がパスワード設定画面にいる, **When** 過去に漏洩が確認されたパスワードを入力する, **Then** 「このパスワードは過去に漏洩が確認されています。別のパスワードを使用してください」というエラーが表示される
6. **Given** 職員がパスワード変更画面にいる, **When** 過去5回以内に使用したパスワードと同じパスワードを入力する, **Then** 「以前使用したパスワードは再利用できません」というエラーが表示される
7. **Given** 職員がパスワード設定画面にいる, **When** 全ての要件を満たすパスワードを入力する, **Then** パスワードが正常に設定される

---

### User Story 2 - セッションタイムアウトとセキュリティ (Priority: P1)

職員のセッションが適切に管理され、一定時間の無操作後や最大利用時間経過後に自動的にログアウトされ、セッションハイジャックのリスクを低減する。

**Why this priority**: セッション管理の不備はなりすまし攻撃の直接的な原因となり、パスワードポリシーと並んで認証システムの根幹をなす。

**Independent Test**: ログイン後に30分間操作せずに放置し、その後の操作でセッションタイムアウトのメッセージが表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 職員がログインしている状態, **When** 30分間操作がない, **Then** 次の操作時に「セッションがタイムアウトしました。再度ログインしてください。」と表示され、ログイン画面にリダイレクトされる
2. **Given** 職員がログインしている状態, **When** ログインから8時間が経過する, **Then** 操作の有無に関わらず強制的にログアウトされる
3. **Given** 職員がログインに成功した, **When** セッションが開始される, **Then** 新しいセッションIDが発行され、ログイン前のセッションIDは無効化される
4. **Given** 職員がログアウトする, **When** ログアウト処理が完了する, **Then** セッションデータが完全に破棄され、Cookie が削除される

---

### User Story 3 - 同時ログイン制御 (Priority: P2)

職員が複数のデバイスから同時にログインする場合に、セキュリティポリシーに基づいて同時ログイン数が制限され、不正利用のリスクを低減する。

**Why this priority**: 同時ログイン制御はアカウント共有や不正利用の検知に重要だが、基本的なパスワード・セッション管理の後に実装すべき機能。

**Independent Test**: 一般職員アカウントで4台目のデバイスからログインを試み、最も古いセッションが無効化されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 一般職員が3台のデバイスでログイン済み, **When** 4台目のデバイスでログインする, **Then** 最も古いセッションが自動的に無効化され、新しいデバイスでログインできる
2. **Given** 管理者が1台のデバイスでログイン済み, **When** 2台目のデバイスでログインする, **Then** 最も古いセッションが自動的に無効化され、新しいデバイスでログインできる
3. **Given** 職員がログインしている状態, **When** 他のデバイスでの自分のセッション一覧を確認する, **Then** 各セッションの最終アクセス時刻とデバイス情報が表示される
4. **Given** 職員がセッション管理画面にいる, **When** 特定のセッションを選択して無効化する, **Then** 選択したセッションがログアウトされ、そのデバイスでは再ログインが必要になる

---

### User Story 4 - 暗号化設定の適用 (Priority: P2)

システムがセキュリティ標準に準拠した暗号化設定を使用し、パスワードや機密データが適切に保護される。

**Why this priority**: 暗号化設定は内部的なセキュリティ基盤であり、ユーザー向け機能の実装後に適用・確認すべき項目。

**Independent Test**: システムの設定ファイルを確認し、bcrypt cost=12 または Argon2id のハッシュアルゴリズムが使用されていることを確認できる。

**Acceptance Scenarios**:

1. **Given** 職員のパスワードが保存される, **When** データベースを確認する, **Then** パスワードは bcrypt (cost=12) または Argon2id でハッシュ化されており、平文では保存されていない
2. **Given** システムがHTTPSで通信する, **When** TLSバージョンを確認する, **Then** TLS 1.2 以上が使用されている
3. **Given** セッションCookieが発行される, **When** Cookie属性を確認する, **Then** Secure、HttpOnly、SameSite=Lax が設定されている

---

### User Story 5 - セキュリティスキャンの自動実行 (Priority: P2)

開発チームがコードをコミットする際に、セキュリティスキャンが自動的に実行され、脆弱性の早期発見と対応が可能になる。

**Why this priority**: 自動スキャンは継続的なセキュリティ品質を担保するが、基本的なセキュリティ設定が完了した後に導入すべき運用機能。

**Independent Test**: CI/CD パイプラインでセキュリティスキャンが自動実行され、結果レポートが生成されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 開発者がコードをコミットする, **When** CI/CD パイプラインが実行される, **Then** composer audit と npm audit が自動実行され、依存関係の脆弱性がチェックされる
2. **Given** セキュリティスキャンが完了した, **When** Critical または High の脆弱性が検出される, **Then** パイプラインが失敗として報告される
3. **Given** セキュリティスキャンが完了した, **When** レポートが生成される, **Then** 脆弱性の重要度、影響範囲、修正推奨が記載されたレポートが出力される

---

### User Story 6 - セキュリティログの記録 (Priority: P3)

セキュリティ関連のイベントが適切にログに記録され、インシデント発生時の調査や監査に活用できる。

**Why this priority**: ログ記録はセキュリティ監査に重要だが、基本的なセキュリティ機能が動作した後に整備すべき運用基盤。

**Independent Test**: ログイン成功・失敗イベントを発生させ、セキュリティログに適切な情報が記録されていることを確認できる。

**Acceptance Scenarios**:

1. **Given** 職員がログインに成功した, **When** セキュリティログを確認する, **Then** ユーザーID、IPアドレス、UserAgent、タイムスタンプが記録されている
2. **Given** ログイン試行が失敗した, **When** セキュリティログを確認する, **Then** 試行されたメールアドレス、IPアドレス、失敗理由、タイムスタンプが記録されている
3. **Given** アカウントがロックされた, **When** セキュリティログを確認する, **Then** ユーザーID、ロック理由、失敗試行回数、タイムスタンプが記録されている
4. **Given** パスワードが変更された, **When** セキュリティログを確認する, **Then** ユーザーID、IPアドレス、タイムスタンプが記録されている
5. **Given** セッションがタイムアウトで終了した, **When** セキュリティログを確認する, **Then** ユーザーID、タイムアウト種別（アイドル/絶対）、タイムスタンプが記録されている

---

### Edge Cases

- パスワード変更中にセッションがタイムアウトした場合、変更途中のデータは破棄され、再度ログインして変更をやり直す必要がある
- 同時ログイン数の上限に達した状態で、新しいデバイスからログインした場合、最も古いセッションが無効化される
- Have I Been Pwned API に接続できない場合、漏洩チェックはスキップされ、他のパスワード要件のみで検証される（ただし警告ログを記録）
- セキュリティスキャンで Medium 以下の脆弱性のみが検出された場合、パイプラインは成功として扱われるが、レポートには記載される

## Requirements *(mandatory)*

### Functional Requirements

#### パスワードポリシー

- **FR-001**: システムは、パスワードが12文字以上であることを検証しなければならない
- **FR-002**: システムは、パスワードに英大文字、英小文字、数字、記号がそれぞれ1文字以上含まれることを検証しなければならない
- **FR-003**: システムは、Have I Been Pwned API を使用して、パスワードが過去に漏洩したものでないことを検証しなければならない
- **FR-004**: システムは、過去5世代のパスワードを履歴として保持し、再利用を禁止しなければならない
- **FR-005**: システムは、パスワード要件を満たさない場合に、具体的な不備を示すエラーメッセージを表示しなければならない

#### セッション管理

- **FR-006**: システムは、30分間の無操作後にセッションをタイムアウトさせなければならない（アイドルタイムアウト）
- **FR-007**: システムは、セッション開始から8時間経過後にセッションを強制終了しなければならない（絶対タイムアウト）
- **FR-008**: システムは、ログイン成功時にセッションIDを再生成しなければならない（セッション固定攻撃対策）
- **FR-009**: システムは、ログアウト時にセッションデータを完全に破棄しなければならない

#### 同時ログイン制御

- **FR-010**: システムは、一般職員の同時ログインを最大3台までに制限しなければならない
- **FR-011**: システムは、管理者の同時ログインを最大1台までに制限しなければならない
- **FR-012**: システムは、同時ログイン数を超えた場合、最も古いセッションを自動的に無効化しなければならない
- **FR-013**: システムは、職員が自身のアクティブセッション一覧を確認できる機能を提供しなければならない
- **FR-014**: システムは、職員が特定のセッションを手動で無効化できる機能を提供しなければならない

#### 暗号化設定

- **FR-015**: システムは、パスワードを bcrypt (cost=12) または Argon2id でハッシュ化して保存しなければならない
- **FR-016**: システムは、TLS 1.2 以上の通信暗号化を使用しなければならない
- **FR-017**: システムは、セッション Cookie に Secure、HttpOnly、SameSite=Lax 属性を設定しなければならない
- **FR-018**: システムは、セッションデータを暗号化して保存しなければならない

#### セキュリティスキャン

- **FR-019**: システムは、CI/CD パイプラインで composer audit と npm audit を自動実行しなければならない
- **FR-020**: システムは、PHPStan/Larastan による静的解析を CI/CD パイプラインで実行しなければならない
- **FR-021**: システムは、Critical または High の脆弱性が検出された場合、パイプラインを失敗させなければならない
- **FR-022**: システムは、セキュリティスキャン結果をレポートとして出力しなければならない

#### セキュリティログ

- **FR-023**: システムは、ログイン成功イベントを INFO レベルでログに記録しなければならない
- **FR-024**: システムは、ログイン失敗イベントを WARNING レベルでログに記録しなければならない
- **FR-025**: システムは、アカウントロックイベントを WARNING レベルでログに記録しなければならない
- **FR-026**: システムは、パスワード変更イベントを INFO レベルでログに記録しなければならない
- **FR-027**: システムは、セッションタイムアウトイベントを INFO レベルでログに記録しなければならない
- **FR-028**: システムは、セキュリティログに必要な情報（ユーザーID、IPアドレス、UserAgent、タイムスタンプ等）を含めなければならない

### Key Entities

- **PasswordHistory**: 職員のパスワード履歴を管理するエンティティ。職員ID、ハッシュ化されたパスワード、作成日時を保持。過去5世代の履歴を保持し、パスワード再利用禁止のチェックに使用。

- **Session**: 職員のログインセッションを管理するエンティティ。セッションID、職員ID、IPアドレス、UserAgent、最終アクティビティ時刻、セッション開始時刻を保持。同時ログイン制御とセッション管理に使用。

- **SecurityLog**: セキュリティイベントを記録するエンティティ。イベント種別、職員ID（該当する場合）、IPアドレス、UserAgent、詳細情報、タイムスタンプを保持。監査とインシデント調査に使用。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: パスワードポリシー違反時に、職員が要件を理解できる具体的なエラーメッセージが100%表示される
- **SC-002**: セッションアイドルタイムアウトが30分（±30秒）の精度で動作する
- **SC-003**: セッション絶対タイムアウトが8時間（±1分）の精度で動作する
- **SC-004**: 同時ログイン制限を超えた場合、100%の確率で古いセッションが無効化される
- **SC-005**: CI/CD パイプラインでセキュリティスキャンが100%自動実行される
- **SC-006**: Critical/High 脆弱性が検出された場合、パイプラインが100%失敗として報告される
- **SC-007**: 全てのセキュリティ関連イベント（ログイン成功/失敗、パスワード変更、セッションタイムアウト、アカウントロック）が100%ログに記録される
- **SC-008**: Have I Been Pwned API で漏洩が確認されたパスワードの使用が100%拒否される

### Assumptions

- Have I Been Pwned API は外部サービスであり、API の可用性は保証されない。APIに接続できない場合は、漏洩チェックをスキップし、他の要件のみで検証する（警告ログを記録）
- セキュリティスキャンの週次実行（OWASP ZAP 等）は、CI/CD パイプラインとは別に、運用チームが手動またはスケジュールジョブで実行する想定
- TLS 1.2 以上の設定は、アプリケーションサーバー（Nginx）レベルで実施される想定
- 既存のアカウントロック機能（EPIC-006 で実装済み）と連携してセキュリティログを記録する
