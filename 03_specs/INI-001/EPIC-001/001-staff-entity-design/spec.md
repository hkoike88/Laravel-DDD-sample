# Feature Specification: 職員エンティティの設計

**Feature Branch**: `001-staff-entity-design`
**Created**: 2025-12-25
**Status**: Draft
**Input**: User description: "02_backlog/00_epics/INI-000/EPIC-005/stories/ST-001_職員エンティティ設計.md"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 職員データの永続化 (Priority: P1)

開発者として、職員情報（ID、メールアドレス、パスワード、名前）をシステムに保存できるようにしたい。認証機能の基盤となる職員データを適切に管理するためである。

**Why this priority**: 認証機能を実装するための最も基本的な機能であり、職員エンティティが存在しなければ後続のログイン・認可機能を実装できない。

**Independent Test**: 職員情報を新規登録し、その情報がデータベースに正しく保存されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 有効な職員情報（メールアドレス、パスワード、名前）が入力されている、**When** 職員データを保存する、**Then** 一意のIDが自動生成され、職員情報がデータベースに永続化される
2. **Given** 職員情報がデータベースに保存されている、**When** IDで職員を検索する、**Then** 該当する職員情報が取得できる
3. **Given** 職員情報がデータベースに保存されている、**When** メールアドレスで職員を検索する、**Then** 該当する職員情報が取得できる

---

### User Story 2 - パスワードのセキュアな管理 (Priority: P1)

開発者として、職員のパスワードを安全にハッシュ化して保存したい。平文パスワードの漏洩リスクを排除するためである。

**Why this priority**: セキュリティ上必須であり、パスワード管理なしでは認証機能を安全に実装できない。

**Independent Test**: パスワードを設定した職員を保存し、保存されたパスワードがハッシュ化されていること、かつ元のパスワードで検証できることを確認できる。

**Acceptance Scenarios**:

1. **Given** 平文パスワードが入力されている、**When** 職員を保存する、**Then** パスワードはハッシュ化された状態でデータベースに保存される
2. **Given** ハッシュ化されたパスワードが保存されている、**When** 正しい平文パスワードで検証する、**Then** 検証が成功する
3. **Given** ハッシュ化されたパスワードが保存されている、**When** 誤った平文パスワードで検証する、**Then** 検証が失敗する

---

### User Story 3 - アカウントロック状態の管理 (Priority: P2)

開発者として、職員アカウントのロック状態を管理できるようにしたい。不正なログイン試行からアカウントを保護するためである。

**Why this priority**: セキュリティ強化のための機能であり、基本的な職員管理機能の後に実装可能。

**Independent Test**: 職員アカウントをロックし、ロック状態とロック日時が正しく記録されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 職員アカウントが存在する、**When** アカウントをロックする、**Then** ロック状態がtrueになり、ロック日時が記録される
2. **Given** 職員アカウントがロックされている、**When** アカウントのロックを解除する、**Then** ロック状態がfalseになり、ログイン失敗回数がリセットされる
3. **Given** 職員アカウントが存在する、**When** ログイン失敗回数を増加させる、**Then** 失敗回数が正しく記録される

---

### User Story 4 - 入力値の妥当性検証 (Priority: P2)

開発者として、職員情報の入力値が適切であることを検証したい。不正なデータがシステムに保存されることを防ぐためである。

**Why this priority**: データ整合性のための機能であり、基本機能の実装後に追加可能。

**Independent Test**: 不正な形式のメールアドレスで職員を作成しようとした場合にエラーが発生することを確認できる。

**Acceptance Scenarios**:

1. **Given** 不正な形式のメールアドレスが入力されている、**When** 職員を作成しようとする、**Then** バリデーションエラーが発生する
2. **Given** 空のパスワードが入力されている、**When** 職員を作成しようとする、**Then** バリデーションエラーが発生する
3. **Given** 空の名前が入力されている、**When** 職員を作成しようとする、**Then** バリデーションエラーが発生する
4. **Given** 既に登録済みのメールアドレスが入力されている、**When** 職員を作成しようとする、**Then** 重複エラーが発生する

---

### Edge Cases

- 職員名に特殊文字（絵文字、制御文字など）が含まれている場合はどう処理されるか？
  → 想定：制御文字は除去し、絵文字は許可する
- メールアドレスの大文字・小文字は区別されるか？
  → 想定：区別しない（小文字に正規化して保存）
- パスワードの最小・最大長の制限はあるか？
  → 想定：最小8文字、最大72文字（bcryptの制限に合わせる）
- アカウントロック中に再度ロックをかけた場合はどうなるか？
  → 想定：ロック日時を更新する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは職員情報（ID、メールアドレス、パスワード、名前、ロック状態、ログイン失敗回数、ロック日時、作成日時、更新日時）を保存できなければならない
- **FR-002**: システムは職員IDとして26文字のULIDを自動生成しなければならない
- **FR-003**: システムはメールアドレスの形式を検証しなければならない
- **FR-004**: システムはメールアドレスを小文字に正規化して保存しなければならない
- **FR-005**: システムはメールアドレスの一意性を保証しなければならない
- **FR-006**: システムはパスワードをハッシュ化して保存しなければならない
- **FR-007**: システムはパスワードの検証機能を提供しなければならない
- **FR-008**: システムはパスワードの長さを8文字以上72文字以下に制限しなければならない
- **FR-009**: システムは職員名を100文字以内に制限しなければならない
- **FR-010**: システムはアカウントのロック・ロック解除機能を提供しなければならない
- **FR-011**: システムはログイン失敗回数の増加・リセット機能を提供しなければならない
- **FR-012**: システムはIDまたはメールアドレスで職員を検索できなければならない

### Key Entities

- **Staff（職員）**: システムにログインして操作を行う人物を表す。ID（ULID）、メールアドレス、パスワード（ハッシュ化済み）、名前、ロック状態、ログイン失敗回数、ロック日時、作成日時、更新日時を持つ
- **StaffId（職員ID）**: 職員を一意に識別する26文字のULID値
- **Email（メールアドレス）**: 職員の連絡先かつログイン識別子として使用される。形式検証済みで小文字に正規化された値
- **Password（パスワード）**: 認証に使用されるハッシュ化された秘密情報
- **StaffName（職員名）**: 職員の表示名

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 職員情報の登録・取得操作は1秒以内に完了する
- **SC-002**: パスワードの検証操作は0.5秒以内に完了する
- **SC-003**: 同一メールアドレスでの重複登録は100%検出される
- **SC-004**: 不正な形式のメールアドレスは100%拒否される
- **SC-005**: 保存されたパスワードは平文で取得できない
- **SC-006**: 100,000件の職員データが登録されている状態でも、ID検索は0.1秒以内に完了する

## Assumptions

- パスワードのハッシュ化にはbcryptアルゴリズムを使用する（業界標準）
- メールアドレスの形式検証にはRFC 5322に準拠した検証を行う
- ULIDはタイムスタンプ順にソート可能であることを活用する（作成順での並べ替え）
- 職員名には日本語（漢字、ひらがな、カタカナ）と英数字を許可する
- アカウントロックの閾値（何回失敗でロックするか）は本エンティティでは定義せず、認証機能側で制御する
