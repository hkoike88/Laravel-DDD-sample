# Feature Specification: セッション管理実装

**Feature Branch**: `001-session-management`
**Created**: 2025-12-26
**Status**: Draft
**Input**: ST-005: セッション管理の実装（EPIC-001: 職員ログイン機能）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - セッション自動タイムアウト (Priority: P1)

システム管理者として、セキュリティを確保するため、一定時間操作がない職員のセッションを自動的に終了させたい。これにより、離席中の不正アクセスを防止できる。

**Why this priority**: セッションの自動失効はセキュリティの根幹であり、不正アクセス防止のために最優先で実装する必要がある。

**Independent Test**: 職員がログイン後、30分間操作しないとセッションが失効し、再ログインを求められることで検証可能。

**Acceptance Scenarios**:

1. **Given** 職員がログイン済みで、30分間操作がない状態、**When** 職員が画面操作を試みる、**Then** セッションが失効しており、「セッションがタイムアウトしました。再度ログインしてください」というメッセージが表示され、ログイン画面に遷移する
2. **Given** 職員がログイン済みで、8時間が経過した状態、**When** 職員が画面操作を試みる、**Then** 操作中であってもセッションが強制失効し、同様のメッセージ表示とログイン画面への遷移が行われる
3. **Given** 職員がログイン済みで、29分間操作がなかった状態、**When** 職員が画面操作を行う、**Then** セッションは継続され、通常通り操作できる

---

### User Story 2 - 同時ログイン制限 (Priority: P2)

システム管理者として、同一アカウントの過剰な同時利用を防止し、セキュリティリスクを低減したい。また、ライセンス管理やリソース管理の観点からも制限が必要である。

**Why this priority**: 複数端末での不正利用やアカウント共有を防ぐため、タイムアウトに次いで重要なセキュリティ機能である。

**Independent Test**: 一般職員が4台目の端末からログインした際に、最も古いセッションが自動的に終了されることで検証可能。

**Acceptance Scenarios**:

1. **Given** 一般職員が既に3台の端末でログイン済み、**When** 4台目の端末からログインする、**Then** 最も古いセッションが自動的に終了され、4台目でのログインが成功する
2. **Given** 管理者が既に1台の端末でログイン済み、**When** 2台目の端末からログインする、**Then** 最も古いセッション（1台目）が自動的に終了され、2台目でのログインが成功する
3. **Given** 一般職員が2台の端末でログイン済み、**When** 3台目の端末からログインする、**Then** すべてのセッションが維持され、3台目でのログインも成功する

---

### User Story 3 - セッション永続化 (Priority: P3)

システム管理者として、セッション情報をデータベースに永続化し、サーバー障害やスケールアウト時にもセッション情報を維持したい。

**Why this priority**: システムの可用性と信頼性を確保するために必要だが、セキュリティ機能が優先される。

**Independent Test**: サーバー再起動後も、有効なセッションを持つ職員が再ログインなしで操作を継続できることで検証可能。

**Acceptance Scenarios**:

1. **Given** 職員がログイン済みの状態、**When** サーバーが再起動される、**Then** セッションが維持され、職員は再ログインなしで操作を継続できる
2. **Given** 複数サーバーでシステムが稼働している状態、**When** 職員のリクエストが別のサーバーに振り分けられる、**Then** セッションは維持され、職員は継続して操作できる

---

### User Story 4 - CSRF保護 (Priority: P4)

システム管理者として、クロスサイトリクエストフォージェリ（CSRF）攻撃からシステムを保護したい。

**Why this priority**: セキュリティ上重要だが、フレームワーク標準機能として実装されることが多いため、優先度は他のセッション機能より下げる。

**Independent Test**: 有効なCSRFトークンなしでフォーム送信を試みた際に、リクエストが拒否されることで検証可能。

**Acceptance Scenarios**:

1. **Given** 職員がログイン済みで、正しいCSRFトークンを持つフォーム、**When** フォームを送信する、**Then** リクエストは正常に処理される
2. **Given** 外部サイトから、CSRFトークンなしでAPIを呼び出そうとする、**When** リクエストが送信される、**Then** リクエストは拒否され、エラーが返される

---

### Edge Cases

- 職員がログイン後、ちょうど30分後に操作した場合、タイムアウトとして扱われる
- 絶対タイムアウト（8時間）とアイドルタイムアウト（30分）が同時に発生した場合、両方の条件を満たすためセッションは失効する
- 管理者権限を持つ職員が2台目にログインした際、1台目のセッションが強制終了され、適切なメッセージが表示される
- ネットワーク切断後に再接続した場合、セッションが有効期限内であれば継続して利用できる
- ブラウザのタブを複数開いている場合、すべてのタブで同一セッションが共有される
- セッションタイムアウト時に未保存のデータがある場合、警告なく失われる可能性がある（ユーザーは定期的に保存すべき）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、職員のセッション情報をデータベースに永続化しなければならない
- **FR-002**: システムは、30分間操作がないセッションを自動的に失効させなければならない（アイドルタイムアウト）
- **FR-003**: システムは、ログインから8時間経過したセッションを自動的に失効させなければならない（絶対タイムアウト）
- **FR-004**: システムは、一般職員の同時ログイン数を最大3台に制限しなければならない
- **FR-005**: システムは、管理者の同時ログイン数を最大1台に制限しなければならない
- **FR-006**: システムは、同時ログイン数の上限を超えた場合、最も古いセッションを自動的に終了しなければならない
- **FR-007**: システムは、セッション失効時に「セッションがタイムアウトしました。再度ログインしてください」というメッセージを表示し、ログイン画面に遷移させなければならない
- **FR-008**: システムは、すべてのフォーム送信でCSRFトークンを検証しなければならない
- **FR-009**: システムは、セッションCookieをセキュアな設定（HttpOnly、Secure、SameSite=Lax）で発行しなければならない
- **FR-010**: システムは、セッションデータを暗号化して保存しなければならない

### Key Entities

- **セッション**: 職員の認証状態を表す情報。セッションID、職員ID、IPアドレス、ユーザーエージェント、最終アクティビティ日時、作成日時を持つ
- **職員**: システムを利用するユーザー。一般職員と管理者の2種類があり、それぞれ同時ログイン数の制限が異なる

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: アイドル状態から30分±10秒以内にセッションが失効すること
- **SC-002**: ログインから8時間±1分以内にセッションが絶対タイムアウトすること
- **SC-003**: 一般職員の4台目のログイン試行時、1秒以内に最古のセッションが終了し新規ログインが完了すること
- **SC-004**: 管理者の2台目のログイン試行時、1秒以内に既存セッションが終了し新規ログインが完了すること
- **SC-005**: サーバー再起動後、有効なセッションを持つ職員の95%以上が再ログインなしで操作継続できること
- **SC-006**: CSRFトークンのないリクエストの100%が拒否されること
- **SC-007**: セッション失効時、3秒以内にユーザーにメッセージが表示されログイン画面に遷移すること

## Assumptions

- セッションタイムアウト時間（アイドル30分、絶対8時間）は本ストーリーで確定した値として扱う
- 同時ログイン数制限（職員3台、管理者1台）は本ストーリーで確定した値として扱う
- セッション切れ時のメッセージは「セッションがタイムアウトしました。再度ログインしてください」を使用する
- ネットワーク遅延による時間差は許容範囲（±10秒〜1分）として扱う
- 管理者と一般職員の判別は、既存の認証システムの権限情報を利用する
