# Feature Specification: アカウントロック機能

**Feature Branch**: `006-account-lock`
**Created**: 2025-12-26
**Status**: Draft
**Input**: User description: "ST-006: アカウントロック機能の実装 - ブルートフォース攻撃からアカウントを保護するため、ログイン失敗が一定回数を超えたアカウントを自動でロックする"

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ログイン失敗時の自動ロック (Priority: P1) 🎯 MVP

職員がログインに連続して失敗した場合、アカウントが自動的にロックされ、それ以上のログイン試行が拒否される。

**Why this priority**: ブルートフォース攻撃からの保護が本機能の主目的であり、この機能なくしてセキュリティ要件を満たせない。

**Independent Test**: 無効なパスワードで5回連続ログイン試行し、6回目以降でロックメッセージが表示されることを確認。

**Acceptance Scenarios**:

1. **Given** 有効なアカウント（未ロック状態）, **When** 誤ったパスワードで5回連続ログインを試みる, **Then** 5回目でアカウントがロックされる
2. **Given** ロックされたアカウント, **When** 正しいパスワードでログインを試みる, **Then** 「アカウントがロックされています。管理者にお問い合わせください」というエラーメッセージが表示される
3. **Given** ロックされたアカウント, **When** 誤ったパスワードでログインを試みる, **Then** 同様のロックメッセージが表示される（パスワードの正誤は開示しない）

---

### User Story 2 - ログイン成功時の失敗回数リセット (Priority: P1)

職員がログインに成功した場合、これまでの失敗回数がリセットされる。

**Why this priority**: 失敗回数のリセットがないと、正規ユーザーが意図せずロックされるリスクがあり、利便性を大きく損なう。

**Independent Test**: 3回失敗後に正しいパスワードでログインし、再度3回失敗してもロックされないことを確認。

**Acceptance Scenarios**:

1. **Given** 失敗回数が3回のアカウント, **When** 正しいパスワードでログインする, **Then** ログインが成功し、失敗回数が0にリセットされる
2. **Given** リセット後のアカウント, **When** 誤ったパスワードで4回連続ログインを試みる, **Then** アカウントはロックされない（5回未満のため）

---

### User Story 3 - ログイン失敗回数の記録 (Priority: P1)

システムが各ログイン試行の失敗を正確に記録し、連続失敗回数を追跡する。

**Why this priority**: 失敗回数の正確な記録がなければ、自動ロック機能が正しく動作しない。

**Independent Test**: 複数回のログイン失敗を行い、システムが失敗回数を正確にカウントしていることを確認。

**Acceptance Scenarios**:

1. **Given** 失敗回数0のアカウント, **When** 誤ったパスワードでログインを試みる, **Then** 失敗回数が1に増加する
2. **Given** 失敗回数2のアカウント, **When** 誤ったパスワードでログインを試みる, **Then** 失敗回数が3に増加する
3. **Given** 存在しないメールアドレス, **When** ログインを試みる, **Then** 特定のアカウントへの失敗回数は記録されない（情報漏洩防止）

---

### User Story 4 - ロックされたアカウントへのログイン試行 (Priority: P2)

ロックされたアカウントでのログイン試行時に、ユーザーに適切なエラーメッセージを表示する。

**Why this priority**: ユーザー体験として重要だが、ロック機能自体が動作していれば最低限のセキュリティは確保される。

**Independent Test**: ロック済みアカウントでログインを試み、適切なエラーメッセージが表示されることを確認。

**Acceptance Scenarios**:

1. **Given** ロックされたアカウント, **When** ログインを試みる, **Then** 「アカウントがロックされています。管理者にお問い合わせください」と表示される
2. **Given** ロックされたアカウント, **When** ログインを試みる, **Then** パスワードの正誤に関わらず同一のメッセージが表示される（セキュリティ対策）

---

### Edge Cases

- **同一アカウントへの同時ログイン試行**: 複数のブラウザ/端末から同時にログイン試行された場合、失敗回数が正確にカウントされる
- **ロック直前（4回失敗）の状態でのログイン成功**: 5回目の試行が成功した場合、ロックされずに失敗回数がリセットされる
- **存在しないアカウントへのログイン試行**: 特定アカウントの存在有無を推測できないエラーメッセージを表示する
- **ロック後の再度のログイン試行**: ロック状態が永続化され、再起動後もロック状態が維持される

---

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは各アカウントのログイン失敗回数を記録しなければならない
- **FR-002**: システムは5回連続でログイン失敗したアカウントを自動的にロックしなければならない
- **FR-003**: ロックされたアカウントでのログイン試行時、システムは「アカウントがロックされています。管理者にお問い合わせください」というメッセージを表示しなければならない
- **FR-004**: ログイン成功時、システムは該当アカウントの失敗回数を0にリセットしなければならない
- **FR-005**: ロック状態は永続化され、システム再起動後も維持されなければならない
- **FR-006**: システムはアカウントがロックされた日時を記録しなければならない
- **FR-007**: 認証エラーメッセージは、アカウントの存在有無やパスワードの正誤を推測できない内容でなければならない

### Key Entities

- **Staff（職員）**: ログイン認証の対象。失敗回数（failedLoginAttempts）、ロック状態（isLocked）、ロック日時（lockedAt）を持つ

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 5回連続のログイン失敗後、6回目以降のログイン試行は100%拒否される
- **SC-002**: ロックされたアカウントへのログイン試行時、1秒以内にエラーメッセージが表示される
- **SC-003**: ログイン成功後の失敗回数リセットが100%の確率で正常動作する
- **SC-004**: アカウントロック状態がシステム再起動後も100%維持される
- **SC-005**: 同時に100件のログイン試行が発生しても、失敗回数のカウントが正確に行われる
- **SC-006**: 本機能実装後、ブルートフォース攻撃による不正ログイン成功率が0%になる（5回以内に正解しない限り）

---

## Assumptions

- ロック解除機能は Phase 2 以降で実装され、本フィーチャーでは管理者による手動解除は対象外とする
- ロック状態の自動解除（時間経過による解除）は本フィーチャーでは実装しない
- 失敗回数のカウントはアカウント単位で行い、IP アドレス単位でのレート制限は別機能とする
- 認証失敗のログ記録は既存のログ機能を使用する
- 管理者への通知機能（メール等）は Phase 2 以降で検討する

---

## Out of Scope

- 管理者によるロック解除画面
- 一定時間後の自動ロック解除
- ロック通知メール送信
- ロック履歴の閲覧機能
- IP アドレスベースのレート制限
- CAPTCHA 認証の導入

---

## Dependencies

- 既存の職員認証機能（003-login-ui）が実装済みであること
- Staff エンティティが存在すること
- データベースに失敗回数とロック状態を保存できること
