# Research: アカウントロック機能

**Branch**: `006-account-lock` | **Date**: 2025-12-26

## 概要

本リサーチは、アカウントロック機能の実装に必要な技術調査結果をまとめる。バックエンドのコア実装は既に完了しているため、テスト戦略とフロントエンドのエラー表示に焦点を当てる。

---

## 既存実装の調査

### Decision 1: Staff エンティティのロック機能

**決定**: 既存の Staff エンティティを使用

**根拠**:
- `isLocked`, `failedLoginAttempts`, `lockedAt` プロパティが既に定義
- `lock()`, `unlock()`, `incrementFailedLoginAttempts()`, `resetFailedLoginAttempts()` メソッドが実装済み
- 追加の実装は不要

**検討した代替案**:
- 別途 AccountLock エンティティを作成 → Staff に統合済みのため不要

### Decision 2: LoginUseCase のロック判定

**決定**: 既存の LoginUseCase を使用

**根拠**:
- MAX_FAILED_ATTEMPTS = 5 が定数として定義
- ロック状態チェック → AccountLockedException 送出が実装済み
- パスワード失敗時の失敗回数インクリメントと5回でのロックが実装済み
- 成功時の失敗回数リセットが実装済み

**検討した代替案**:
- ロック判定を別のサービスに分離 → 現状のシンプルな実装で十分

### Decision 3: フロントエンドのエラーハンドリング

**決定**: 既存の authApi.ts のエラーハンドリングを活用

**根拠**:
- 423 ステータスコード（Locked）が `locked` タイプとして処理済み
- エラーメッセージ「アカウントがロックされています」が設定済み

**検討した代替案**:
- カスタムエラーコンポーネント作成 → 既存のエラー表示で対応可能

---

## テスト戦略

### Decision 4: バックエンドテストの構成

**決定**: 3 層のテスト構成

| レイヤー | テストファイル | 目的 |
|---------|---------------|------|
| Unit | `StaffAccountLockTest.php` | Staff エンティティのロック関連メソッド |
| Unit | `LoginUseCaseAccountLockTest.php` | LoginUseCase のロック判定ロジック |
| Feature | `AccountLockFeatureTest.php` | API 経由でのエンドツーエンド動作 |

**根拠**:
- DDD アーキテクチャに沿った分離
- 各レイヤーの責務を明確にテスト

### Decision 5: フロントエンドテストの構成

**決定**: 単体テスト + E2E テスト

| レイヤー | テストファイル | 目的 |
|---------|---------------|------|
| Unit | `LoginForm.test.tsx` | ロックエラー時のメッセージ表示（既存テストに追加） |
| E2E | `account-lock.spec.ts` | 5回失敗 → ロック → メッセージ表示の統合テスト |

**根拠**:
- 既存のテスト構造に統合
- ユーザーシナリオの検証に E2E が最適

---

## セキュリティ考慮事項

### Decision 6: エラーメッセージのセキュリティ

**決定**: アカウント存在有無を推測不可能なメッセージ設計

| シナリオ | メッセージ |
|---------|-----------|
| 認証失敗（存在しないアカウント） | メールアドレスまたはパスワードが正しくありません |
| 認証失敗（パスワード不一致） | メールアドレスまたはパスワードが正しくありません |
| アカウントロック | アカウントがロックされています。管理者にお問い合わせください |

**根拠**:
- 認証失敗時のメッセージを統一し、アカウント列挙攻撃を防止
- ロック状態は明示的に通知（ユーザー体験とセキュリティのバランス）

**検討した代替案**:
- ロック状態も認証失敗と同じメッセージ → ユーザー体験が著しく低下
- 詳細なエラーメッセージ → セキュリティリスク

---

## 実装優先度

| 優先度 | タスク | 理由 |
|--------|--------|------|
| 1 | バックエンド単体テスト | 既存実装の正当性検証が最優先 |
| 2 | バックエンド Feature テスト | API 経由での動作確認 |
| 3 | フロントエンド E2E テスト | エンドツーエンドのユーザーシナリオ検証 |
| 4 | フロントエンド単体テスト | ロックエラー表示のコンポーネントレベル検証 |

---

## 未解決事項

なし。既存実装が仕様を満たしており、テスト追加のみで完結する。
