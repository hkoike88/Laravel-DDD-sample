# Feature Specification: 職員アカウント編集機能

**Feature Branch**: `001-epic-004-staff-account-edit`
**Created**: 2026-01-06
**Status**: Draft
**Input**: User description: "EPIC-004: 職員アカウント編集機能 - 管理者が既存の職員アカウント情報を編集する機能を実装する。氏名、メールアドレス、権限の変更、およびパスワードのリセットが可能。楽観的ロックによる同時編集の競合検出を行う。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 職員基本情報の編集 (Priority: P1)

管理者として、職員の氏名、メールアドレス、権限を編集できる。これにより、職員の異動や役割変更に対応し、システムアクセス権を適切に維持できる。

**Why this priority**: 職員情報の編集は最も基本的かつ頻繁に使用される機能であり、職員管理の中核機能である。

**Independent Test**: 職員一覧から任意の職員を選択し、編集フォームで情報を変更して保存することで、単独でテスト可能。更新後の情報が一覧と詳細画面に反映されることを確認できる。

**Acceptance Scenarios**:

1. **Given** 管理者としてログインしている状態で職員一覧画面にいる、**When** 任意の職員の編集ボタンをクリックする、**Then** その職員の現在の情報が入力された編集フォームが表示される
2. **Given** 編集フォームが表示されている、**When** 氏名を変更して保存ボタンをクリックする、**Then** 「職員情報を更新しました」というメッセージが表示され、職員一覧画面にリダイレクトされる
3. **Given** 編集フォームが表示されている、**When** メールアドレスを変更して保存ボタンをクリックする、**Then** 変更が保存され、新しいメールアドレスが反映される
4. **Given** 編集フォームが表示されている、**When** 権限を「一般職員」から「管理者」に変更して保存する、**Then** 権限が更新される

---

### User Story 2 - パスワードリセット (Priority: P2)

管理者として、職員のパスワードをリセットし、新しい一時パスワードを発行できる。これにより、職員がパスワードを忘れた場合に対応できる。

**Why this priority**: パスワードリセットは職員がログインできなくなった場合の重要な回復手段であるが、基本的な編集機能の後に実装する。

**Independent Test**: 編集画面のパスワードリセットボタンをクリックし、新しい一時パスワードが表示されることを確認することで、単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** 職員の編集画面を表示している、**When** 「パスワードリセット」ボタンをクリックする、**Then** 確認ダイアログが表示される
2. **Given** パスワードリセットの確認ダイアログが表示されている、**When** 「リセット」を選択する、**Then** 新しい一時パスワードが画面に表示される
3. **Given** 一時パスワードが表示されている、**When** 「コピー」ボタンをクリックする、**Then** パスワードがクリップボードにコピーされる
4. **Given** 一時パスワードが発行された、**When** その職員が新しいパスワードでログインする、**Then** ログインに成功する

---

### User Story 3 - 自己権限変更の防止 (Priority: P2)

システムとして、管理者が自分自身の管理者権限を変更することを防止する。これにより、管理者が誤って自身の権限を失う事態を防ぐ。

**Why this priority**: セキュリティとシステム整合性の観点から重要な制約であり、権限変更機能と同時に実装が必要。

**Independent Test**: 管理者が自分自身の職員詳細を編集画面で開き、権限変更を試みることでテスト可能。

**Acceptance Scenarios**:

1. **Given** 管理者が自分自身の編集画面を表示している、**When** 権限フィールドを確認する、**Then** 権限フィールドが無効化（非活性）されている
2. **Given** 管理者が自分自身の編集画面を表示している、**When** APIを直接呼び出して権限変更を試みる、**Then** 「自分自身の権限は変更できません」というエラーが返される

---

### User Story 4 - 最後の管理者保護 (Priority: P2)

システムとして、最後の管理者アカウントの権限を一般職員に変更することを防止する。これにより、システムに管理者が存在しなくなる事態を防ぐ。

**Why this priority**: システムの整合性を保つための重要な制約であり、権限変更機能と同時に実装が必要。

**Independent Test**: システムに管理者が1人だけの状態で、その管理者の権限変更を試みることでテスト可能。

**Acceptance Scenarios**:

1. **Given** システムに管理者が1人だけ存在する、**When** その管理者の権限を「一般職員」に変更しようとする、**Then** 「最後の管理者アカウントの権限は変更できません」というエラーが表示される
2. **Given** システムに管理者が2人以上存在する、**When** そのうち1人の管理者の権限を「一般職員」に変更する、**Then** 変更が正常に保存される

---

### User Story 5 - 同時編集の競合検出 (Priority: P3)

システムとして、複数の管理者が同時に同じ職員情報を編集した場合に競合を検出し、データの整合性を保つ。

**Why this priority**: 同時編集は発生頻度が低いが、データ整合性の観点から対応が必要。基本機能の後に実装する。

**Independent Test**: 2つのブラウザタブで同じ職員の編集画面を開き、一方で保存した後にもう一方で保存を試みることでテスト可能。

**Acceptance Scenarios**:

1. **Given** 管理者Aと管理者Bが同じ職員の編集画面を開いている、**When** 管理者Aが先に保存し、その後管理者Bが保存しようとする、**Then** 管理者Bに「他のユーザーによって更新されています。最新の情報を確認してください」というエラーが表示される
2. **Given** 競合エラーが表示されている、**When** 「最新情報を取得」ボタンをクリックする、**Then** 最新のデータがフォームに再読み込みされる

---

### User Story 6 - 監査ログ記録 (Priority: P3)

システムとして、職員アカウントの編集操作を監査ログに記録する。これにより、誰がいつどのような変更を行ったかを追跡できる。

**Why this priority**: 監査要件として必要だが、ユーザー向け機能の後に実装する。

**Independent Test**: 職員情報を編集し、監査ログに記録が残っていることを確認することでテスト可能。

**Acceptance Scenarios**:

1. **Given** 管理者が職員情報を編集した、**When** 保存が完了する、**Then** 操作者ID、対象職員ID、変更内容、タイムスタンプが監査ログに記録される
2. **Given** 管理者がパスワードをリセットした、**When** リセットが完了する、**Then** パスワードリセット操作が監査ログに記録される（新しいパスワードは記録しない）

---

### Edge Cases

- 編集中に対象の職員アカウントが別の管理者によって無効化された場合、どうなるか？ → 保存時にエラーを表示し、一覧画面にリダイレクトする
- メールアドレスを既存の他の職員と同じものに変更しようとした場合、どうなるか？ → 「このメールアドレスは既に使用されています」というバリデーションエラーを表示する
- ネットワーク障害中に保存ボタンをクリックした場合、どうなるか？ → 「通信エラーが発生しました」というメッセージを表示し、再試行を促す
- 編集フォームで何も変更せずに保存ボタンをクリックした場合、どうなるか？ → 正常に処理され、「職員情報を更新しました」と表示される（変更がなくても更新日時は更新される）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは管理者が職員の詳細情報を取得できること
- **FR-002**: システムは管理者が職員の氏名を編集できること
- **FR-003**: システムは管理者が職員のメールアドレスを編集できること
- **FR-004**: システムは管理者が職員の権限（管理者/一般職員）を変更できること
- **FR-005**: システムはメールアドレスの一意性を検証し、重複する場合はエラーを返すこと
- **FR-006**: システムは管理者が自分自身の権限を変更しようとした場合にエラーを返すこと
- **FR-007**: システムは最後の管理者の権限を一般職員に変更しようとした場合にエラーを返すこと
- **FR-008**: システムは管理者が職員のパスワードをリセットできること
- **FR-009**: システムはパスワードリセット時に新しい一時パスワードを生成し、画面に表示すること
- **FR-010**: システムは更新成功時に成功メッセージを表示し、職員一覧画面にリダイレクトすること
- **FR-011**: システムは楽観的ロックにより同時編集の競合を検出し、競合時にエラーを返すこと
- **FR-012**: システムは職員情報の変更操作を監査ログに記録すること
- **FR-013**: システムはパスワードリセット操作を監査ログに記録すること（パスワード自体は記録しない）

### Key Entities

- **職員（Staff）**: 職員アカウントを表す。ID、氏名、メールアドレス、パスワード（ハッシュ化）、権限（管理者/一般職員）、更新日時を持つ
- **監査ログ（AuditLog）**: 操作の記録を表す。操作者ID、対象職員ID、操作種別（更新/パスワードリセット）、変更内容、タイムスタンプを持つ

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理者が職員情報の編集を3分以内に完了できる
- **SC-002**: 職員情報の更新処理が3秒以内に完了する
- **SC-003**: パスワードリセット操作が2秒以内に完了する
- **SC-004**: 同時編集の競合が100%検出され、データの不整合が発生しない
- **SC-005**: すべての編集操作が監査ログに100%記録される
- **SC-006**: 管理者が自分自身の権限変更を試みた場合、100%ブロックされる
- **SC-007**: 最後の管理者の権限変更を試みた場合、100%ブロックされる

## Assumptions

- EPIC-003（職員アカウント作成機能）が完了しており、職員一覧・詳細表示機能が利用可能である
- 管理者は既にログイン済みで、管理者権限を持っている
- 職員の削除（論理削除/無効化）はEPIC-005で実装するため、本機能には含まない
- パスワードリセット時の「次回ログインでパスワード変更を強制」機能はPhase 2として別途実装する
- 編集履歴の詳細表示（変更前後の値の比較）は本機能の範囲外とする
