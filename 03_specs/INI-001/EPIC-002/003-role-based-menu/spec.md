# Feature Specification: 権限別メニュー表示

**Feature Branch**: `003-role-based-menu`
**Created**: 2025-12-26
**Status**: Draft
**Input**: User description: "権限別メニュー表示の実装 - 管理者のみに管理メニューを表示し、一般職員が職員管理機能にアクセスできないようにする"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 管理者への管理メニュー表示 (Priority: P1)

管理者としてログインした場合、ダッシュボード画面に「管理メニュー」セクションが表示され、職員管理機能にアクセスできる。

**Why this priority**: 権限別表示機能の中核であり、管理者が職員管理を行うために必須の機能。

**Independent Test**: 管理者アカウントでログインし、ダッシュボードに管理メニューが表示され、職員管理画面に遷移できることを確認する。

**Acceptance Scenarios**:

1. **Given** 管理者権限を持つ職員がログインしている, **When** ダッシュボード画面を表示する, **Then** 「管理メニュー」セクションが表示される
2. **Given** 管理者がダッシュボードを表示している, **When** 「職員管理」メニューをクリックする, **Then** 職員管理画面（/staff/accounts）に遷移する

---

### User Story 2 - 一般職員からの管理メニュー非表示 (Priority: P1)

一般職員としてログインした場合、ダッシュボード画面に「管理メニュー」セクションが表示されず、管理機能へのアクセスが制限される。

**Why this priority**: セキュリティ要件として一般職員の管理機能へのアクセス制限は必須。

**Independent Test**: 一般職員アカウントでログインし、ダッシュボードに管理メニューが表示されないことを確認する。

**Acceptance Scenarios**:

1. **Given** 一般職員権限を持つ職員がログインしている, **When** ダッシュボード画面を表示する, **Then** 「管理メニュー」セクションが表示されない
2. **Given** 一般職員がログインしている, **When** ダッシュボード画面を表示する, **Then** 書籍検索などの一般職員向けメニューのみ表示される

---

### User Story 3 - 管理者専用URLへの直接アクセス制御 (Priority: P1)

一般職員が管理者専用URLに直接アクセスした場合、アクセスが拒否され適切なエラーが表示される。

**Why this priority**: URLの直接入力による不正アクセスを防ぐセキュリティ上必須の機能。

**Independent Test**: 一般職員アカウントでログイン後、ブラウザのアドレスバーに `/staff/accounts` を直接入力し、403エラーが返されることを確認する。

**Acceptance Scenarios**:

1. **Given** 一般職員がログインしている, **When** `/staff/accounts` に直接アクセスする, **Then** 403エラー（権限なし）が返される
2. **Given** 一般職員がログインしている, **When** 管理者専用URLにアクセスして403エラーを受ける, **Then** 「この操作を行う権限がありません」というメッセージが表示される
3. **Given** 未ログイン状態, **When** `/staff/accounts` に直接アクセスする, **Then** ログイン画面にリダイレクトされる

---

### Edge Cases

- 管理者がログアウトせずにセッションが切れた場合、管理者専用ページにアクセスすると再認証が求められる
- 権限情報が不正な場合（null や未定義）、一般職員として扱い管理メニューは非表示にする
- 管理者から一般職員に権限が変更された場合、次回のページ読み込み時に管理メニューが非表示になる

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは職員の権限（管理者/一般職員）に基づいてメニュー表示を制御しなければならない
- **FR-002**: システムは管理者権限を持つ職員に対してのみ「管理メニュー」セクションを表示しなければならない
- **FR-003**: システムは一般職員に対して「管理メニュー」セクションを表示してはならない
- **FR-004**: システムは管理者専用ルート（/staff/accounts 等）へのアクセスを権限チェックで保護しなければならない
- **FR-005**: システムは一般職員が管理者専用ルートにアクセスした場合、403ステータスコードと適切なエラーメッセージを返さなければならない
- **FR-006**: システムは認証時に取得したユーザー情報から権限を判定しなければならない
- **FR-007**: システムは権限情報が不正または未定義の場合、一般職員として扱わなければならない

### Key Entities

- **職員（Staff）**: 認証されたシステム利用者。権限属性（is_admin）を持ち、管理者または一般職員のいずれかである
- **権限（Role）**: 職員に付与される権限。現時点では管理者（admin）と一般職員（staff）の2種類

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理者でログインした場合、100%の確率で管理メニューが表示される
- **SC-002**: 一般職員でログインした場合、100%の確率で管理メニューが非表示になる
- **SC-003**: 一般職員が管理者専用URLに直接アクセスした場合、100%の確率で403エラーが返される
- **SC-004**: 権限チェックはページ読み込み時に1秒以内に完了する
- **SC-005**: 権限に基づくメニュー表示切り替えがユーザーに違和感なく行われる（ちらつきなし）

## Assumptions

- 職員の権限情報（is_admin フラグ）は既に Staff エンティティに実装されている
- 認証システム（Laravel Sanctum）は既に稼働している
- ダッシュボード画面は既に実装されており、メニューセクションの追加が可能な構造になっている
- 管理メニューには現時点では「職員管理」のみを含める（将来的に他の管理機能が追加される可能性あり）

## Scope Boundaries

### In Scope

- 権限に基づくメニュー表示/非表示の制御
- 管理者専用ルートのアクセス制御（フロントエンド・バックエンド両方）
- 403エラー時のエラーメッセージ表示

### Out of Scope

- 職員管理機能（CRUD）の実装（別ストーリーで対応）
- 権限の追加・変更・削除機能
- 権限の階層化や細分化
