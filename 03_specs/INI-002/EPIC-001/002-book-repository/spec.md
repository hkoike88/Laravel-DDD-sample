# Feature Specification: 蔵書リポジトリ実装

**Feature Branch**: `002-book-repository`
**Created**: 2025-12-24
**Status**: Draft
**Input**: ST-002: 蔵書リポジトリの実装

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 蔵書の永続化 (Priority: P1)

開発者として、ドメイン層で作成した蔵書エンティティをデータベースに保存し、後から取得できるようにしたい。なぜなら、蔵書情報を永続的に管理し、アプリケーション再起動後もデータを保持したいからだ。

**Why this priority**: 蔵書データの永続化は図書館システムの最も基本的な機能であり、検索・貸出・返却などすべての業務がこの機能に依存する。

**Independent Test**: 蔵書エンティティを保存し、IDで取得して元のデータと一致することを確認することで単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** 有効な蔵書エンティティが存在する場合、**When** リポジトリのsaveメソッドで保存する、**Then** 蔵書がデータベースに永続化される
2. **Given** 保存済みの蔵書が存在する場合、**When** 蔵書IDで検索する、**Then** 元の蔵書と同一の情報が取得できる
3. **Given** 存在しない蔵書IDで検索した場合、**When** findOrNullメソッドを使用する、**Then** nullが返却される
4. **Given** 存在しない蔵書IDで検索した場合、**When** findメソッドを使用する、**Then** 例外が発生する

---

### User Story 2 - ISBN による蔵書検索 (Priority: P1)

開発者として、ISBN番号で蔵書を検索できるようにしたい。なぜなら、同じ書籍の複本（複数所蔵）を効率的に見つけ、在庫状況を確認したいからだ。

**Why this priority**: ISBNは書籍の国際標準識別子であり、蔵書検索の重要な手段。複本管理や在庫確認に必須。

**Independent Test**: 同一ISBNを持つ複数の蔵書を保存し、ISBN検索で全件取得できることを確認することで単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** 同一ISBNを持つ蔵書が3冊存在する場合、**When** ISBNで検索する、**Then** 3冊すべてが取得される
2. **Given** 該当ISBNの蔵書が存在しない場合、**When** ISBNで検索する、**Then** 空の配列が返却される

---

### User Story 3 - 条件指定による蔵書検索 (Priority: P1)

開発者として、タイトル・著者・出版社などの条件を組み合わせて蔵書を検索できるようにしたい。なぜなら、利用者が様々な条件で蔵書を探せるようにしたいからだ。

**Why this priority**: 蔵書検索は図書館システムの中核機能であり、利用者サービスに直結する。

**Independent Test**: 複数の蔵書を登録し、各種条件で検索して期待する結果が得られることを確認することで単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** タイトルに「ドメイン駆動設計」を含む蔵書が存在する場合、**When** タイトル条件で検索する、**Then** 該当する蔵書のみが取得される
2. **Given** 著者「エリック・エヴァンス」の蔵書が存在する場合、**When** 著者条件で検索する、**Then** 該当する蔵書のみが取得される
3. **Given** 複数の検索条件（タイトルと著者）を指定した場合、**When** 検索を実行する、**Then** すべての条件を満たす蔵書のみが取得される
4. **Given** ステータスが「利用可能」の蔵書のみを検索したい場合、**When** ステータス条件で検索する、**Then** 利用可能な蔵書のみが取得される

---

### User Story 4 - 蔵書情報の更新 (Priority: P2)

開発者として、既存の蔵書情報を更新し、変更を永続化できるようにしたい。なぜなら、蔵書の状態変更（貸出・返却）や書誌情報の修正を反映したいからだ。

**Why this priority**: 蔵書の状態管理（貸出・返却）や情報修正に必要だが、新規登録と検索が先に機能する必要がある。

**Independent Test**: 蔵書を保存後、情報を更新して再保存し、更新内容が反映されていることを確認することで単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** 保存済みの蔵書が存在する場合、**When** ステータスを変更して保存する、**Then** 変更後のステータスがデータベースに反映される
2. **Given** 保存済みの蔵書が存在する場合、**When** 書誌情報を修正して保存する、**Then** 修正内容がデータベースに反映される

---

### User Story 5 - 蔵書の削除 (Priority: P3)

開発者として、不要になった蔵書レコードを削除できるようにしたい。なぜなら、廃棄された書籍や登録ミスのデータを整理したいからだ。

**Why this priority**: 削除機能は運用上必要だが、登録・検索・更新機能が優先。

**Independent Test**: 蔵書を保存後に削除し、再検索で取得できないことを確認することで単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** 保存済みの蔵書が存在する場合、**When** 蔵書を削除する、**Then** データベースから削除され、以降の検索で取得されない
2. **Given** 存在しない蔵書IDで削除を試みた場合、**When** deleteメソッドを実行する、**Then** エラーは発生しない（冪等性を保証）

---

### User Story 6 - 検索結果件数の取得 (Priority: P2)

開発者として、検索条件に一致する蔵書の件数を効率的に取得したい。なぜなら、検索結果のページネーションやUI表示に件数情報が必要だからだ。

**Why this priority**: ページネーション実装やUI表示に必要だが、基本的な検索機能の後に実装可能。

**Independent Test**: 複数の蔵書を登録し、条件に一致する件数が正しく返されることを確認することで単独でテスト可能。

**Acceptance Scenarios**:

1. **Given** 検索条件に一致する蔵書が10件存在する場合、**When** 件数を取得する、**Then** 10が返却される
2. **Given** 条件に一致する蔵書が存在しない場合、**When** 件数を取得する、**Then** 0が返却される

---

### Edge Cases

- 非常に長いタイトル（255文字以上）を持つ蔵書を保存する場合、どう扱うか？ → タイトルは255文字を上限とし、超過する場合は切り詰める
- 検索条件に特殊文字（SQL特殊文字、ワイルドカード等）が含まれる場合のエスケープ処理
- 大量の蔵書（10万件以上）が存在する場合の検索パフォーマンス
- 同時に複数のプロセスから同一蔵書を更新する場合の競合処理 → 楽観的ロックを採用し、競合時は例外をスロー
- ISBNがnullの蔵書に対するISBN検索 → 結果に含めない

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは蔵書エンティティをデータベースに永続化できなければならない
- **FR-002**: システムは蔵書IDにより蔵書を一意に取得できなければならない
- **FR-003**: システムはISBN番号により蔵書を検索できなければならない（複本対応）
- **FR-004**: システムは以下の条件で蔵書を検索できなければならない：
  - タイトル（部分一致）
  - 著者（部分一致）
  - 出版社（部分一致）
  - ジャンル（完全一致）
  - ステータス（完全一致）
  - 出版年（範囲指定）
- **FR-005**: システムは複数の検索条件をAND条件で組み合わせて検索できなければならない
- **FR-006**: システムは検索条件に一致する蔵書の件数を取得できなければならない
- **FR-007**: システムは既存の蔵書情報を更新し永続化できなければならない
- **FR-008**: システムは蔵書を削除できなければならない
- **FR-009**: リポジトリはドメイン層とインフラストラクチャ層を分離し、データアクセスを抽象化しなければならない
- **FR-010**: データベーススキーマは蔵書エンティティの全属性を格納できなければならない
- **FR-011**: 検索結果はページネーション（ページ番号とページサイズ指定）に対応しなければならない
- **FR-012**: 検索結果はソート順（タイトル昇順/降順、出版年昇順/降順等）を指定できなければならない

### Key Entities

- **Book（蔵書）**: 001-book-entity-designで定義された蔵書エンティティ。永続化対象。

- **BookSearchCriteria（検索条件）**: 蔵書検索の条件を表す。タイトル、著者、出版社、ジャンル、ステータス、出版年範囲、ページ番号、ページサイズ、ソート順を含む。

- **BookCollection（蔵書コレクション）**: 検索結果の蔵書リストを表す。ページネーション情報（総件数、現在ページ、総ページ数）を含む。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 蔵書の保存処理が1秒以内に完了する
- **SC-002**: 蔵書IDによる単一検索が100ミリ秒以内に完了する
- **SC-003**: 条件検索（1万件のデータベース）が1秒以内に結果を返す
- **SC-004**: リポジトリの統合テストカバレッジが90%以上である
- **SC-005**: 同時に100件の蔵書保存処理が競合なく完了する
- **SC-006**: 検索インデックスにより、タイトル・著者・ISBNでの検索が効率的に行われる

## Assumptions

- 001-book-entity-designで定義されたBook、BookId、ISBN、BookStatusのValue Objectは実装済み
- データベースはMySQLを使用（docker-compose.ymlで定義済み）
- 蔵書IDはULID形式（26文字）で永続化
- ISBNは正規化された形式（ハイフンなし）で永続化
- 検索のソート順デフォルトはタイトル昇順
- ページサイズのデフォルトは20件、最大は100件
- 削除は物理削除とする（論理削除は将来の拡張で検討）

## Dependencies

- 001-book-entity-design: Book、BookId、ISBN、BookStatusの実装が必要
