# 異常系テストケース: 蔵書検索画面

**Feature**: 004-book-search-ui
**Created**: 2025-12-24
**Type**: 異常系（Error Cases）

---

## ネットワークエラー

### TC-E001: API接続エラー（サーバー停止）

**前提条件**: バックエンドAPIサーバーが停止している

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | 検索条件を入力 | 入力値が表示される |
| 2 | 検索ボタンをクリック | ローディング表示が出る |
| 3 | タイムアウト後 | エラーメッセージが表示される |

**検証項目**:
- [ ] 「ネットワークエラーが発生しました」等のメッセージが表示される
- [ ] 「再試行」ボタンが表示される
- [ ] 画面がクラッシュしない

**Expected Error Message**:
```
検索中にエラーが発生しました
ネットワークエラーが発生しました。
[再試行]
```

---

### TC-E002: API接続エラー（ネットワーク切断）

**前提条件**: ネットワーク接続が切断されている（オフライン状態）

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | 検索ボタンをクリック | ローディング表示が出る |
| 2 | エラー発生後 | オフラインエラーメッセージが表示される |

**検証項目**:
- [ ] ネットワーク関連のエラーメッセージが表示される
- [ ] 再試行機能が提供される

---

### TC-E003: API 500エラー（サーバー内部エラー）

**前提条件**: APIが500 Internal Server Errorを返す

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | 検索ボタンをクリック | ローディング表示が出る |
| 2 | 500エラー受信後 | サーバーエラーメッセージが表示される |

**検証項目**:
- [ ] 「サーバーエラーが発生しました」等のメッセージが表示される
- [ ] 技術的な詳細（スタックトレース等）は表示されない
- [ ] 再試行ボタンが表示される

---

### TC-E004: API 503エラー（サービス利用不可）

**前提条件**: APIが503 Service Unavailableを返す

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | 検索ボタンをクリック | ローディング表示が出る |
| 2 | 503エラー受信後 | サービス利用不可メッセージが表示される |

**検証項目**:
- [ ] 「しばらくしてから再度お試しください」等のメッセージが表示される

---

## バリデーションエラー

### TC-E005: API 422エラー（バリデーションエラー）

**前提条件**: APIが422 Unprocessable Entityを返す

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | 不正なパラメータで検索（per_page=1000等） | 検索が実行される |
| 2 | 422エラー受信後 | バリデーションエラーメッセージが表示される |

**検証項目**:
- [ ] APIからのエラーメッセージが表示される
- [ ] どのフィールドがエラーか分かる

**Expected API Response**:
```json
{
  "message": "The given data was invalid.",
  "errors": {
    "per_page": ["1ページあたりの件数は100以下で入力してください"]
  }
}
```

---

## タイムアウト

### TC-E006: APIタイムアウト（応答遅延）

**前提条件**: APIの応答が5秒以上遅延する

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | 検索ボタンをクリック | ローディング表示が出る |
| 2 | 5秒経過後 | タイムアウトメッセージが表示される |

**検証項目**:
- [ ] 「接続がタイムアウトしました」等のメッセージが表示される
- [ ] 再試行ボタンが表示される
- [ ] ユーザーが長時間待たされない

---

## 再試行機能

### TC-E007: エラー後の再試行成功

**前提条件**: エラーが発生してエラーメッセージが表示されている

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | 「再試行」ボタンをクリック | ローディング表示が出る |
| 2 | API正常応答後 | 検索結果が表示される |

**検証項目**:
- [ ] エラーメッセージが消える
- [ ] 正常な検索結果が表示される

---

### TC-E008: エラー後の再試行失敗

**前提条件**: エラーが発生してエラーメッセージが表示されている、APIはまだ利用不可

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | 「再試行」ボタンをクリック | ローディング表示が出る |
| 2 | 再度エラー受信後 | エラーメッセージが再表示される |

**検証項目**:
- [ ] 再試行ボタンが引き続き表示される
- [ ] エラーメッセージが更新される

---

## CORSエラー

### TC-E009: CORSエラー

**前提条件**: バックエンドのCORS設定が不正

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | 検索ボタンをクリック | ローディング表示が出る |
| 2 | CORSエラー発生後 | ネットワークエラーメッセージが表示される |

**検証項目**:
- [ ] ユーザーに理解可能なエラーメッセージが表示される
- [ ] 開発者ツールのコンソールにCORSエラーが記録される

---

## 不正なAPIレスポンス

### TC-E010: 不正なJSONレスポンス

**前提条件**: APIが不正なJSON形式のレスポンスを返す

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | 検索ボタンをクリック | ローディング表示が出る |
| 2 | パースエラー発生後 | エラーメッセージが表示される |

**検証項目**:
- [ ] 画面がクラッシュしない
- [ ] 適切なエラーメッセージが表示される

---

### TC-E011: レスポンスの必須フィールド欠落

**前提条件**: APIレスポンスに必須フィールド（data, meta）が欠落

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | 検索ボタンをクリック | ローディング表示が出る |
| 2 | 不完全なレスポンス受信後 | エラーまたはフォールバック表示 |

**検証項目**:
- [ ] 画面がクラッシュしない
- [ ] undefined/null参照エラーが発生しない

---

## 認証・認可エラー（将来対応）

### TC-E012: API 401エラー（未認証）

**前提条件**: APIが401 Unauthorizedを返す（将来の認証機能追加時）

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | 検索ボタンをクリック | ローディング表示が出る |
| 2 | 401エラー受信後 | 認証エラーメッセージが表示される |

**検証項目**:
- [ ] 「認証が必要です」等のメッセージが表示される
- [ ] ログイン画面へのリダイレクト（該当する場合）

---

### TC-E013: API 403エラー（権限なし）

**前提条件**: APIが403 Forbiddenを返す

| Step | Action | Expected Result |
|------|--------|-----------------|
| 1 | 検索ボタンをクリック | ローディング表示が出る |
| 2 | 403エラー受信後 | 権限エラーメッセージが表示される |

**検証項目**:
- [ ] 「アクセス権限がありません」等のメッセージが表示される

---

## Notes

- 異常系テストはMSW（Mock Service Worker）でAPIレスポンスをモックして実行
- ネットワークエラーのテストはブラウザの開発者ツールでオフラインモードを使用
- 本番環境では詳細なエラー情報を表示しないこと（セキュリティ考慮）
- エラー発生時はコンソールにログを出力（デバッグ用）
