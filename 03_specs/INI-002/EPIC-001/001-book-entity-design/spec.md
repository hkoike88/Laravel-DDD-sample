# Feature Specification: 蔵書エンティティ・Value Object 設計

**Feature Branch**: `001-book-entity-design`
**Created**: 2025-12-24
**Status**: Draft
**Input**: ST-001: 蔵書エンティティ・Value Object の設計

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 蔵書情報の管理 (Priority: P1)

開発者として、蔵書の基本情報（タイトル、著者、ISBN、出版社、出版年、ジャンル）を一貫した形式で管理できるドメインモデルを使用したい。なぜなら、図書館システム全体で蔵書データの整合性を保証し、ビジネスルールを適切に適用したいからだ。

**Why this priority**: 蔵書情報の管理は図書館システムの根幹であり、他のすべての機能（検索、貸出、予約）がこのモデルに依存する。最も重要な基盤機能である。

**Independent Test**: 蔵書エンティティを作成し、各属性が正しく保持されることを確認することで単独でテスト可能。新規蔵書の登録とその情報の取得が正しく動作することを検証できる。

**Acceptance Scenarios**:

1. **Given** 有効な蔵書情報（タイトル、著者、ISBN等）が存在する場合、**When** 新しい蔵書を作成する、**Then** すべての属性が正しく保持された蔵書エンティティが生成される
2. **Given** 蔵書エンティティが存在する場合、**When** 蔵書IDで検索する、**Then** 該当する蔵書の完全な情報が取得できる
3. **Given** タイトルが空の場合、**When** 蔵書を作成しようとする、**Then** 検証エラーが発生し蔵書は作成されない

---

### User Story 2 - ISBN バリデーション (Priority: P1)

開発者として、ISBNの形式が国際標準（ISBN-10またはISBN-13）に準拠していることを自動的に検証したい。なぜなら、不正なISBN形式のデータがシステムに登録されることを防ぎ、外部システムとの連携時のデータ品質を保証したいからだ。

**Why this priority**: ISBNは書籍を一意に識別する国際標準であり、外部システム連携や書籍情報の正確性に直結する。データ品質の根幹に関わる。

**Independent Test**: ISBNの妥当性検証を単独でテスト可能。有効なISBN-10/ISBN-13が受理され、不正な形式が拒否されることを検証できる。

**Acceptance Scenarios**:

1. **Given** 有効なISBN-13形式（例：978-4-XXXX-XXXX-X）の場合、**When** ISBNを作成する、**Then** ISBNオブジェクトが正常に生成される
2. **Given** 有効なISBN-10形式（例：4-XXXX-XXXX-X）の場合、**When** ISBNを作成する、**Then** ISBNオブジェクトが正常に生成される
3. **Given** チェックディジットが不正なISBNの場合、**When** ISBNを作成しようとする、**Then** 検証エラーが発生しISBNは作成されない
4. **Given** 形式が不正な文字列（桁数不足、不正文字含む等）の場合、**When** ISBNを作成しようとする、**Then** 検証エラーが発生しISBNは作成されない

---

### User Story 3 - 蔵書ステータス管理 (Priority: P1)

開発者として、蔵書の貸出状態（利用可能/貸出中/予約中）をドメインモデルで管理し、不正な状態遷移を防止したい。なぜなら、蔵書の貸出・返却・予約のビジネスルールを正しく適用し、二重貸出などの問題を防ぎたいからだ。

**Why this priority**: 貸出状態の管理は図書館の中核業務であり、不正な状態遷移は利用者へのサービス品質に直接影響する。

**Independent Test**: 蔵書ステータスの遷移ルールを単独でテスト可能。許可された状態遷移のみが成功し、不正な遷移が拒否されることを検証できる。

**Acceptance Scenarios**:

1. **Given** 蔵書が「利用可能」状態の場合、**When** 貸出処理を行う、**Then** ステータスが「貸出中」に変更される
2. **Given** 蔵書が「貸出中」状態の場合、**When** 返却処理を行う、**Then** ステータスが「利用可能」に変更される
3. **Given** 蔵書が「利用可能」状態の場合、**When** 予約処理を行う、**Then** ステータスが「予約中」に変更される
4. **Given** 蔵書が「貸出中」状態の場合、**When** 貸出処理を行おうとする、**Then** エラーが発生し状態は変更されない
5. **Given** 蔵書が「利用可能」状態の場合、**When** 返却処理を行おうとする、**Then** エラーが発生する（既に返却済みのため）

---

### User Story 4 - 蔵書IDの一意性保証 (Priority: P2)

開発者として、各蔵書に一意の識別子を割り当て、システム全体で確実に蔵書を識別したい。なぜなら、同一書籍の複数所蔵や蔵書間の関連付けを正確に管理したいからだ。

**Why this priority**: 一意識別は重要だが、基本的なエンティティ設計の一部として実装される。独立した優先度としてはP2。

**Independent Test**: 蔵書IDの生成と一意性を単独でテスト可能。各蔵書に固有のIDが割り当てられ、重複がないことを検証できる。

**Acceptance Scenarios**:

1. **Given** 新しい蔵書を作成する場合、**When** 蔵書IDを生成する、**Then** 一意の識別子が割り当てられる
2. **Given** 2つの蔵書が存在する場合、**When** それぞれの蔵書IDを比較する、**Then** 異なる値であることが保証される
3. **Given** 既存の蔵書IDが存在する場合、**When** そのIDで蔵書を検索する、**Then** 正確に該当する蔵書が取得される

---

### Edge Cases

- 蔵書タイトルに特殊文字（絵文字、特殊記号等）が含まれる場合、正しく保存・表示されるか？
- ISBNがない古い書籍（ISBN制度導入前の出版物）をどう扱うか？ → ISBNはオプショナルとし、nullを許容する
- 著者が複数いる書籍の場合、著者情報をどう保持するか？ → 現段階では単一の著者名文字列として保持（将来的に複数著者対応を検討）
- 出版年が不明な書籍の場合の扱い → 出版年はオプショナルとし、nullを許容する
- 同一ISBNの書籍が複数冊ある場合（複本）→ 各冊は異なる蔵書IDを持ち、ISBNは同一でも問題ない

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは蔵書エンティティを作成・保持できなければならない
- **FR-002**: 蔵書エンティティは以下の属性を持たなければならない：蔵書ID（必須）、タイトル（必須）、著者（任意）、ISBN（任意）、出版社（任意）、出版年（任意）、ジャンル（任意）、ステータス（必須）
- **FR-003**: 蔵書IDは一意の識別子として機能しなければならない
- **FR-004**: ISBNはISBN-10またはISBN-13の国際標準形式に準拠していなければならない
- **FR-005**: ISBNのチェックディジットは正しく検証されなければならない
- **FR-006**: 蔵書ステータスは「利用可能」「貸出中」「予約中」の3状態を持たなければならない
- **FR-007**: 蔵書ステータスの遷移は以下のルールに従わなければならない：
  - 「利用可能」→「貸出中」：貸出時
  - 「貸出中」→「利用可能」：返却時
  - 「利用可能」→「予約中」：予約時
  - 「予約中」→「貸出中」：予約者への貸出時
  - 「予約中」→「利用可能」：予約キャンセル時
- **FR-008**: 不正な状態遷移（例：貸出中→貸出中）は拒否されなければならない
- **FR-009**: タイトルは空であってはならない
- **FR-010**: ドメインモデルは単体テストで検証可能でなければならない

### Key Entities

- **Book（蔵書）**: 図書館が所蔵する書籍を表すエンティティ。一意の蔵書ID、書誌情報（タイトル、著者、ISBN等）、および貸出状態を持つ。蔵書検索・貸出・返却・予約の対象となる中心的なドメインオブジェクト。

- **BookId（蔵書ID）**: 蔵書を一意に識別するための識別子。同一書籍の複本も区別できる。

- **ISBN（国際標準図書番号）**: 書籍を国際的に識別するための番号。ISBN-10またはISBN-13形式をサポート。チェックディジットによる妥当性検証を含む。

- **BookStatus（蔵書ステータス）**: 蔵書の現在の貸出状態を表す。利用可能（available）、貸出中（borrowed）、予約中（reserved）の3状態を持ち、状態遷移ルールを管理する。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 蔵書の新規登録から情報確認までの操作が3秒以内に完了する
- **SC-002**: すべてのドメインルール（ISBN検証、状態遷移）の単体テストカバレッジが100%である
- **SC-003**: 不正なISBN形式または不正な状態遷移の100%が拒否される
- **SC-004**: 蔵書情報の検索結果が1秒以内に返却される
- **SC-005**: 同時に100件の蔵書登録処理が競合なく完了する
- **SC-006**: 蔵書ステータスの更新が即座に反映され、二重貸出が発生しない

## Assumptions

- ISBN-10とISBN-13の両方をサポートするが、新規登録時は可能な限りISBN-13を推奨する
- 著者情報は現段階では単一の文字列として保持し、複数著者は「,」区切りで記載する運用とする
- 蔵書IDの採番方式はULIDを使用する（ADR-0006に基づく）
- ジャンルは現段階では自由入力の文字列とし、将来的にマスタ管理への移行を検討する
- 蔵書の物理的な状態（破損、紛失等）は本エンティティの範囲外とし、別途管理する
