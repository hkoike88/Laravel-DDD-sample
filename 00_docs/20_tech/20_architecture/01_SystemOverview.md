# システムアーキテクチャ概要

## 概要

本ドキュメントは、図書館デジタル化システムの全体アーキテクチャを定義する。フロントエンドとバックエンドを分離した **SPA + REST API** 構成を採用し、各層で適切なアーキテクチャパターンを適用する。

---

## 技術ドキュメント構成

```
00_docs/20_tech/
├── 10_team/                            # チーム標準
│   ├── dod.md                          # Definition of Done
│   └── dor.md                          # Definition of Ready
│
├── 20_architecture/                    # アーキテクチャ設計
│   ├── 01_SystemOverview.md            # システム概要（本ドキュメント）
│   ├── adr/                            # アーキテクチャ決定記録（ADR）
│   │   ├── README.md
│   │   ├── ADR-0001_Frontend-Framework.md
│   │   ├── ADR-0002_Backend-Framework.md
│   │   ├── ADR-0003_Database.md
│   │   ├── ADR-0004_State-Management.md
│   │   ├── ADR-0005_Authentication.md
│   │   ├── ADR-0006_ID-Strategy.md
│   │   ├── ADR-0007_CSS-Framework.md
│   │   └── ADR-0008_Build-Tool.md
│   ├── backend/                        # バックエンドアーキテクチャ
│   │   ├── 01_ArchitectureDesign.md    # DDD アーキテクチャ設計
│   │   └── 01_ArchitectureDesign/      # 詳細ドキュメント
│   │       ├── 00_概要.md
│   │       ├── 01_アーキテクチャ設計.md
│   │       ├── 02_実装パターン.md
│   │       ├── 03_ディレクトリ構成例.md
│   │       ├── 04_テスト戦略.md
│   │       └── 05_段階的移行ガイド.md
│   └── frontend/                       # フロントエンドアーキテクチャ
│       └── 01_ArchitectureDesign.md    # Feature-based アーキテクチャ設計
│
└── 99_standard/                        # 設計標準・規約
    ├── security/                       # セキュリティ
    │   └── SECURITY.md                 # セキュリティポリシー
    ├── backend/                        # バックエンド標準
    │   ├── 00_Overview.md              # 概要・構成一覧
    │   ├── 01_CodingStandards.md       # コーディング規約
    │   ├── 02_SecurityDesign.md        # セキュリティ設計
    │   ├── 03_Non-FunctionalRequirements.md  # 非機能要件
    │   ├── 04_LoggingDesign.md         # ログ設計
    │   ├── 05_ApiDesign.md             # API 設計
    │   ├── 06_ErrorHandling.md         # エラーハンドリング
    │   ├── 07_DatabaseDesign.md        # データベース設計
    │   ├── 08_ValidationDesign.md      # バリデーション設計
    │   ├── 09_ExternalIntegration.md   # 外部連携設計
    │   └── 10_BatchProcessing.md       # バッチ処理設計
    └── frontend/                       # フロントエンド標準
        ├── 00_Overview.md              # 概要・構成一覧
        ├── 01_CodingStandards.md       # コーディング規約
        ├── 02_SecurityDesign.md        # セキュリティ設計
        └── 03_Non-FunctionalRequirements.md  # 非機能要件
```

---

## システム構成図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              クライアント層                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         Web ブラウザ                                   │  │
│  │                    (Chrome / Firefox / Safari / Edge)                 │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ HTTPS
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              フロントエンド                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                    React + TypeScript (SPA)                           │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │  │
│  │  │   Pages     │→ │  Features   │→ │   Hooks     │→ │  Services   │  │  │
│  │  │ (ルーティング) │  │ (機能単位UI) │  │ (ロジック)   │  │ (API通信)   │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │  │
│  │                                                                       │  │
│  │  状態管理: TanStack Query (サーバー状態) + Zustand (クライアント状態)     │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                 Vite (ビルド・配信)                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ REST API (JSON)
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                                Nginx                                        │
│                    (リバースプロキシ / 静的ファイル配信)                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              バックエンド                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                    Laravel (PHP 8.2+) - DDD アーキテクチャ              │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │                      Presentation 層                            │  │  │
│  │  │               (Controller / Request / Resource)                 │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                                  │                                    │  │
│  │                                  ▼                                    │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │                      Application 層                             │  │  │
│  │  │                  (UseCase / DTO / Repository実装)                │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                                  │                                    │  │
│  │                                  ▼                                    │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │                        Domain 層                                │  │  │
│  │  │          (Entity / ValueObject / DomainService / Repository IF) │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                                  ▲                                    │  │
│  │                                  │                                    │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │                     Infrastructure 層                           │  │  │
│  │  │                (Eloquent Model / 外部サービス連携)                │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                              Laravel Sanctum (認証)                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ Eloquent ORM
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              データベース層                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         MySQL 8.0                                     │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 技術スタック一覧

### フロントエンド

| 項目 | 技術 | バージョン | 用途 |
|------|------|-----------|------|
| 言語 | TypeScript | 5.7 | 型安全な開発 |
| UI ライブラリ | React | 18.3 | コンポーネントベース UI |
| ビルドツール | Vite | 6.0 | 高速ビルド・HMR |
| 状態管理（サーバー） | TanStack Query | 5.62 | API データキャッシュ |
| 状態管理（クライアント） | Zustand | 5.0 | グローバル状態管理 |
| ルーティング | React Router | 7.1 | SPA ルーティング |
| HTTP クライアント | Axios | 1.7 | API 通信 |
| フォーム | React Hook Form | 7.54 | フォームバリデーション |
| バリデーション | Zod | 3.24 | スキーマバリデーション |
| スタイリング | Tailwind CSS | 3.4 | ユーティリティファースト CSS |

### バックエンド

| 項目 | 技術 | バージョン | 用途 |
|------|------|-----------|------|
| 言語 | PHP | 8.3 | 型宣言・属性を活用 |
| フレームワーク | Laravel | 11.36 | REST API 構築 |
| ORM | Eloquent | - | DB 操作 |
| 認証 | Laravel Sanctum | 4.0 | SPA 認証・API トークン |
| 静的解析 | PHPStan / Larastan | 2.0 / 2.9 | 型チェック |
| テスト | Pest | 3.7 | ユニット・フィーチャーテスト |

### インフラストラクチャ

| 項目 | 技術 | 用途 |
|------|------|------|
| Web サーバー | Nginx | リバースプロキシ・静的配信 |
| データベース | MySQL 8.0 | データ永続化 |
| コンテナ | Docker / Docker Compose | 開発環境構築 |
| バージョン管理 | Git | ソースコード管理 |

---

## アーキテクチャ方針

### フロントエンド: Feature-based アーキテクチャ

```
src/
├── app/                      # アプリケーション設定
│   ├── App.tsx
│   ├── router.tsx
│   └── providers/
├── pages/                    # ページコンポーネント
│   ├── Books/
│   ├── Loans/
│   └── Auth/
├── features/                 # 機能モジュール
│   ├── books/
│   │   ├── components/
│   │   ├── hooks/
│   │   ├── services/
│   │   └── types/
│   ├── loans/
│   └── auth/
├── components/               # 共通 UI コンポーネント
│   ├── ui/
│   └── layout/
├── hooks/                    # 共通 Hooks
├── lib/                      # ユーティリティ
└── types/                    # グローバル型定義
```

**レイヤー依存関係:**
```
[Pages] → [Features] → [Hooks] → [Services]
              ↓
         [Components]
```

### バックエンド: DDD（ドメイン駆動設計）

```
packages/
├── {BoundedContext}/         # 境界づけられたコンテキスト
│   └── {Domain}/             # ドメイン
│       ├── Domain/           # ビジネスロジック
│       │   ├── Model/        # Entity / ValueObject
│       │   ├── Repositories/ # Repository Interface
│       │   ├── Services/     # Domain Service
│       │   └── Exceptions/
│       ├── Application/      # ユースケース
│       │   ├── UseCases/
│       │   ├── DTO/
│       │   ├── Repositories/ # Repository 実装
│       │   └── Providers/
│       ├── Presentation/     # HTTP
│       │   └── HTTP/
│       └── Infrastructure/   # Eloquent
│           └── EloquentModels/
└── Common/                   # 共有リソース
```

**レイヤー依存関係:**
```
[Presentation] → [Application] → [Domain] ← [Infrastructure]
```

---

## 通信設計

### API エンドポイント設計

#### 認証 API

| メソッド | エンドポイント | 説明 | 認証 |
|----------|---------------|------|------|
| GET | `/sanctum/csrf-cookie` | CSRF トークン取得 | 不要 |
| POST | `/api/auth/login` | 職員ログイン | 不要 |
| POST | `/api/auth/logout` | 職員ログアウト | 必須 |
| GET | `/api/auth/user` | ログイン職員情報取得 | 必須 |

#### 業務 API

| メソッド | エンドポイント | 説明 | 認証 |
|----------|---------------|------|------|
| GET | `/api/books` | 書籍一覧取得 | 不要 |
| GET | `/api/books/{id}` | 書籍詳細取得 | 不要 |
| POST | `/api/books` | 書籍登録 | 必須（職員） |
| PUT | `/api/books/{id}` | 書籍更新 | 必須（職員） |
| DELETE | `/api/books/{id}` | 書籍削除 | 必須（職員） |
| GET | `/api/loans` | 貸出一覧取得 | 必須（職員） |
| POST | `/api/loans` | 貸出登録 | 必須（職員） |
| PUT | `/api/loans/{id}/return` | 返却処理 | 必須（職員） |

### 職員認証フロー

本システムでは、職員向け機能（蔵書登録、貸出・返却処理、利用者管理など）を利用するために職員認証が必要となる。
Laravel Sanctum を使用した SPA 認証を採用し、セッションベースの認証を行う。

> **Note**: 利用者（図書館の一般利用者）向けの認証機能は Phase 2 以降で検討予定。
> 現時点では書籍検索など、認証不要で利用可能な機能のみを提供する。

```
┌──────────────┐                  ┌──────────────┐                  ┌──────────────┐
│   Frontend   │                  │   Backend    │                  │   Database   │
│  (職員PC)    │                  │  (Laravel)   │                  │   (MySQL)    │
└──────┬───────┘                  └──────┬───────┘                  └──────┬───────┘
       │                                 │                                 │
       │  1. GET /sanctum/csrf-cookie    │                                 │
       │────────────────────────────────>│                                 │
       │  XSRF-TOKEN Cookie              │                                 │
       │<────────────────────────────────│                                 │
       │                                 │                                 │
       │  2. POST /api/auth/login        │                                 │
       │     (職員ID, password)          │                                 │
       │────────────────────────────────>│                                 │
       │                                 │  3. 職員認証                     │
       │                                 │────────────────────────────────>│
       │                                 │  認証結果                        │
       │                                 │<────────────────────────────────│
       │  Session Cookie                 │                                 │
       │<────────────────────────────────│                                 │
       │                                 │                                 │
       │  4. GET /api/auth/user          │                                 │
       │     (Session Cookie)            │                                 │
       │────────────────────────────────>│                                 │
       │  職員情報                        │                                 │
       │<────────────────────────────────│                                 │
       │                                 │                                 │
       │  5. 職員向け API 呼び出し         │                                 │
       │     POST /api/books など        │                                 │
       │────────────────────────────────>│                                 │
       │                                 │  6. 認証チェック                  │
       │                                 │────────────────────────────────>│
       │  処理結果                        │                                 │
       │<────────────────────────────────│                                 │
       │                                 │                                 │
```

#### 認証が必要な操作

| カテゴリ | 操作 | 認証要否 |
|----------|------|---------|
| 蔵書管理 | 検索・閲覧 | 不要 |
| 蔵書管理 | 登録・更新・削除 | 必須（職員） |
| 貸出・返却 | すべての操作 | 必須（職員） |
| 利用者管理 | すべての操作 | 必須（職員） |
| 予約管理 | すべての操作 | 必須（職員） |

### レスポンス形式

**成功時:**
```json
{
  "data": {
    "id": "01H...",
    "title": "リファクタリング",
    "author": "Martin Fowler",
    "isbn": "978-4-274-22454-6"
  }
}
```

**一覧取得時（ページネーション）:**
```json
{
  "data": [...],
  "meta": {
    "current_page": 1,
    "per_page": 20,
    "total": 150,
    "last_page": 8
  }
}
```

**エラー時:**
```json
{
  "message": "バリデーションエラーが発生しました",
  "errors": {
    "title": ["タイトルは必須です"],
    "isbn": ["ISBN の形式が正しくありません"]
  }
}
```

---

## セキュリティ設計

### 全体方針

| 脅威 | フロントエンド対策 | バックエンド対策 |
|------|------------------|-----------------|
| XSS | React の自動エスケープ | Content-Security-Policy |
| CSRF | SameSite Cookie | Laravel Sanctum |
| SQL インジェクション | - | Eloquent ORM（プリペアドステートメント） |
| 認証情報漏洩 | HttpOnly Cookie 使用 | セッション管理 |
| 不正アクセス | 認証ガード | Policy / Gate |

### 認証・認可

```
┌─────────────────────────────────────────────────────────────────┐
│                        認証・認可フロー                           │
│                                                                 │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       │
│  │ AuthGuard   │────>│ Sanctum     │────>│ Policy      │       │
│  │ (Frontend)  │     │ Middleware  │     │ (Backend)   │       │
│  └─────────────┘     └─────────────┘     └─────────────┘       │
│        │                    │                   │               │
│        ▼                    ▼                   ▼               │
│  認証状態確認          セッション検証        権限チェック          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 非機能要件

> **注**: 本プロジェクトは学習目的のため、以下は本番環境を想定した参考値である。
> 小規模図書館（蔵書数 10,000冊、利用者数 500名程度）を想定。

### パフォーマンス目標

| 指標 | フロントエンド | バックエンド | 根拠 |
|------|--------------|-------------|------|
| 応答時間 | LCP 2.5秒以内 | API 200ms以内（95%ile） | Google Core Web Vitals 基準 |
| スループット | - | 100 req/sec | ピーク時 50 並列 × 2 req/user |
| 同時接続数 | - | 50ユーザー | 利用者の 10% が同時アクセス |

### 可用性

| 項目 | 目標 | 根拠 |
|------|------|------|
| 稼働率 | 99.0%（月間ダウンタイム 7.2時間以内） | 図書館開館時間帯のみ必須 |
| RTO | 4時間 | 営業日内の復旧を目標 |
| RPO | 24時間 | 日次バックアップで許容 |

### テストカバレッジ

| 対象 | フロントエンド | バックエンド |
|------|--------------|-------------|
| ビジネスロジック | Hooks 90%+ | Domain 90%+ |
| UI コンポーネント | 80%+ | - |
| API | - | UseCase 80%+ |
| 統合テスト | 70%+ | Controller 70%+ |

---

## 開発環境

### Docker Compose 構成

```yaml
services:
  # フロントエンド開発サーバー
  frontend:
    build: ./frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
    depends_on:
      - backend

  # バックエンド API サーバー
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/var/www/html
    depends_on:
      - db

  # データベース
  db:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      MYSQL_DATABASE: library
      MYSQL_USER: library
      MYSQL_PASSWORD: secret
      MYSQL_ROOT_PASSWORD: secret
    volumes:
      - db_data:/var/lib/mysql

  # DB 管理ツール
  phpmyadmin:
    image: phpmyadmin:latest
    ports:
      - "8080:80"
    environment:
      PMA_HOST: db
      PMA_USER: library
      PMA_PASSWORD: secret
    depends_on:
      - db

  # リバースプロキシ
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    depends_on:
      - frontend
      - backend

volumes:
  db_data:
```

### ローカル開発 URL

| サービス | URL |
|----------|-----|
| フロントエンド | http://localhost:5173 |
| バックエンド API | http://localhost:8000/api |
| phpMyAdmin | http://localhost:8080 |

---

## ドメインモデル概要

### 境界づけられたコンテキスト

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          図書館デジタル化システム                              │
│                                                                             │
│  ┌───────────────────────┐  ┌───────────────────────┐  ┌─────────────────┐ │
│  │    書籍管理コンテキスト    │  │    貸出管理コンテキスト   │  │ ユーザー管理     │ │
│  │                       │  │                       │  │ コンテキスト     │ │
│  │  ・書籍 (Book)         │  │  ・貸出 (Loan)         │  │                 │ │
│  │  ・著者 (Author)       │  │  ・予約 (Reservation)  │  │  ・利用者 (User) │ │
│  │  ・カテゴリ (Category)  │  │                       │  │  ・職員 (Staff)  │ │
│  │  ・ISBN               │  │                       │  │                 │ │
│  └───────────────────────┘  └───────────────────────┘  └─────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 主要エンティティ

| エンティティ | 説明 | 識別子 |
|-------------|------|--------|
| Book | 書籍情報 | BookId (ULID) |
| Loan | 貸出記録（延滞はステータスで管理） | LoanId (ULID) |
| User | 利用者情報（図書館の一般利用者） | UserId (ULID) |
| Staff | 職員情報（システム操作を行う図書館職員） | StaffId (ULID) |
| Reservation | 予約情報 | ReservationId (ULID) |

> **Staff エンティティについて**:
> - システムへのログイン認証に使用
> - 蔵書登録、貸出・返却処理、利用者管理などの職員向け機能の認可に使用
> - Laravel Sanctum によるセッション認証で管理

> **ULID を採用する理由**:
> - 時系列でソート可能（UUID v4 はランダム）
> - URL に使用しても見やすい（小文字英数字のみ）
> - MySQL の PRIMARY KEY として UUID より高パフォーマンス
> - 26文字固定長で UUID（36文字）より短い

---

## 関連ドキュメント

### アーキテクチャ設計

| ドキュメント | 内容 |
|-------------|------|
| [バックエンド アーキテクチャ設計](./backend/01_ArchitectureDesign.md) | DDD レイヤー構成・実装パターン |
| [フロントエンド アーキテクチャ設計](./frontend/01_ArchitectureDesign.md) | Feature-based アーキテクチャ |
| [ADR（アーキテクチャ決定記録）](./adr/README.md) | 技術選定の決定記録 |

### 設計標準（バックエンド）

| ドキュメント | 内容 |
|-------------|------|
| [標準ドキュメント概要](../99_standard/backend/00_Overview.md) | バックエンド標準の全体構成 |
| [コーディング規約](../99_standard/backend/01_CodingStandards.md) | PHP/Laravel コーディング規約 |
| [セキュリティ設計](../99_standard/backend/02_SecurityDesign.md) | セキュリティ対策 |
| [非機能要件](../99_standard/backend/03_Non-FunctionalRequirements.md) | パフォーマンス・可用性要件 |
| [ログ設計](../99_standard/backend/04_LoggingDesign.md) | ログ設計標準 |
| [API 設計](../99_standard/backend/05_ApiDesign.md) | RESTful API 設計標準 |
| [エラーハンドリング](../99_standard/backend/06_ErrorHandling.md) | エラー処理設計標準 |
| [データベース設計](../99_standard/backend/07_DatabaseDesign.md) | DB 命名規約・設計標準 |
| [バリデーション設計](../99_standard/backend/08_ValidationDesign.md) | 入力検証設計標準 |
| [外部連携設計](../99_standard/backend/09_ExternalIntegration.md) | 外部 API 連携設計標準 |
| [バッチ処理設計](../99_standard/backend/10_BatchProcessing.md) | バッチ処理設計標準 |

### 設計標準（フロントエンド）

| ドキュメント | 内容 |
|-------------|------|
| [標準ドキュメント概要](../99_standard/frontend/00_Overview.md) | フロントエンド標準の全体構成 |
| [コーディング規約](../99_standard/frontend/01_CodingStandards.md) | React/TypeScript コーディング規約 |
| [セキュリティ設計](../99_standard/frontend/02_SecurityDesign.md) | フロントエンドセキュリティ対策 |
| [非機能要件](../99_standard/frontend/03_Non-FunctionalRequirements.md) | フロントエンド非機能要件 |

### その他

| ドキュメント | 内容 |
|-------------|------|
| [セキュリティポリシー](../99_standard/security/SECURITY.md) | プロジェクト全体のセキュリティポリシー |
| [Definition of Done](../10_team/dod.md) | 完了の定義 |
| [Definition of Ready](../10_team/dor.md) | 準備完了の定義 |
