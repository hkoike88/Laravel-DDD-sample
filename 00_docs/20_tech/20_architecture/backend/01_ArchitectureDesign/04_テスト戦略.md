# テスト戦略

DDD アーキテクチャにおけるテスト構成と書き方。

---

## テストピラミッド

```
        /\
       /  \      E2E テスト（少）
      /----\
     /      \    Feature テスト（中）
    /--------\
   /          \  Unit テスト（多）
  /------------\
```

| 種類 | 対象 | 特徴 |
|------|------|------|
| **Unit** | Domain Model | 高速・DB 不要・多数 |
| **Feature** | UseCase | DB 使用・中程度 |
| **E2E** | API / UI | 遅い・少数 |

---

## テストディレクトリ構成

```
tests/
├── Unit/
│   └── {BoundedContext}/
│       └── {Domain}/
│           └── Domain/
│               ├── Model/
│               │   ├── OrderTest.php
│               │   └── OrderLineTest.php
│               └── ValueObjects/
│                   ├── OrderIdTest.php
│                   ├── OrderStatusTest.php
│                   └── MoneyTest.php
├── Feature/
│   └── {BoundedContext}/
│       └── {Domain}/
│           ├── UseCases/
│           │   ├── PlaceOrderTest.php
│           │   └── CancelOrderTest.php
│           └── HTTP/
│               └── OrderControllerTest.php
└── Integration/
    └── {BoundedContext}/
        └── {Domain}/
            └── Repositories/
                └── EloquentOrderRepositoryTest.php
```

---

## Unit テスト

### Domain Model のテスト

DB や Laravel に依存しない純粋なテスト。

```php
namespace Tests\Unit\Agenda\Order\Domain\Model;

use PHPUnit\Framework\TestCase;
use Packages\Agenda\Order\Domain\Model\Order;
use Packages\Agenda\Order\Domain\Model\ValueObjects\OrderId;
use Packages\Agenda\Order\Domain\Model\ValueObjects\OrderStatus;
use Packages\Agenda\Order\Domain\Model\ValueObjects\Money;
use Packages\Agenda\Order\Domain\Model\ValueObjects\CustomerId;
use Packages\Agenda\Order\Domain\Exceptions\DomainException;

class OrderTest extends TestCase
{
    private function createDraftOrder(): Order
    {
        return new Order(
            OrderId::from(1),
            CustomerId::from(100),
            OrderStatus::draft(),
            Money::fromInt(1000),
        );
    }

    public function test_確定できる(): void
    {
        $order = $this->createDraftOrder();

        $order->place();

        $this->assertTrue($order->status()->isPlaced());
    }

    public function test_確定済みは再確定できない(): void
    {
        $order = $this->createDraftOrder();
        $order->place();

        $this->expectException(DomainException::class);
        $this->expectExceptionMessage('確定できない状態です');

        $order->place();
    }

    public function test_下書きはキャンセルできる(): void
    {
        $order = $this->createDraftOrder();

        $order->cancel();

        $this->assertTrue($order->status()->isCancelled());
    }

    public function test_確定済みはキャンセルできる(): void
    {
        $order = $this->createDraftOrder();
        $order->place();

        $order->cancel();

        $this->assertTrue($order->status()->isCancelled());
    }
}
```

**ポイント:**
- `PHPUnit\Framework\TestCase` を継承（Laravel 不使用）
- DB 接続なし → 高速実行
- ビジネスルールのテストに集中

---

### ValueObject のテスト

```php
namespace Tests\Unit\Agenda\Order\Domain\ValueObjects;

use PHPUnit\Framework\TestCase;
use Packages\Common\Domain\ValueObjects\Money;
use InvalidArgumentException;

class MoneyTest extends TestCase
{
    public function test_正の金額で生成できる(): void
    {
        $money = Money::fromInt(1000);

        $this->assertSame(1000, $money->toInt());
    }

    public function test_負の金額は例外(): void
    {
        $this->expectException(InvalidArgumentException::class);

        Money::fromInt(-100);
    }

    public function test_加算できる(): void
    {
        $a = Money::fromInt(1000);
        $b = Money::fromInt(500);

        $result = $a->add($b);

        $this->assertSame(1500, $result->toInt());
    }

    public function test_乗算できる(): void
    {
        $money = Money::fromInt(100);

        $result = $money->multiply(3);

        $this->assertSame(300, $result->toInt());
    }

    public function test_ゼロを生成できる(): void
    {
        $money = Money::zero();

        $this->assertSame(0, $money->toInt());
    }

    public function test_等価性を判定できる(): void
    {
        $a = Money::fromInt(1000);
        $b = Money::fromInt(1000);
        $c = Money::fromInt(2000);

        $this->assertTrue($a->equals($b));
        $this->assertFalse($a->equals($c));
    }

    public function test_高額判定ができる(): void
    {
        $low = Money::fromInt(9999);
        $high = Money::fromInt(10000);

        $this->assertFalse($low->isHighValue());
        $this->assertTrue($high->isHighValue());
    }
}
```

---

### OrderStatus のテスト

```php
namespace Tests\Unit\Agenda\Order\Domain\ValueObjects;

use PHPUnit\Framework\TestCase;
use Packages\Agenda\Order\Domain\Model\ValueObjects\OrderStatus;
use InvalidArgumentException;

class OrderStatusTest extends TestCase
{
    public function test_下書きから確定可能(): void
    {
        $status = OrderStatus::draft();

        $this->assertTrue($status->canPlace());
    }

    public function test_確定済みから確定不可(): void
    {
        $status = OrderStatus::placed();

        $this->assertFalse($status->canPlace());
    }

    public function test_下書きからキャンセル可能(): void
    {
        $status = OrderStatus::draft();

        $this->assertTrue($status->canCancel());
    }

    public function test_確定済みからキャンセル可能(): void
    {
        $status = OrderStatus::placed();

        $this->assertTrue($status->canCancel());
    }

    public function test_確認済みからキャンセル不可(): void
    {
        $status = OrderStatus::confirmed();

        $this->assertFalse($status->canCancel());
    }

    public function test_文字列から生成できる(): void
    {
        $status = OrderStatus::from('placed');

        $this->assertTrue($status->isPlaced());
    }

    public function test_無効な文字列は例外(): void
    {
        $this->expectException(InvalidArgumentException::class);

        OrderStatus::from('invalid');
    }
}
```

---

## Feature テスト

### UseCase のテスト

DB を使用した統合テスト。

```php
namespace Tests\Feature\Agenda\Order\UseCases;

use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;
use Packages\Agenda\Order\Application\UseCases\Commands\PlaceOrder\PlaceOrderCommand;
use Packages\Agenda\Order\Application\UseCases\Commands\PlaceOrder\PlaceOrderHandler;
use Packages\Agenda\Order\Infrastructure\EloquentModels\OrderRecord;

class PlaceOrderTest extends TestCase
{
    use RefreshDatabase;

    private PlaceOrderHandler $handler;

    protected function setUp(): void
    {
        parent::setUp();
        $this->handler = app(PlaceOrderHandler::class);
    }

    public function test_注文を確定できる(): void
    {
        // Arrange
        $order = OrderRecord::factory()->draft()->create();

        // Act
        $command = new PlaceOrderCommand($order->id);
        $this->handler->handle($command);

        // Assert
        $order->refresh();
        $this->assertSame('placed', $order->status);
    }

    public function test_確定済み注文は再確定できない(): void
    {
        // Arrange
        $order = OrderRecord::factory()->placed()->create();

        // Act & Assert
        $this->expectException(\DomainException::class);

        $command = new PlaceOrderCommand($order->id);
        $this->handler->handle($command);
    }
}
```

---

### Controller のテスト

```php
namespace Tests\Feature\Agenda\Order\HTTP;

use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;
use Packages\Agenda\Order\Infrastructure\EloquentModels\OrderRecord;

class OrderControllerTest extends TestCase
{
    use RefreshDatabase;

    public function test_注文一覧を取得できる(): void
    {
        OrderRecord::factory()->count(3)->create();

        $response = $this->getJson('/api/orders');

        $response->assertOk()
            ->assertJsonCount(3);
    }

    public function test_注文詳細を取得できる(): void
    {
        $order = OrderRecord::factory()->create([
            'status' => 'draft',
            'amount' => 1000,
        ]);

        $response = $this->getJson("/api/orders/{$order->id}");

        $response->assertOk()
            ->assertJson([
                'id' => $order->id,
                'status' => 'draft',
                'amount' => 1000,
            ]);
    }

    public function test_注文を確定できる(): void
    {
        $order = OrderRecord::factory()->draft()->create();

        $response = $this->postJson("/api/orders/{$order->id}/place");

        $response->assertOk()
            ->assertJson(['status' => 'ok']);

        $this->assertDatabaseHas('orders', [
            'id' => $order->id,
            'status' => 'placed',
        ]);
    }

    public function test_存在しない注文は404(): void
    {
        $response = $this->getJson('/api/orders/99999');

        $response->assertNotFound();
    }
}
```

---

## Integration テスト

### Repository のテスト

```php
namespace Tests\Integration\Agenda\Order\Repositories;

use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;
use Packages\Agenda\Order\Application\Repositories\EloquentOrderRepository;
use Packages\Agenda\Order\Domain\Model\Order;
use Packages\Agenda\Order\Domain\Model\ValueObjects\OrderId;
use Packages\Agenda\Order\Domain\Model\ValueObjects\OrderStatus;
use Packages\Agenda\Order\Domain\Model\ValueObjects\CustomerId;
use Packages\Common\Domain\ValueObjects\Money;
use Packages\Agenda\Order\Infrastructure\EloquentModels\OrderRecord;

class EloquentOrderRepositoryTest extends TestCase
{
    use RefreshDatabase;

    private EloquentOrderRepository $repository;

    protected function setUp(): void
    {
        parent::setUp();
        $this->repository = new EloquentOrderRepository();
    }

    public function test_注文を保存して取得できる(): void
    {
        // Arrange
        $order = new Order(
            OrderId::from(1),
            CustomerId::from(100),
            OrderStatus::draft(),
            Money::fromInt(5000),
        );

        // Act
        $this->repository->save($order);
        $found = $this->repository->find(OrderId::from(1));

        // Assert
        $this->assertTrue($found->id()->equals($order->id()));
        $this->assertTrue($found->status()->equals($order->status()));
        $this->assertTrue($found->amount()->equals($order->amount()));
    }

    public function test_顧客IDで注文を検索できる(): void
    {
        // Arrange
        OrderRecord::factory()->create(['customer_id' => 100]);
        OrderRecord::factory()->create(['customer_id' => 100]);
        OrderRecord::factory()->create(['customer_id' => 200]);

        // Act
        $orders = $this->repository->findByCustomer(CustomerId::from(100));

        // Assert
        $this->assertCount(2, $orders);
    }

    public function test_存在しない注文は例外(): void
    {
        $this->expectException(\Illuminate\Database\Eloquent\ModelNotFoundException::class);

        $this->repository->find(OrderId::from(99999));
    }
}
```

---

## Factory の作成

### Eloquent Factory

```php
namespace Database\Factories\Agenda\Order;

use Illuminate\Database\Eloquent\Factories\Factory;
use Packages\Agenda\Order\Infrastructure\EloquentModels\OrderRecord;

class OrderRecordFactory extends Factory
{
    protected $model = OrderRecord::class;

    public function definition(): array
    {
        return [
            'customer_id' => $this->faker->randomNumber(),
            'status' => 'draft',
            'amount' => $this->faker->numberBetween(100, 100000),
        ];
    }

    public function draft(): self
    {
        return $this->state(['status' => 'draft']);
    }

    public function placed(): self
    {
        return $this->state(['status' => 'placed']);
    }

    public function confirmed(): self
    {
        return $this->state(['status' => 'confirmed']);
    }

    public function cancelled(): self
    {
        return $this->state(['status' => 'cancelled']);
    }
}
```

### Domain Factory（テスト用）

```php
namespace Tests\Factories\Agenda\Order;

use Packages\Agenda\Order\Domain\Model\Order;
use Packages\Agenda\Order\Domain\Model\ValueObjects\OrderId;
use Packages\Agenda\Order\Domain\Model\ValueObjects\OrderStatus;
use Packages\Agenda\Order\Domain\Model\ValueObjects\CustomerId;
use Packages\Common\Domain\ValueObjects\Money;

class OrderTestFactory
{
    public static function draft(array $overrides = []): Order
    {
        return new Order(
            $overrides['id'] ?? OrderId::from(1),
            $overrides['customerId'] ?? CustomerId::from(100),
            OrderStatus::draft(),
            $overrides['amount'] ?? Money::fromInt(1000),
        );
    }

    public static function placed(array $overrides = []): Order
    {
        $order = self::draft($overrides);
        $order->place();
        return $order;
    }
}
```

---

## テスト実行設定

### phpunit.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="vendor/phpunit/phpunit/phpunit.xsd"
         bootstrap="vendor/autoload.php"
         colors="true">
    <testsuites>
        <testsuite name="Unit">
            <directory>tests/Unit</directory>
        </testsuite>
        <testsuite name="Feature">
            <directory>tests/Feature</directory>
        </testsuite>
        <testsuite name="Integration">
            <directory>tests/Integration</directory>
        </testsuite>
    </testsuites>

    <coverage>
        <include>
            <directory suffix=".php">packages</directory>
        </include>
        <exclude>
            <directory>packages/*/Infrastructure/EloquentModels</directory>
        </exclude>
    </coverage>

    <php>
        <env name="APP_ENV" value="testing"/>
        <env name="DB_CONNECTION" value="sqlite"/>
        <env name="DB_DATABASE" value=":memory:"/>
    </php>
</phpunit>
```

---

## テスト実行コマンド

```bash
# 全テスト実行
php artisan test

# Unit テストのみ
php artisan test --testsuite=Unit

# Feature テストのみ
php artisan test --testsuite=Feature

# 特定のテストクラス
php artisan test --filter=OrderTest

# カバレッジレポート
php artisan test --coverage

# 並列実行
php artisan test --parallel
```

---

## テストのベストプラクティス

### 1. Arrange-Act-Assert パターン

```php
public function test_注文を確定できる(): void
{
    // Arrange（準備）
    $order = $this->createDraftOrder();

    // Act（実行）
    $order->place();

    // Assert（検証）
    $this->assertTrue($order->status()->isPlaced());
}
```

### 2. テストメソッド名は日本語で

```php
// ✓ Good
public function test_確定済み注文はキャンセルできる(): void

// ✗ Bad
public function testPlacedOrderCanBeCancelled(): void
```

### 3. 1 テスト 1 アサーション

```php
// ✓ Good: 1つの振る舞いをテスト
public function test_確定するとステータスが変わる(): void
{
    $order = $this->createDraftOrder();
    $order->place();
    $this->assertTrue($order->status()->isPlaced());
}

// ✗ Bad: 複数の振る舞いをテスト
public function test_注文の全機能(): void
{
    $order = $this->createDraftOrder();
    $order->place();
    $this->assertTrue($order->status()->isPlaced());
    $order->cancel();
    $this->assertTrue($order->status()->isCancelled());
}
```

### 4. テストデータは最小限

```php
// ✓ Good: テストに必要なデータのみ
$order = OrderRecord::factory()->create(['status' => 'draft']);

// ✗ Bad: 不要なデータまで作成
$customer = CustomerRecord::factory()->create();
$products = ProductRecord::factory()->count(10)->create();
$order = OrderRecord::factory()->create([
    'customer_id' => $customer->id,
    'status' => 'draft',
    // ... 大量の不要なデータ
]);
```

---

## レイヤー別テストカバレッジ目標

| レイヤー | 目標 | 理由 |
|---------|------|------|
| Domain | 90%+ | ビジネスロジックの核心 |
| Application | 80%+ | ユースケースの正確性 |
| Presentation | 70%+ | API 契約の保証 |
| Infrastructure | 60%+ | 変換ロジックの確認 |

---

## 次のステップ

[05_段階的移行ガイド.md](./05_段階的移行ガイド.md) に進む
