# 段階的移行ガイド

既存の Laravel プロジェクトを DDD アーキテクチャに段階的に移行する手順。

---

## 移行の原則

### 1. ビッグバンリライトを避ける

```
✗ Bad: 全てを一度に書き換える
✓ Good: 新機能から DDD、既存は段階的に移行
```

### 2. ストラングラーパターン

```
[既存 MVC] ←─ [新規 DDD] ←─ [新リクエスト]
     ↑              ↑
     └──── 段階的に移行 ────┘
```

新機能は DDD で実装し、既存機能を徐々に置き換える。

---

## フェーズ 0: 準備

### ディレクトリ構造の作成

```bash
mkdir -p packages/Common/{Domain,Infrastructure,Presentation}
mkdir -p packages/Common/Domain/{ValueObjects,Exceptions}
mkdir -p packages/Common/Infrastructure/{Eloquent,Transaction,Providers}
```

### composer.json の更新

```json
{
    "autoload": {
        "psr-4": {
            "App\\": "app/",
            "Packages\\": "packages/"
        }
    }
}
```

```bash
composer dump-autoload
```

### 共通コンポーネントの作成

```php
// packages/Common/Domain/Exceptions/DomainException.php
namespace Packages\Common\Domain\Exceptions;

class DomainException extends \DomainException {}
```

```php
// packages/Common/Infrastructure/Transaction/TransactionManager.php
namespace Packages\Common\Infrastructure\Transaction;

interface TransactionManager
{
    public function transaction(callable $callback): mixed;
}
```

```php
// packages/Common/Infrastructure/Transaction/EloquentTransactionManager.php
namespace Packages\Common\Infrastructure\Transaction;

use Illuminate\Support\Facades\DB;

class EloquentTransactionManager implements TransactionManager
{
    public function transaction(callable $callback): mixed
    {
        return DB::transaction($callback);
    }
}
```

---

## フェーズ 1: 最初のドメイン

### Step 1-1: ドメインの選定

**選定基準:**
- 比較的独立している
- ビジネスルールが明確
- 新規開発 or 改修予定がある

**例:** Order（注文）ドメインを選定

### Step 1-2: ディレクトリ作成

```bash
# ドメイン構造を作成
mkdir -p packages/Agenda/Order/{Domain,Application,Presentation,Infrastructure}
mkdir -p packages/Agenda/Order/Domain/{Model,Repositories,Exceptions}
mkdir -p packages/Agenda/Order/Domain/Model/ValueObjects
mkdir -p packages/Agenda/Order/Application/{UseCases,DTO,Repositories,Providers}
mkdir -p packages/Agenda/Order/Application/UseCases/{Commands,Queries}
mkdir -p packages/Agenda/Order/Presentation/HTTP/{Requests,Resources}
mkdir -p packages/Agenda/Order/Infrastructure/EloquentModels
```

### Step 1-3: ValueObject の作成

既存の Eloquent Model から値オブジェクトを抽出。

```php
// packages/Agenda/Order/Domain/Model/ValueObjects/OrderId.php
namespace Packages\Agenda\Order\Domain\Model\ValueObjects;

final class OrderId
{
    public function __construct(private int $value)
    {
        if ($value <= 0) {
            throw new \InvalidArgumentException('ID は正の整数');
        }
    }

    public static function from(int $value): self
    {
        return new self($value);
    }

    public function value(): int
    {
        return $this->value;
    }

    public function equals(OrderId $other): bool
    {
        return $this->value === $other->value;
    }
}
```

### Step 1-4: Domain Model の作成

```php
// packages/Agenda/Order/Domain/Model/Order.php
namespace Packages\Agenda\Order\Domain\Model;

use Packages\Agenda\Order\Domain\Model\ValueObjects\OrderId;
use Packages\Agenda\Order\Domain\Model\ValueObjects\OrderStatus;
use Packages\Agenda\Order\Domain\Model\ValueObjects\CustomerId;
use Packages\Common\Domain\ValueObjects\Money;
use Packages\Common\Domain\Exceptions\DomainException;

final class Order
{
    public function __construct(
        private OrderId $id,
        private CustomerId $customerId,
        private OrderStatus $status,
        private Money $amount,
    ) {}

    public function place(): void
    {
        if (!$this->status->canPlace()) {
            throw new DomainException('確定できない状態です');
        }
        $this->status = OrderStatus::placed();
    }

    public function cancel(): void
    {
        if (!$this->status->canCancel()) {
            throw new DomainException('キャンセルできない状態です');
        }
        $this->status = OrderStatus::cancelled();
    }

    // getters...
    public function id(): OrderId { return $this->id; }
    public function customerId(): CustomerId { return $this->customerId; }
    public function status(): OrderStatus { return $this->status; }
    public function amount(): Money { return $this->amount; }
}
```

### Step 1-5: Repository Interface の作成

```php
// packages/Agenda/Order/Domain/Repositories/OrderRepositoryInterface.php
namespace Packages\Agenda\Order\Domain\Repositories;

use Packages\Agenda\Order\Domain\Model\Order;
use Packages\Agenda\Order\Domain\Model\ValueObjects\OrderId;

interface OrderRepositoryInterface
{
    public function find(OrderId $id): Order;
    public function save(Order $order): void;
}
```

### Step 1-6: Eloquent Model の移行

既存の Model を Infrastructure 層に移動。

```php
// packages/Agenda/Order/Infrastructure/EloquentModels/OrderRecord.php
namespace Packages\Agenda\Order\Infrastructure\EloquentModels;

use Illuminate\Database\Eloquent\Model;

class OrderRecord extends Model
{
    protected $table = 'orders';

    protected $fillable = [
        'customer_id',
        'status',
        'amount',
    ];
}
```

### Step 1-7: Repository 実装の作成

```php
// packages/Agenda/Order/Application/Repositories/EloquentOrderRepository.php
namespace Packages\Agenda\Order\Application\Repositories;

use Packages\Agenda\Order\Domain\Repositories\OrderRepositoryInterface;
use Packages\Agenda\Order\Domain\Model\Order;
use Packages\Agenda\Order\Domain\Model\ValueObjects\OrderId;
use Packages\Agenda\Order\Domain\Model\ValueObjects\OrderStatus;
use Packages\Agenda\Order\Domain\Model\ValueObjects\CustomerId;
use Packages\Common\Domain\ValueObjects\Money;
use Packages\Agenda\Order\Infrastructure\EloquentModels\OrderRecord;

class EloquentOrderRepository implements OrderRepositoryInterface
{
    public function find(OrderId $id): Order
    {
        $record = OrderRecord::findOrFail($id->value());
        return $this->toDomain($record);
    }

    public function save(Order $order): void
    {
        $record = OrderRecord::findOrNew($order->id()->value());
        $record->customer_id = $order->customerId()->value();
        $record->status = $order->status()->value();
        $record->amount = $order->amount()->toInt();
        $record->save();
    }

    private function toDomain(OrderRecord $record): Order
    {
        return new Order(
            OrderId::from($record->id),
            CustomerId::from($record->customer_id),
            OrderStatus::from($record->status),
            Money::fromInt($record->amount),
        );
    }
}
```

### Step 1-8: UseCase の作成

```php
// packages/Agenda/Order/Application/UseCases/Commands/PlaceOrder/PlaceOrderCommand.php
namespace Packages\Agenda\Order\Application\UseCases\Commands\PlaceOrder;

final class PlaceOrderCommand
{
    public function __construct(
        public readonly int $orderId,
    ) {}
}
```

```php
// packages/Agenda/Order/Application/UseCases/Commands/PlaceOrder/PlaceOrderHandler.php
namespace Packages\Agenda\Order\Application\UseCases\Commands\PlaceOrder;

use Packages\Agenda\Order\Domain\Repositories\OrderRepositoryInterface;
use Packages\Agenda\Order\Domain\Model\ValueObjects\OrderId;

final class PlaceOrderHandler
{
    public function __construct(
        private OrderRepositoryInterface $orderRepository,
    ) {}

    public function handle(PlaceOrderCommand $command): void
    {
        $order = $this->orderRepository->find(
            OrderId::from($command->orderId)
        );

        $order->place();

        $this->orderRepository->save($order);
    }
}
```

### Step 1-9: ServiceProvider の作成

```php
// packages/Agenda/Order/Application/Providers/OrderServiceProvider.php
namespace Packages\Agenda\Order\Application\Providers;

use Illuminate\Support\ServiceProvider;
use Packages\Agenda\Order\Domain\Repositories\OrderRepositoryInterface;
use Packages\Agenda\Order\Application\Repositories\EloquentOrderRepository;

class OrderServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        $this->app->bind(
            OrderRepositoryInterface::class,
            EloquentOrderRepository::class
        );
    }

    public function boot(): void
    {
        $this->loadRoutesFrom(__DIR__ . '/../../Presentation/HTTP/routes.php');
    }
}
```

### Step 1-10: config/app.php に登録

```php
'providers' => [
    // ...
    Packages\Agenda\Order\Application\Providers\OrderServiceProvider::class,
],
```

### Step 1-11: Controller の移行

```php
// packages/Agenda/Order/Presentation/HTTP/OrderController.php
namespace Packages\Agenda\Order\Presentation\HTTP;

use App\Http\Controllers\Controller;
use Packages\Agenda\Order\Application\UseCases\Commands\PlaceOrder\PlaceOrderCommand;
use Packages\Agenda\Order\Application\UseCases\Commands\PlaceOrder\PlaceOrderHandler;

class OrderController extends Controller
{
    public function __construct(
        private PlaceOrderHandler $placeOrderHandler,
    ) {}

    public function place(int $orderId)
    {
        $command = new PlaceOrderCommand($orderId);
        $this->placeOrderHandler->handle($command);

        return response()->json(['status' => 'ok']);
    }
}
```

### Step 1-12: routes の作成

```php
// packages/Agenda/Order/Presentation/HTTP/routes.php
use Illuminate\Support\Facades\Route;
use Packages\Agenda\Order\Presentation\HTTP\OrderController;

Route::prefix('api/orders')->group(function () {
    Route::post('/{id}/place', [OrderController::class, 'place']);
});
```

---

## フェーズ 2: 既存 Controller の移行

### 段階的アプローチ

```
[既存 Controller]
       ↓
[Controller + UseCase] ← 新しい UseCase を注入
       ↓
[新 Controller + UseCase] ← Controller も移行
```

### Before: 既存 Controller

```php
// app/Http/Controllers/OrderController.php
class OrderController extends Controller
{
    public function confirm($id)
    {
        $order = Order::findOrFail($id);

        if ($order->status !== 'draft') {
            return response()->json(['error' => '確定できません'], 400);
        }

        $order->status = 'confirmed';
        $order->save();

        return response()->json(['status' => 'ok']);
    }
}
```

### Step 2-1: UseCase を追加

```php
// app/Http/Controllers/OrderController.php
class OrderController extends Controller
{
    public function __construct(
        private PlaceOrderHandler $placeOrderHandler,
    ) {}

    public function confirm($id)
    {
        try {
            $command = new PlaceOrderCommand($id);
            $this->placeOrderHandler->handle($command);

            return response()->json(['status' => 'ok']);
        } catch (DomainException $e) {
            return response()->json(['error' => $e->getMessage()], 400);
        }
    }
}
```

### Step 2-2: Controller を packages/ に移動

routes を更新して新しい Controller を参照。

---

## フェーズ 3: 複数ドメインへの展開

### ドメイン間の依存

```php
// Order ドメインから User ドメインを参照する場合
// → ID のみで参照（オブジェクトを直接参照しない）

final class Order
{
    public function __construct(
        private OrderId $id,
        private CustomerId $customerId,  // User ドメインの ID
        // ...
    ) {}
}
```

### 共通の ValueObject

```php
// packages/Common/Domain/ValueObjects/Money.php
// 複数ドメインで使用する場合は Common に配置
```

---

## フェーズ 4: 既存テーブルへの対応

### テーブル名が異なる場合

```php
class OrderRecord extends Model
{
    protected $table = 'tbl_orders';  // 既存のテーブル名
}
```

### カラム名が異なる場合

```php
class EloquentOrderRepository implements OrderRepositoryInterface
{
    private function toDomain(OrderRecord $record): Order
    {
        return new Order(
            OrderId::from($record->order_id),      // id ではなく order_id
            CustomerId::from($record->cust_id),    // customer_id ではなく cust_id
            OrderStatus::from($record->order_status),
            Money::fromInt($record->total_amount),
        );
    }
}
```

---

## 移行チェックリスト

### フェーズ 0（準備）

- [ ] packages/ ディレクトリ作成
- [ ] composer.json 更新
- [ ] Common コンポーネント作成
- [ ] 最初のドメイン選定

### フェーズ 1（最初のドメイン）

- [ ] ディレクトリ構造作成
- [ ] ValueObject 作成
- [ ] Domain Model 作成
- [ ] Repository Interface 作成
- [ ] Eloquent Model 移行
- [ ] Repository 実装作成
- [ ] UseCase 作成
- [ ] ServiceProvider 作成
- [ ] Controller 作成
- [ ] routes 作成
- [ ] Unit テスト作成
- [ ] Feature テスト作成

### フェーズ 2（既存の移行）

- [ ] 既存 Controller に UseCase 注入
- [ ] 動作確認
- [ ] Controller を packages/ に移動
- [ ] 既存 routes 削除

### フェーズ 3（拡張）

- [ ] 次のドメイン選定
- [ ] フェーズ 1 を繰り返す

---

## よくある問題と解決策

### 問題 1: Eloquent のリレーションをどうするか

**解決策:** Repository 内で処理し、Domain Model には配列で渡す

```php
class EloquentOrderRepository implements OrderRepositoryInterface
{
    public function find(OrderId $id): Order
    {
        $record = OrderRecord::with('lines')->findOrFail($id->value());

        $lines = $record->lines->map(fn($r) => new OrderLine(
            // ...
        ))->all();

        return new Order(
            // ...
            $lines,
        );
    }
}
```

### 問題 2: 既存のビジネスロジックが散らばっている

**解決策:** 段階的に Domain Model に集約

1. 既存ロジックをそのまま動かす
2. 新規ロジックは Domain Model に実装
3. 既存ロジックを徐々に Domain Model に移動

### 問題 3: 既存テストが壊れる

**解決策:** 既存テストは維持しつつ、新しいテストを追加

```php
// 既存のテスト（維持）
class OrderControllerTest extends TestCase
{
    public function test_confirm_order(): void { /* 既存のまま */ }
}

// 新しいテスト（追加）
class PlaceOrderTest extends TestCase
{
    public function test_注文を確定できる(): void { /* DDD のテスト */ }
}
```

### 問題 4: チームメンバーの理解

**解決策:**
1. 小さなドメインから始める
2. ペアプログラミングで知識共有
3. このガイドを共有

---

## 移行のタイムライン目安

| フェーズ | 作業内容 | 目安 |
|---------|---------|------|
| 0 | 準備 | 1日 |
| 1 | 最初のドメイン | 1-2週間 |
| 2 | 既存の移行（1ドメイン） | 1週間 |
| 3 | 追加ドメイン（1つあたり） | 1週間 |

※ プロジェクトの規模・複雑さにより変動

---

## 参考資料

- [Orphail/laravel-ddd](https://github.com/Orphail/laravel-ddd) - ドメイン別グループ化の実装例
- [00_概要.md](./00_概要.md) - ガイドの全体像
- [01_アーキテクチャ設計.md](./01_アーキテクチャ設計.md) - 設計原則
- [02_実装パターン.md](./02_実装パターン.md) - コードサンプル
