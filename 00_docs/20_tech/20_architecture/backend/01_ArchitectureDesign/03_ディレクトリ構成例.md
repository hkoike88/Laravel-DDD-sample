# ディレクトリ構成例

ドメイン別グループ化の具体的なディレクトリ構成。

**参照:** [Orphail/laravel-ddd](https://github.com/Orphail/laravel-ddd)

---

## 全体構成

```
laravel-project/
├── packages/                     # DDD アプリケーションコード
│   ├── {BoundedContext}/         # 境界づけられたコンテキスト
│   │   └── {Domain}/             # ドメイン
│   │       ├── Domain/
│   │       ├── Application/
│   │       ├── Presentation/
│   │       └── Infrastructure/
│   └── Common/                   # 共有リソース
├── app/                          # Laravel デフォルト（最小限）
├── config/
├── database/
├── routes/
├── tests/
└── ...
```

---

## 具体例: EC サイト

```
packages/
├── Agenda/                       # 境界づけられたコンテキスト
│   ├── User/                     # ユーザードメイン
│   │   ├── Domain/
│   │   ├── Application/
│   │   ├── Presentation/
│   │   └── Infrastructure/
│   ├── Order/                    # 注文ドメイン
│   │   ├── Domain/
│   │   ├── Application/
│   │   ├── Presentation/
│   │   └── Infrastructure/
│   └── Product/                  # 商品ドメイン
│       ├── Domain/
│       ├── Application/
│       ├── Presentation/
│       └── Infrastructure/
├── Auth/                         # 認証コンテキスト
│   ├── Domain/
│   ├── Application/
│   ├── Presentation/
│   └── Infrastructure/
└── Common/                       # 共有リソース
    ├── Domain/
    ├── Infrastructure/
    └── Presentation/
```

---

## 各レイヤーの詳細構成

### Domain 層

```
Domain/
├── Model/
│   ├── Order.php                   # エンティティ / 集約ルート
│   ├── OrderLine.php               # 子エンティティ
│   └── ValueObjects/               # 値オブジェクト
│       ├── OrderId.php
│       ├── OrderStatus.php
│       └── Money.php
├── Repositories/                   # リポジトリインターフェース
│   └── OrderRepositoryInterface.php
├── Services/                       # ドメインサービス
│   └── OrderDomainService.php
├── Exceptions/                     # ドメイン例外
│   ├── OrderNotFoundException.php
│   └── InvalidOrderStatusException.php
├── Factories/                      # ファクトリ
│   └── OrderFactory.php
└── Policies/                       # 認可ポリシー
    └── OrderPolicy.php
```

---

### Application 層

```
Application/
├── UseCases/
│   ├── Commands/                   # 書き込み操作
│   │   ├── PlaceOrder/
│   │   │   ├── PlaceOrderCommand.php
│   │   │   └── PlaceOrderHandler.php
│   │   ├── CancelOrder/
│   │   └── AddOrderLine/
│   └── Queries/                    # 読み取り操作
│       ├── GetOrder/
│       │   ├── GetOrderQuery.php
│       │   └── GetOrderHandler.php
│       ├── ListOrders/
│       └── SearchOrders/
├── DTO/                            # データ転送オブジェクト
│   ├── OrderDTO.php
│   └── OrderLineDTO.php
├── Repositories/                   # リポジトリ実装
│   └── EloquentOrderRepository.php
├── QueryServices/                  # クエリサービス
│   └── EloquentOrderQueryService.php
├── Mappers/                        # ドメイン ↔ DTO 変換
│   └── OrderMapper.php
├── Jobs/                           # バックグラウンドジョブ
│   └── SendOrderConfirmationJob.php
├── Exceptions/                     # アプリケーション例外
│   └── OrderAlreadyExistsException.php
└── Providers/                      # サービスプロバイダ
    └── OrderServiceProvider.php
```

---

### Presentation 層

```
Presentation/
├── HTTP/                           # Web / REST API
│   ├── OrderController.php
│   ├── routes.php
│   ├── Requests/                   # FormRequest
│   │   ├── PlaceOrderRequest.php
│   │   └── AddOrderLineRequest.php
│   └── Resources/                  # API Resource
│       ├── OrderResource.php
│       └── OrderLineResource.php
├── API/                            # 外部 API 専用
│   └── ...
└── CLI/                            # Artisan コマンド
    └── ProcessPendingOrdersCommand.php
```

---

### Infrastructure 層

```
Infrastructure/
└── EloquentModels/                 # Eloquent モデル
    ├── OrderRecord.php
    └── OrderLineRecord.php
```

---

## Common（共有リソース）

```
Common/
├── Domain/
│   ├── ValueObjects/               # 汎用値オブジェクト
│   │   ├── Id.php
│   │   ├── Email.php
│   │   └── Money.php
│   └── Exceptions/
│       └── DomainException.php
├── Infrastructure/
│   ├── Eloquent/
│   │   └── BaseEloquentModel.php
│   ├── Transaction/
│   │   ├── TransactionManager.php
│   │   └── EloquentTransactionManager.php
│   └── Providers/
│       └── CommonServiceProvider.php
└── Presentation/
    └── CLI/
        └── MakeDomainCommand.php   # ドメイン生成コマンド
```

---

## 名前空間

```php
// Domain 層
namespace Packages\Agenda\Order\Domain\Model;
namespace Packages\Agenda\Order\Domain\Repositories;
namespace Packages\Agenda\Order\Domain\Exceptions;

// Application 層
namespace Packages\Agenda\Order\Application\UseCases\Commands\PlaceOrder;
namespace Packages\Agenda\Order\Application\UseCases\Queries\GetOrder;
namespace Packages\Agenda\Order\Application\DTO;
namespace Packages\Agenda\Order\Application\Repositories;

// Presentation 層
namespace Packages\Agenda\Order\Presentation\HTTP;
namespace Packages\Agenda\Order\Presentation\HTTP\Requests;

// Infrastructure 層
namespace Packages\Agenda\Order\Infrastructure\EloquentModels;

// Common
namespace Packages\Common\Domain\ValueObjects;
namespace Packages\Common\Infrastructure\Transaction;
```

---

## composer.json

```json
{
    "autoload": {
        "psr-4": {
            "App\\": "app/",
            "Packages\\": "packages/"
        }
    }
}
```

変更後に `composer dump-autoload` を実行。

---

## ServiceProvider の登録

### config/app.php

```php
'providers' => [
    // Laravel 標準
    // ...

    // Common
    Packages\Common\Infrastructure\Providers\CommonServiceProvider::class,

    // Auth
    Packages\Auth\Application\Providers\AuthServiceProvider::class,

    // Agenda
    Packages\Agenda\User\Application\Providers\UserServiceProvider::class,
    Packages\Agenda\Order\Application\Providers\OrderServiceProvider::class,
    Packages\Agenda\Product\Application\Providers\ProductServiceProvider::class,
],
```

### ServiceProvider 実装例

```php
namespace Packages\Agenda\Order\Application\Providers;

use Illuminate\Support\ServiceProvider;
use Packages\Agenda\Order\Domain\Repositories\OrderRepositoryInterface;
use Packages\Agenda\Order\Application\Repositories\EloquentOrderRepository;

class OrderServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        $this->app->bind(
            OrderRepositoryInterface::class,
            EloquentOrderRepository::class
        );
    }

    public function boot(): void
    {
        $this->loadRoutesFrom(__DIR__ . '/../../Presentation/HTTP/routes.php');
    }
}
```

---

## routes.php（ドメイン内）

```php
// packages/Agenda/Order/Presentation/HTTP/routes.php

use Illuminate\Support\Facades\Route;
use Packages\Agenda\Order\Presentation\HTTP\OrderController;

Route::prefix('api/orders')->group(function () {
    Route::get('/', [OrderController::class, 'index']);
    Route::get('/{id}', [OrderController::class, 'show']);
    Route::post('/', [OrderController::class, 'store']);
    Route::post('/{id}/place', [OrderController::class, 'place']);
    Route::post('/{id}/cancel', [OrderController::class, 'cancel']);
});
```

---

## ファイル命名規約

| 種類 | 命名規約 | 例 |
|------|----------|-----|
| エンティティ | `{Name}.php` | `Order.php` |
| 値オブジェクト | `{Name}.php` | `OrderId.php`, `Money.php` |
| リポジトリ IF | `{Name}RepositoryInterface.php` | `OrderRepositoryInterface.php` |
| リポジトリ実装 | `Eloquent{Name}Repository.php` | `EloquentOrderRepository.php` |
| Eloquent モデル | `{Name}Record.php` | `OrderRecord.php` |
| コマンド | `{Action}{Entity}Command.php` | `PlaceOrderCommand.php` |
| ハンドラ | `{Action}{Entity}Handler.php` | `PlaceOrderHandler.php` |
| クエリ | `{Action}{Entity}Query.php` | `GetOrderQuery.php` |
| DTO | `{Name}DTO.php` | `OrderDTO.php` |
| コントローラ | `{Name}Controller.php` | `OrderController.php` |
| サービスプロバイダ | `{Domain}ServiceProvider.php` | `OrderServiceProvider.php` |

---

## ドメイン生成コマンド

```bash
php artisan make:domain {BoundedContext} {Domain}

# 例
php artisan make:domain Agenda Order
php artisan make:domain Agenda Product
php artisan make:domain Auth User
```

生成されるディレクトリ:
```
packages/{BoundedContext}/{Domain}/
├── Domain/
│   ├── Model/
│   ├── Repositories/
│   └── Exceptions/
├── Application/
│   ├── UseCases/
│   ├── DTO/
│   ├── Repositories/
│   └── Providers/
├── Presentation/
│   └── HTTP/
└── Infrastructure/
    └── EloquentModels/
```

---

## 従来の Laravel との比較

### 従来（レイヤー別）

```
app/
├── Http/Controllers/
│   ├── UserController.php
│   └── OrderController.php
├── Models/
│   ├── User.php
│   └── Order.php
└── Services/
    ├── UserService.php
    └── OrderService.php
```

### DDD（ドメイン別）

```
packages/
├── Agenda/
│   ├── User/
│   │   ├── Domain/
│   │   ├── Application/
│   │   ├── Presentation/
│   │   └── Infrastructure/
│   └── Order/
│       ├── Domain/
│       ├── Application/
│       ├── Presentation/
│       └── Infrastructure/
└── Common/
```

**メリット:**
- ドメインごとに独立した開発が可能
- チーム分割しやすい
- ドメインの境界が明確
- 将来的なマイクロサービス化が容易

---

## 次のステップ

[04_テスト戦略.md](./04_テスト戦略.md) に進む
