# データ分類・保護ポリシー

## 概要

本ドキュメントは、システムで取り扱うデータの分類基準と保護要件を定義する。
適切なデータ管理により、情報資産の保護とコンプライアンス遵守を実現する。

**Last updated:** 2025-12-26

---

## 目次

- [データ分類レベル](#データ分類レベル)
- [分類基準](#分類基準)
- [保護要件](#保護要件)
- [個人情報の取り扱い](#個人情報の取り扱い)
- [データライフサイクル](#データライフサイクル)
- [アクセス制御](#アクセス制御)
- [データ転送・共有](#データ転送共有)
- [実装ガイドライン](#実装ガイドライン)
- [監査・コンプライアンス](#監査コンプライアンス)

---

## データ分類レベル

### 分類体系

| レベル | 名称 | 説明 | ラベル |
|:------:|------|------|:------:|
| **L1** | 極秘（Confidential） | 漏洩時に重大な損害を与えるデータ | 🔴 |
| **L2** | 社外秘（Internal） | 社内のみで共有可能なデータ | 🟡 |
| **L3** | 関係者限定（Restricted） | 特定の関係者のみアクセス可能 | 🟢 |
| **L4** | 公開（Public） | 一般公開可能なデータ | ⚪ |

### 各レベルの詳細

#### L1: 極秘（Confidential）

**定義**: 漏洩した場合、法的責任、重大な経済的損失、または信用の著しい毀損につながるデータ

**該当するデータ**:
- 認証情報（パスワードハッシュ、APIキー、シークレット）
- 暗号化キー、証明書の秘密鍵
- 個人情報（PII）の集合体
- 決済情報（クレジットカード番号等）
- 医療情報、金融情報
- セキュリティ脆弱性情報（未修正のもの）

#### L2: 社外秘（Internal）

**定義**: 社内での業務遂行に必要だが、外部への開示は不適切なデータ

**該当するデータ**:
- 社内システムの設計書、構成図
- 業務プロセス、運用手順書
- 従業員情報（連絡先、所属等）
- 契約情報、取引条件
- 未公開の製品・サービス情報
- 内部監査レポート

#### L3: 関係者限定（Restricted）

**定義**: 業務上の必要性に基づき、特定の関係者のみがアクセス可能なデータ

**該当するデータ**:
- プロジェクト固有のドキュメント
- チーム内の作業ファイル
- ベンダーとの共有情報
- 限定公開のAPIドキュメント

#### L4: 公開（Public）

**定義**: 一般に公開しても問題のないデータ

**該当するデータ**:
- 公開Webサイトのコンテンツ
- 公開APIドキュメント
- プレスリリース
- 公開リポジトリのソースコード

---

## 分類基準

### 分類フローチャート

```
データを分類する
       │
       ▼
┌─────────────────────────────┐
│ 法的保護の対象か？          │
│ （個人情報、決済情報等）    │
└─────────────┬───────────────┘
              │
      Yes ────┴──── No
       │              │
       ▼              ▼
     [L1]    ┌─────────────────────────┐
             │ 漏洩時に重大な損害？      │
             │ （経済的・信用）          │
             └─────────────┬─────────────┘
                           │
                   Yes ────┴──── No
                    │              │
                    ▼              ▼
                  [L1]    ┌─────────────────────┐
                          │ 社外への開示は不適切？│
                          └─────────────┬───────┘
                                        │
                                Yes ────┴──── No
                                 │              │
                                 ▼              ▼
                               [L2]    ┌───────────────────┐
                                       │ 特定関係者限定？    │
                                       └─────────────┬─────┘
                                                     │
                                             Yes ────┴──── No
                                              │              │
                                              ▼              ▼
                                            [L3]           [L4]
```

### 分類チェックリスト

データを分類する際は以下を確認：

- [ ] 法的規制の対象となるデータか（個人情報保護法、GDPR等）
- [ ] 漏洩時の影響度（法的責任、経済的損失、信用毀損）
- [ ] データの機密性（競合優位性、ビジネス上の重要性）
- [ ] アクセスすべき人の範囲
- [ ] 保持期間と廃棄要件

---

## 保護要件

### レベル別保護要件マトリクス

| 保護措置 | L1 極秘 | L2 社外秘 | L3 関係者限定 | L4 公開 |
|---------|:-------:|:--------:|:------------:|:------:|
| 保存時暗号化 | 必須 | 推奨 | - | - |
| 通信暗号化（TLS） | 必須 | 必須 | 必須 | 推奨 |
| アクセス制御 | 厳格 | 必要 | 必要 | - |
| 監査ログ | 必須 | 必須 | 推奨 | - |
| バックアップ暗号化 | 必須 | 必須 | 推奨 | - |
| 印刷制限 | 禁止 | 承認制 | - | - |
| 外部共有 | 禁止 | 承認制 | 契約必要 | 可 |
| 持ち出し | 禁止 | 承認制 | 承認制 | 可 |

### L1（極秘）の追加要件

- **アクセス**: Need-to-Know 原則（業務上必要な者のみ）
- **認証**: 多要素認証（MFA）必須
- **ログ**: 全アクセスを記録、定期監査
- **保存**: 暗号化必須、鍵管理を厳格化
- **廃棄**: 完全消去（物理破壊 or 暗号化消去）
- **取り扱い**: 画面共有禁止、スクリーンショット禁止

### L2（社外秘）の追加要件

- **アクセス**: 社内ユーザーに限定
- **外部共有**: NDA締結が必要
- **保存**: 社内システム内のみ
- **廃棄**: 論理削除後、定期的に物理削除

---

## 個人情報の取り扱い

### 個人情報の定義

個人情報保護法に基づき、以下を個人情報として扱う：

| カテゴリ | 例 | 分類レベル |
|---------|-----|:----------:|
| 識別情報 | 氏名、住所、電話番号、メールアドレス | L1 |
| 認証情報 | パスワード、セキュリティ質問の回答 | L1 |
| 金融情報 | クレジットカード番号、銀行口座 | L1 |
| 要配慮個人情報 | 健康情報、犯罪歴、信条 | L1 |
| 行動情報 | アクセスログ、購買履歴 | L2 |
| 端末情報 | IPアドレス、Cookie ID | L2-L3 |

### PII 保護要件

```php
// 個人情報を含むカラムの例
$piiColumns = [
    'email',           // L1
    'phone_number',    // L1
    'address',         // L1
    'date_of_birth',   // L1
    'ip_address',      // L2
];

// 保護要件
// 1. 保存時暗号化
// 2. アクセスログの記録
// 3. 最小限のアクセス権限
// 4. 保持期間の設定と自動削除
```

### 同意管理

| 処理目的 | 同意種別 | 撤回可否 |
|---------|---------|:--------:|
| サービス提供 | 契約履行 | - |
| マーケティング | 明示的同意 | 可 |
| 分析・改善 | 正当な利益 | オプトアウト可 |
| 第三者提供 | 明示的同意 | 可 |

---

## データライフサイクル

### ライフサイクル管理

```
┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐
│  作成   │ → │  保存   │ → │  利用   │ → │ アーカイブ│ → │  廃棄   │
└─────────┘   └─────────┘   └─────────┘   └─────────┘   └─────────┘
     ↓             ↓             ↓             ↓             ↓
  分類決定      暗号化        アクセス制御    長期保存      完全消去
  ラベル付け    バックアップ   監査ログ      圧縮・暗号化   証跡記録
```

### 保持期間

| データ種別 | 保持期間 | 根拠 |
|-----------|---------|------|
| アクセスログ | 1年 | 監査要件 |
| 認証ログ | 1年 | セキュリティ監査 |
| 取引データ | 7年 | 税法要件 |
| 個人情報 | 契約終了後3年 | 法的要件 |
| バックアップ | 90日 | 復旧要件 |
| 一時ファイル | 24時間 | - |

### 廃棄手順

| 分類レベル | 廃棄方法 | 確認 |
|-----------|---------|------|
| L1 | 暗号化消去 + 鍵破棄 or 物理破壊 | 廃棄証明書 |
| L2 | 論理削除 → 30日後に物理削除 | ログ記録 |
| L3 | 論理削除 → 定期バッチで物理削除 | - |
| L4 | 通常削除 | - |

---

## アクセス制御

### アクセス権限マトリクス

| ロール | L1 極秘 | L2 社外秘 | L3 関係者限定 | L4 公開 |
|-------|:-------:|:--------:|:------------:|:------:|
| システム管理者 | ✓ | ✓ | ✓ | ✓ |
| セキュリティ担当 | ✓ | ✓ | ✓ | ✓ |
| 開発者（本番） | - | 閲覧のみ | ✓ | ✓ |
| 開発者（開発環境） | - | - | ✓ | ✓ |
| 一般スタッフ | - | ✓ | 担当分のみ | ✓ |
| 外部委託先 | - | NDA必須 | 契約範囲 | ✓ |

### 最小権限の原則

```php
// Policy での実装例
class UserDataPolicy
{
    /**
     * 個人情報へのアクセス可否を判定
     */
    public function viewPII(Staff $staff, User $user): bool
    {
        // L1データへのアクセスは厳格に制限
        return $staff->hasRole('admin')
            || $staff->hasRole('security')
            || ($staff->hasRole('support') && $this->hasActiveTicket($staff, $user));
    }

    /**
     * 個人情報の編集可否を判定
     */
    public function updatePII(Staff $staff, User $user): bool
    {
        // 更新はさらに限定
        return $staff->hasRole('admin')
            && $staff->hasMfaEnabled();
    }
}
```

### アクセス監査

```php
// L1データへのアクセスログ
Log::channel('security')->info('PII accessed', [
    'staff_id' => $staff->id,
    'target_user_id' => $user->id,
    'data_type' => 'email',
    'action' => 'view',
    'ip_address' => request()->ip(),
    'timestamp' => now()->toIso8601String(),
    'justification' => $request->input('reason'),
]);
```

---

## データ転送・共有

### 転送時の暗号化要件

| 転送経路 | L1 極秘 | L2 社外秘 | L3 関係者限定 |
|---------|:-------:|:--------:|:------------:|
| 社内ネットワーク | TLS 1.2+ | TLS 1.2+ | 推奨 |
| インターネット | TLS 1.2+ 必須 | TLS 1.2+ 必須 | TLS 1.2+ |
| メール添付 | 禁止 | 暗号化ZIP（別経路でPW） | 暗号化推奨 |
| ファイル転送サービス | 禁止 | 承認済みサービスのみ | 承認済みサービス |

### 第三者提供の要件

| 分類 | 提供可否 | 必要条件 |
|------|:--------:|---------|
| L1 | 原則禁止 | 法的要求 or 経営承認 + 契約 |
| L2 | 承認制 | NDA + データ処理契約 |
| L3 | 契約必要 | 秘密保持条項 |
| L4 | 可 | - |

### データ処理契約（DPA）の必須項目

- 処理の目的と範囲
- 技術的・組織的安全管理措置
- 再委託の制限
- データ侵害時の通知義務
- 契約終了時のデータ返却・削除
- 監査権

---

## 実装ガイドライン

### データベース設計

```php
// マイグレーション例：機密データの暗号化カラム
Schema::create('users', function (Blueprint $table) {
    $table->ulid('id')->primary();
    $table->string('email');                    // L1: 暗号化推奨
    $table->string('phone_number')->nullable(); // L1: 暗号化必須
    $table->text('address_encrypted');          // L1: 暗号化済み
    $table->string('data_classification')->default('L2');
    $table->timestamps();
    $table->softDeletes();  // 論理削除
});
```

### 暗号化の実装

```php
// config/app.php で暗号化キーを設定
// L1データの暗号化
use Illuminate\Support\Facades\Crypt;

class User extends Model
{
    protected $casts = [
        'phone_number' => 'encrypted',
        'address' => 'encrypted',
    ];

    // または手動で暗号化
    public function setPhoneNumberAttribute($value)
    {
        $this->attributes['phone_number'] = Crypt::encryptString($value);
    }

    public function getPhoneNumberAttribute($value)
    {
        return $value ? Crypt::decryptString($value) : null;
    }
}
```

### ログ出力の制御

```php
// 機密データをログから除外
// config/logging.php
'replace_placeholders' => true,

// app/Http/Middleware/SanitizeLogData.php
class SanitizeLogData
{
    protected $sensitiveFields = [
        'password',
        'password_confirmation',
        'credit_card',
        'phone_number',
        'address',
        'email',  // 必要に応じてマスキング
    ];

    public function handle($request, Closure $next)
    {
        // リクエストログから機密データを除外
        $sanitized = $request->except($this->sensitiveFields);
        Log::info('Request', ['data' => $sanitized]);

        return $next($request);
    }
}
```

### データマスキング

```php
// 表示時のマスキング
class DataMasker
{
    public static function maskEmail(string $email): string
    {
        $parts = explode('@', $email);
        $name = $parts[0];
        $domain = $parts[1] ?? '';

        $maskedName = substr($name, 0, 2) . str_repeat('*', max(0, strlen($name) - 2));
        return $maskedName . '@' . $domain;
        // example@test.com → ex*****@test.com
    }

    public static function maskPhone(string $phone): string
    {
        return substr($phone, 0, 3) . '-****-' . substr($phone, -4);
        // 090-1234-5678 → 090-****-5678
    }
}
```

---

## 監査・コンプライアンス

### 定期監査

| 監査種類 | 頻度 | 対象 |
|---------|------|------|
| アクセス権限レビュー | 四半期 | 全ユーザー |
| L1データアクセス監査 | 月次 | 極秘データへのアクセスログ |
| データ分類レビュー | 年次 | 全データ資産 |
| 保持期間確認 | 月次 | 期限切れデータの削除確認 |

### コンプライアンスチェックリスト

- [ ] 個人情報保護法への準拠
- [ ] 利用目的の明示と同意取得
- [ ] 安全管理措置の実施
- [ ] 第三者提供時の適切な手続き
- [ ] データ主体の権利への対応（開示、訂正、削除）
- [ ] 越境移転の適切な対応

### 違反時の対応

| 違反レベル | 例 | 対応 |
|-----------|-----|------|
| 軽微 | L3データの誤共有 | 注意、再教育 |
| 中度 | L2データの不適切な取り扱い | 警告、アクセス権見直し |
| 重大 | L1データの漏洩 | インシデント対応、懲戒処分検討 |

---

## 関連ドキュメント

- [01_PasswordPolicy.md](./01_PasswordPolicy.md) - パスワードポリシー
- [04_EncryptionPolicy.md](./04_EncryptionPolicy.md) - 暗号化ポリシー
- [02_SecurityDesign.md](../backend/02_SecurityDesign.md) - セキュリティ設計標準
- [04_LoggingDesign.md](../backend/04_LoggingDesign.md) - ログ設計標準

---

## 改訂履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|-----------|------|---------|-------|
| 1.0.0 | 2025-12-26 | 初版作成 | - |
