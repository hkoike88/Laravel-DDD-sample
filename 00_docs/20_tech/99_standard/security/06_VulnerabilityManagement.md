# 脆弱性管理プロセス

## 概要

本ドキュメントは、システムにおける脆弱性の検出、評価、対応、および修正のプロセスを定義する。
継続的な脆弱性管理により、セキュリティリスクを最小限に抑える。

**Last updated:** 2025-12-26

---

## 目次

- [脆弱性管理の基本方針](#脆弱性管理の基本方針)
- [脆弱性の検出](#脆弱性の検出)
- [脆弱性の評価](#脆弱性の評価)
- [対応SLA](#対応sla)
- [修正プロセス](#修正プロセス)
- [脆弱性報告の受付](#脆弱性報告の受付)
- [依存関係の管理](#依存関係の管理)
- [例外処理](#例外処理)
- [報告・メトリクス](#報告メトリクス)

---

## 脆弱性管理の基本方針

### 原則

1. **継続的な検出**: 定期的かつ自動化されたスキャンを実施
2. **リスクベースの優先順位付け**: 重大度と影響度に基づいて対応
3. **迅速な対応**: SLAに従った修正の実施
4. **透明性**: 脆弱性情報の適切な共有と報告
5. **予防的アプローチ**: セキュアな開発プラクティスの推進

### 対象範囲

| カテゴリ | 対象 | 担当 |
|---------|------|------|
| アプリケーション | ソースコード、設定 | 開発チーム |
| 依存関係 | ライブラリ、パッケージ | 開発チーム |
| インフラ | サーバー、ネットワーク機器 | インフラチーム |
| コンテナ | Docker イメージ | DevOps チーム |
| クラウド | クラウドサービス設定 | インフラチーム |

---

## 脆弱性の検出

### 検出方法

| 方法 | ツール | 頻度 | 対象 |
|------|-------|------|------|
| SAST（静的解析） | PHPStan, Larastan, ESLint | CI/CD 毎 | ソースコード |
| DAST（動的解析） | OWASP ZAP | 週次 | 実行中のアプリ |
| 依存関係スキャン | Composer audit, npm audit | CI/CD 毎 | ライブラリ |
| コンテナスキャン | Trivy, Grype | ビルド毎 | Docker イメージ |
| 侵入テスト | 外部ベンダー | 年次 | システム全体 |
| バグバウンティ | 外部報告 | 随時 | 公開システム |

### スキャン実行スケジュール

```
┌────────────────────────────────────────────────────────────────┐
│                    脆弱性スキャンスケジュール                      │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  継続的（CI/CD）                                                │
│  ├── Composer audit（PHP 依存関係）                             │
│  ├── npm audit（JavaScript 依存関係）                           │
│  ├── PHPStan/Larastan（静的解析）                               │
│  └── ESLint security rules                                     │
│                                                                │
│  日次                                                          │
│  └── コンテナイメージスキャン                                     │
│                                                                │
│  週次                                                          │
│  ├── OWASP ZAP（DAST）                                         │
│  └── 脆弱性データベース更新確認                                   │
│                                                                │
│  月次                                                          │
│  └── 設定監査                                                   │
│                                                                │
│  四半期                                                         │
│  └── 内部セキュリティレビュー                                     │
│                                                                │
│  年次                                                          │
│  └── 外部侵入テスト                                              │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### CI/CD パイプラインでの統合

```yaml
# .github/workflows/security-scan.yml
name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * *'  # 毎日 0:00 UTC

jobs:
  backend-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: composer install --no-dev

      - name: Composer Audit
        run: composer audit --format=json > composer-audit.json
        continue-on-error: true

      - name: PHPStan Analysis
        run: ./vendor/bin/phpstan analyse --error-format=json > phpstan.json
        continue-on-error: true

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            composer-audit.json
            phpstan.json

      - name: Check for Critical Vulnerabilities
        run: |
          if grep -q '"severity": "critical"' composer-audit.json; then
            echo "Critical vulnerabilities found!"
            exit 1
          fi

  frontend-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: npm audit
        run: npm audit --json > npm-audit.json
        continue-on-error: true

      - name: Check for Critical Vulnerabilities
        run: |
          if grep -q '"severity": "critical"' npm-audit.json; then
            echo "Critical vulnerabilities found!"
            exit 1
          fi
```

---

## 脆弱性の評価

### CVSS スコアリング

[CVSS（Common Vulnerability Scoring System）](https://www.first.org/cvss/) v3.1 を使用して評価：

| スコア範囲 | 重大度 | 説明 |
|:----------:|:------:|------|
| 9.0 - 10.0 | **Critical** | 即時対応が必要な致命的脆弱性 |
| 7.0 - 8.9 | **High** | 重大な影響のある脆弱性 |
| 4.0 - 6.9 | **Medium** | 中程度の影響のある脆弱性 |
| 0.1 - 3.9 | **Low** | 軽微な影響の脆弱性 |
| 0.0 | **None** | 情報のみ |

### 影響度の評価基準

| 要素 | 考慮事項 |
|------|---------|
| **機密性への影響** | 情報漏洩の可能性、データの機密レベル |
| **完全性への影響** | データ改ざんの可能性 |
| **可用性への影響** | サービス停止の可能性 |
| **攻撃の容易さ** | 悪用に必要な条件、公開エクスプロイトの有無 |
| **影響範囲** | 影響を受けるユーザー/データの範囲 |

### 優先度決定マトリクス

```
              │    影響度
    CVSS      │  低   中   高
    ──────────┼───────────────
    Critical  │  P2   P1   P1
    High      │  P2   P2   P1
    Medium    │  P3   P3   P2
    Low       │  P4   P4   P3
```

---

## 対応SLA

### 優先度別SLA

| 優先度 | 初期対応 | 修正完了 | エスカレーション |
|:------:|:--------:|:--------:|:----------------:|
| **P1** | 4時間以内 | 24時間以内 | CTO/CISO |
| **P2** | 1営業日 | 7日以内 | 技術責任者 |
| **P3** | 3営業日 | 30日以内 | チームリーダー |
| **P4** | 5営業日 | 90日以内 | - |

### 初期対応の内容

1. 脆弱性の確認と検証
2. 影響範囲の特定
3. 一時的な緩和策の検討
4. 修正計画の策定
5. 関係者への通知

### 緩和策の例

| 脆弱性タイプ | 緩和策 |
|-------------|-------|
| SQLインジェクション | WAFルールの追加、入力制限 |
| XSS | CSP の強化、出力エスケープ |
| 認証バイパス | 追加の認証要素、IP制限 |
| DoS | レート制限、キャッシュ強化 |
| 情報漏洩 | アクセス制限、ログの無効化 |

---

## 修正プロセス

### ワークフロー

```
┌─────────────┐
│   検出      │ ← スキャン、報告
└─────┬───────┘
      │
      ▼
┌─────────────┐
│   トリアージ │ ← 重大度評価、優先度決定
└─────┬───────┘
      │
      ▼
┌─────────────┐
│   分析      │ ← 根本原因分析、影響調査
└─────┬───────┘
      │
      ▼
┌─────────────┐
│   修正      │ ← パッチ開発、テスト
└─────┬───────┘
      │
      ▼
┌─────────────┐
│   検証      │ ← 修正の確認、回帰テスト
└─────┬───────┘
      │
      ▼
┌─────────────┐
│  デプロイ   │ ← 本番環境への適用
└─────┬───────┘
      │
      ▼
┌─────────────┐
│   クローズ   │ ← 文書化、報告
└─────────────┘
```

### チケット管理

```markdown
## 脆弱性チケットテンプレート

### 概要
- **タイトル**: [VULN] 脆弱性の簡潔な説明
- **優先度**: P1/P2/P3/P4
- **CVE ID**: CVE-YYYY-XXXXX（該当する場合）
- **CVSS スコア**: X.X
- **発見日**: YYYY-MM-DD
- **SLA期限**: YYYY-MM-DD

### 詳細
- **脆弱性の種類**: SQLi/XSS/CSRF 等
- **影響を受けるコンポーネント**: [ファイルパス、URL等]
- **影響**: [機密性/完全性/可用性への影響]

### 再現手順
1. ...
2. ...

### 修正方針
- [ ] 修正内容の記述
- [ ] テスト項目

### 緩和策（適用済み）
- [実施した一時的な対策]

### 検証
- [ ] 修正後のスキャン完了
- [ ] 回帰テスト完了

### 参考情報
- [参考URL、CVE詳細等]
```

### 修正のガイドライン

```php
// 例: SQLインジェクション脆弱性の修正

// NG: 脆弱なコード
$users = DB::select("SELECT * FROM users WHERE name = '$name'");

// OK: プレースホルダを使用
$users = DB::select("SELECT * FROM users WHERE name = ?", [$name]);

// OK: Eloquent を使用
$users = User::where('name', $name)->get();
```

```php
// 例: XSS脆弱性の修正

// NG: エスケープなし
{!! $userInput !!}

// OK: 自動エスケープ
{{ $userInput }}

// OK: 明示的なエスケープ
{!! e($userInput) !!}
```

---

## 脆弱性報告の受付

### 報告窓口

| チャネル | 用途 | 対応時間 |
|---------|------|---------|
| security@example.com | 外部からの脆弱性報告 | 24時間以内に応答 |
| 内部チケットシステム | 内部発見の脆弱性 | 即時 |

### 報告フォーマット

```markdown
## 脆弱性報告

### 概要
脆弱性の簡潔な説明

### 影響
この脆弱性が悪用された場合の影響

### 再現手順
1. [具体的な手順]
2. ...

### 証拠
- スクリーンショット
- ログ出力
- PoC コード（安全なもの）

### 環境
- URL/バージョン
- ブラウザ/OS

### 推奨される修正方法（任意）
```

### 報告者への対応

| フェーズ | タイムライン | アクション |
|---------|-------------|-----------|
| 受領確認 | 24時間以内 | 報告受領の連絡 |
| トリアージ | 72時間以内 | 有効性の確認、優先度決定 |
| 進捗報告 | 週次 | 修正状況の報告 |
| 修正完了通知 | 修正後 | 修正完了の連絡、謝辞 |

### 責任ある開示

- 報告から修正まで **90日** の猶予期間
- 修正完了後に公開調整
- 報告者への謝辞（希望に応じて）

---

## 依存関係の管理

### 依存関係の監視

```bash
# PHP 依存関係の脆弱性チェック
composer audit

# JavaScript 依存関係の脆弱性チェック
npm audit

# Docker イメージの脆弱性チェック
trivy image app:latest
```

### 更新方針

| 更新種類 | 対応 | タイムライン |
|---------|------|-------------|
| セキュリティパッチ | 即時適用 | SLAに従う |
| マイナーバージョン | 週次レビュー | 次スプリント |
| メジャーバージョン | 計画的更新 | 四半期レビュー |

### 依存関係ロックファイル

```bash
# ロックファイルは必ずコミット
# composer.lock
# package-lock.json

# 再現可能なビルドのため
composer install --no-dev --prefer-dist
npm ci --production
```

### Dependabot 設定例

```yaml
# .github/dependabot.yml
version: 2
updates:
  - package-ecosystem: "composer"
    directory: "/backend"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 10
    labels:
      - "dependencies"
      - "security"

  - package-ecosystem: "npm"
    directory: "/frontend"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 10
    labels:
      - "dependencies"
      - "security"

  - package-ecosystem: "docker"
    directory: "/infrastructure"
    schedule:
      interval: "weekly"
```

---

## 例外処理

### 例外申請が必要なケース

- SLA内での修正が困難な場合
- 修正による影響が大きく追加検証が必要な場合
- サードパーティの修正待ちの場合

### 例外申請プロセス

```markdown
## 脆弱性修正 例外申請

### 申請情報
- **脆弱性ID**: VULN-XXXX
- **申請者**: [名前]
- **申請日**: YYYY-MM-DD

### 例外理由
[SLA内での修正が困難な具体的理由]

### リスク評価
- **現在のリスク**: [説明]
- **緩和策**: [実施済みの対策]
- **残存リスク**: [対策後のリスク]

### 修正計画
- **予定完了日**: YYYY-MM-DD
- **マイルストーン**: [具体的なステップ]

### 承認
- [ ] チームリーダー承認
- [ ] セキュリティ責任者承認（P1/P2の場合）
```

### 例外の有効期限

| 優先度 | 最大延長期間 | 再申請 |
|:------:|:------------:|:------:|
| P1 | 7日 | 必須 |
| P2 | 30日 | 必須 |
| P3 | 90日 | 任意 |
| P4 | 180日 | 任意 |

---

## 報告・メトリクス

### 追跡すべきメトリクス

| メトリクス | 説明 | 目標 |
|-----------|------|------|
| MTTR（平均修復時間） | 検出から修正完了までの時間 | SLA内 |
| 検出率 | 発見された脆弱性の割合 | 向上 |
| 再発率 | 同種の脆弱性の再発 | 5%未満 |
| SLA遵守率 | SLA内に修正された割合 | 95%以上 |
| オープン脆弱性数 | 未修正の脆弱性数 | 減少傾向 |

### 月次報告

```markdown
## 脆弱性管理 月次報告

### 期間: YYYY年MM月

### サマリー
| 指標 | 今月 | 先月 | 変化 |
|------|------|------|------|
| 新規検出 | XX件 | XX件 | +X件 |
| 修正完了 | XX件 | XX件 | +X件 |
| オープン（P1/P2） | X件 | X件 | -X件 |
| オープン（P3/P4） | XX件 | XX件 | -X件 |
| SLA遵守率 | XX% | XX% | +X% |

### 重要な脆弱性
| ID | 重大度 | ステータス | 備考 |
|----|--------|-----------|------|
| VULN-XXX | Critical | 修正済み | ... |

### 傾向分析
[脆弱性の傾向、改善点、課題]

### アクションアイテム
- [ ] [具体的なアクション]
```

### ダッシュボード

以下の情報をリアルタイムで可視化：

- オープン脆弱性の数（優先度別）
- SLAの遵守状況
- 依存関係の脆弱性アラート
- 最近のスキャン結果

---

## 関連ドキュメント

- [08_SecurityScanning.md](./08_SecurityScanning.md) - セキュリティスキャンガイド
- [05_IncidentResponse.md](./05_IncidentResponse.md) - インシデント対応手順
- [02_SecurityDesign.md](../backend/02_SecurityDesign.md) - セキュリティ設計標準

---

## 改訂履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|-----------|------|---------|-------|
| 1.0.0 | 2025-12-26 | 初版作成 | - |
